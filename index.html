<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<meta name="theme-color" content="#050509"/>
<title>LOGBOOK V2</title>
<style>
:root{--bg:#050509;--panel:#0a0a12;--card:#0d0d14;--card2:#10101a;--red:#ff1a1a;--red2:#b30000;--text:#f5f5f7;--muted:#9a9aa3;--line:rgba(255,255,255,.08);--line2:rgba(255,255,255,.06);--shadow:0 12px 30px rgba(0,0,0,.45);--r:18px;--r2:14px;--safe-b:env(safe-area-inset-bottom,0px);--safe-t:env(safe-area-inset-top,0px)}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif;background:
radial-gradient(1200px 800px at 50% -20%,rgba(255,26,26,.10),transparent 55%),
radial-gradient(900px 600px at 100% 0%,rgba(255,26,26,.06),transparent 55%),
var(--bg);color:var(--text);overflow-x:hidden}
header{position:sticky;top:0;z-index:50;padding:calc(14px + var(--safe-t)) 16px 14px;background:linear-gradient(180deg,rgba(10,10,18,.96),rgba(10,10,18,.72));border-bottom:1px solid var(--line);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}
.topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;max-width:980px;margin:0 auto}
.brand{display:flex;align-items:center;gap:10px;min-width:0}
.logo{width:34px;height:34px;border-radius:12px;background:
radial-gradient(18px 18px at 30% 35%,rgba(255,255,255,.18),transparent 65%),
radial-gradient(60px 60px at 65% 70%,rgba(255,26,26,.40),rgba(179,0,0,.20) 55%,rgba(10,10,18,1) 100%);
border:1px solid rgba(255,26,26,.35);box-shadow:0 10px 25px rgba(255,26,26,.12);flex:0 0 auto}
.brand h1{margin:0;font-size:15px;letter-spacing:.6px;font-weight:950;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.brand h1 b{color:var(--red)}
.pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(13,13,20,.7);box-shadow:0 10px 20px rgba(0,0,0,.25);font-size:12px;color:var(--muted)}
.dot{width:8px;height:8px;border-radius:999px;background:var(--red);box-shadow:0 0 0 4px rgba(255,26,26,.10)}
main{max-width:980px;margin:0 auto;padding:16px;padding-bottom:calc(96px + var(--safe-b))}
.screen{display:none}
.screen.active{display:block}
.card{background:linear-gradient(180deg,rgba(13,13,20,.92),rgba(13,13,20,.78));border:1px solid var(--line2);border-radius:var(--r);box-shadow:var(--shadow);padding:16px;margin-bottom:14px}
h2,h3{margin:0 0 10px 0;font-size:14px;letter-spacing:.3px}
small{color:var(--muted)}
.row{display:flex;gap:12px;flex-wrap:wrap}
.kpi-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:10px}
.kpi{padding:12px;border-radius:16px;border:1px solid var(--line2);background:linear-gradient(180deg,rgba(16,16,26,.85),rgba(10,10,18,.65));box-shadow:0 12px 22px rgba(0,0,0,.25);min-height:74px}
.kpi .label{font-size:11px;color:var(--muted);letter-spacing:.3px;margin-bottom:6px}
.kpi .value{font-size:18px;font-weight:950;letter-spacing:.2px;line-height:1.2}
.kpi .sub{margin-top:6px;font-size:11px;color:rgba(255,255,255,.55)}
.chart-wrap{border:1px solid var(--line2);border-radius:16px;background:rgba(10,10,18,.55);overflow:hidden;padding:10px}
canvas{width:100%;height:200px;display:block;border-radius:12px;background:
radial-gradient(800px 220px at 20% 0%,rgba(255,26,26,.10),transparent 55%),
rgba(10,10,18,.55)}
.nav{position:fixed;left:0;right:0;bottom:0;z-index:60;padding:10px 10px calc(10px + var(--safe-b));background:linear-gradient(180deg,rgba(10,10,18,.20),rgba(10,10,18,.92));border-top:1px solid var(--line);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px)}
.nav-inner{max-width:980px;margin:0 auto;display:flex;gap:10px}
.tab{flex:1;border-radius:16px;padding:10px 8px;border:1px solid var(--line2);background:rgba(13,13,20,.70);color:var(--muted);font-weight:900;font-size:12px;letter-spacing:.2px;cursor:pointer;transition:transform .12s ease,background .12s ease,border-color .12s ease,color .12s ease;box-shadow:0 12px 20px rgba(0,0,0,.22)}
.tab:active{transform:scale(.98)}
.tab.active{color:#000;background:linear-gradient(180deg,rgba(255,26,26,1),rgba(179,0,0,1));border-color:rgba(255,26,26,.55);box-shadow:0 16px 26px rgba(255,26,26,.12)}
.btn{border:none;border-radius:14px;padding:10px 14px;font-weight:950;cursor:pointer;transition:transform .12s ease,background .12s ease}
.btn:active{transform:scale(.98)}
.btn-primary{background:var(--red);color:#000}
.btn-primary:hover{background:var(--red2)}
.btn-ghost{background:transparent;color:var(--red);border:1px solid rgba(255,26,26,.35)}
.field{width:100%;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(10,10,18,.70);color:var(--text);outline:none;transition:border-color .12s ease,box-shadow .12s ease}
.field:focus{border-color:rgba(255,26,26,.45);box-shadow:0 0 0 4px rgba(255,26,26,.10)}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(84px + var(--safe-b));z-index:80;display:none;max-width:min(520px,calc(100% - 22px));padding:10px 14px;border-radius:14px;background:rgba(255,26,26,.98);color:#000;font-weight:950;box-shadow:0 18px 40px rgba(0,0,0,.45)}
.set-row{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:8px;align-items:center;margin-top:8px}
.empty{padding:14px;border-radius:16px;border:1px dashed rgba(255,255,255,.14);background:rgba(10,10,18,.40);color:rgba(255,255,255,.75);font-size:13px;line-height:1.35}
.progress{height:8px;background:#111;border-radius:999px;overflow:hidden}
.progress>div{height:100%;background:var(--red)}
hr.sep{border:none;border-top:1px solid rgba(255,255,255,.06);margin:12px 0}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line2);background:rgba(10,10,18,.55);font-size:12px;color:rgba(255,255,255,.75)}
.up{color:#5dff88}.down{color:#ff6666}.eq{color:#cccccc}
@media(min-width:720px){.kpi-grid{grid-template-columns:repeat(4,minmax(0,1fr))}canvas{height:240px}.tab{font-size:13px;padding:12px 10px}header{padding:calc(16px + var(--safe-t)) 16px 16px}}
</style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="brand"><div class="logo" aria-hidden="true"></div><h1><b>LOGBOOK</b> V2</h1></div>
    <div class="pill"><span class="dot"></span><span>Offline</span></div>
  </div>
</header>

<main id="app">
  <!-- DASHBOARD -->
  <section id="screen-dashboard" class="screen active" aria-label="Dashboard">
    <div class="card">
      <h2>KPIs</h2>
      <div class="kpi-grid">
        <div class="kpi"><div class="label">Sessões salvas</div><div class="value" id="kpiTotalSessions">0</div><div class="sub" id="kpiTotalSessionsSub">—</div></div>
        <div class="kpi"><div class="label">Sessões na semana</div><div class="value" id="kpiWeekSessions">0</div><div class="sub" id="kpiWeekSessionsSub">—</div></div>
        <div class="kpi"><div class="label">Volume na semana</div><div class="value" id="kpiWeekVolume">0</div><div class="sub" id="kpiWeekVolumeSub">kg·reps</div></div>
        <div class="kpi"><div class="label">Aderência hoje</div><div class="value" id="kpiDietAdherence">—</div><div class="sub" id="kpiDietAdherenceSub">kcal / P</div></div>
      </div>
    </div>

    <div class="card">
      <h2>PRs semanais (vs semana anterior)</h2>
      <small>PR por exercício: <b>maior kg</b>, <b>maior reps</b> e <b>melhor RIR (menor)</b> na semana.</small>
      <div style="margin-top:12px" class="badge" id="weekBadge">—</div>
      <div id="weeklyPRs" style="margin-top:12px"></div>
    </div>

    <div class="card">
      <h2>Volume (últimas sessões)</h2>
      <small>Canvas offline, sem bibliotecas.</small>
      <div class="chart-wrap" style="margin-top:12px;"><canvas id="volumeChart" width="400" height="200"></canvas></div>
    </div>
  </section>

  <!-- LOGBOOK -->
  <section id="screen-logbook" class="screen" aria-label="Logbook">
    <div class="card">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;">
        <div style="min-width:0;">
          <h2>Treino de hoje</h2>
          <small id="todayLabel">—</small>
          <div style="margin-top:8px" class="badge" id="hevyHint">—</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn btn-ghost" id="btnAddExercise" type="button">+ Exercício</button>
          <button class="btn btn-primary" id="btnSaveSession" type="button">Salvar sessão</button>
        </div>
      </div>
      <div id="todayExercises" style="margin-top:14px;">
        <div class="empty">Salve sua rotina na aba <b>Rotina</b> para carregar automaticamente o treino do dia.</div>
      </div>
      <textarea id="sessionNotes" class="field" rows="3" style="margin-top:12px;" placeholder="Observações do treino (opcional)"></textarea>
    </div>
  </section>

  <!-- ROTINA -->
  <section id="screen-rotina" class="screen" aria-label="Rotina">
    <div class="card">
      <h2>Rotina</h2>
      <small>Cole sua rotina por dias. Ex: “Supino reto 2x5-9, 1x8-10”.</small>
      <textarea id="routineTextarea" class="field" rows="12" style="margin-top:12px;" placeholder="Segunda
Supino reto 2x5-9, 1x8-10
Agachamento 3x6-8

Terça
Remada 3x8-12"></textarea>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
        <button class="btn btn-primary" id="btnSaveRoutine" type="button">Salvar rotina</button>
        <button class="btn btn-ghost" id="btnClearRoutine" type="button">Limpar</button>
      </div>
      <pre id="routinePreview" style="margin-top:12px;white-space:pre-wrap;background:rgba(10,10,18,.55);border:1px solid rgba(255,255,255,.06);padding:12px;border-radius:14px;max-height:260px;overflow:auto;"></pre>
    </div>
  </section>

  <!-- DIETA -->
  <section id="screen-dieta" class="screen" aria-label="Dieta">
    <div class="card">
      <h2>Dieta</h2>
      <small>Manual (kcal/P/C/F) por refeição + metas do dia + total.</small>
      <div class="row" style="margin-top:12px;">
        <div style="flex:1;min-width:180px;">
          <small>Data</small>
          <input id="dietDate" class="field" type="date">
        </div>
        <div style="flex:1;min-width:180px;">
          <small>Refeição</small>
          <select id="dietMeal" class="field">
            <option value="cafe">Café</option><option value="almoco">Almoço</option><option value="lanche">Lanche</option><option value="jantar">Jantar</option><option value="ceia">Ceia</option>
          </select>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h3>Metas do dia</h3>
        <div class="row">
          <input id="tKcal" class="field" type="number" placeholder="kcal" style="flex:1;min-width:130px;">
          <input id="tP" class="field" type="number" placeholder="P (g)" style="flex:1;min-width:130px;">
          <input id="tC" class="field" type="number" placeholder="C (g)" style="flex:1;min-width:130px;">
          <input id="tF" class="field" type="number" placeholder="F (g)" style="flex:1;min-width:130px;">
        </div>
        <button class="btn btn-primary" id="btnSaveTargets" type="button" style="margin-top:10px;">Salvar metas</button>
        <div id="dietProgress" style="margin-top:12px;"></div>
      </div>

      <div class="card">
        <h3>Adicionar item</h3>
        <input id="foodName" class="field" placeholder="Nome (ex: arroz, frango...)">
        <div class="row">
          <input id="fKcal" class="field" type="number" placeholder="kcal (opcional)" style="flex:1;min-width:120px;">
          <input id="fP" class="field" type="number" placeholder="P" style="flex:1;min-width:120px;">
          <input id="fC" class="field" type="number" placeholder="C" style="flex:1;min-width:120px;">
          <input id="fF" class="field" type="number" placeholder="F" style="flex:1;min-width:120px;">
        </div>
        <button class="btn btn-primary" id="btnAddFood" type="button" style="margin-top:10px;">Adicionar</button>
      </div>

      <div class="card">
        <h3>Total do dia</h3>
        <div id="dietTotals"></div>
      </div>

      <div class="card">
        <h3>Refeições</h3>
        <div id="dietMealsList"></div>
      </div>
    </div>
  </section>

  <!-- TDEE -->
  <section id="screen-tdee" class="screen" aria-label="TDEE">
    <div class="card">
      <h2>TDEE (Mifflin-St Jeor)</h2>
      <small>Calcula BMR/TDEE e gera metas (P/F por kg + carbo restante). Aplique nas metas da Dieta para a data selecionada.</small>

      <div class="row" style="margin-top:12px;">
        <div style="flex:1;min-width:160px;">
          <small>Sexo</small>
          <select id="tdeeSex" class="field">
            <option value="male">Masculino</option>
            <option value="female">Feminino</option>
          </select>
        </div>
        <div style="flex:1;min-width:160px;">
          <small>Atividade</small>
          <select id="tdeeActivity" class="field">
            <option value="1.2">1.2 (Sedentário)</option>
            <option value="1.375">1.375 (Leve)</option>
            <option value="1.55">1.55 (Moderado)</option>
            <option value="1.725">1.725 (Alto)</option>
            <option value="1.9">1.9 (Muito alto)</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div style="flex:1;min-width:160px;"><small>Idade</small><input id="tdeeAge" class="field" type="number" placeholder="anos"></div>
        <div style="flex:1;min-width:160px;"><small>Altura</small><input id="tdeeHeight" class="field" type="number" placeholder="cm"></div>
        <div style="flex:1;min-width:160px;"><small>Peso</small><input id="tdeeWeight" class="field" type="number" step="0.1" placeholder="kg"></div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
        <button class="btn btn-primary" id="btnCalcTdee" type="button">Calcular</button>
        <button class="btn btn-ghost" id="btnUseDietDate" type="button">Usar data da Dieta</button>
      </div>

      <div id="tdeeResult" style="margin-top:12px;"></div>

      <hr class="sep">

      <h3>Metas (ajuste fino)</h3>

      <div class="row" style="margin-top:10px;">
        <div style="flex:1;min-width:180px;">
          <small>Modo</small>
          <select id="tdeeMode" class="field">
            <option value="maintain">Manutenção</option>
            <option value="cut">Cut (−300)</option>
            <option value="bulk">Bulk (+200)</option>
          </select>
        </div>
        <div style="flex:1;min-width:180px;">
          <small>Calorias alvo (editável)</small>
          <input id="tdeeCalTarget" class="field" type="number" step="25" placeholder="kcal">
        </div>
      </div>

      <div style="margin-top:10px;">
        <small>Proteína: <b id="pKgLabel" style="color:var(--red)">2.00</b> g/kg</small>
        <input id="pKg" class="field" style="padding:0;height:42px" type="range" min="1.8" max="2.2" step="0.05" value="2.0">
      </div>

      <div style="margin-top:10px;">
        <small>Gordura: <b id="fKgLabel" style="color:var(--red)">0.80</b> g/kg</small>
        <input id="fKg" class="field" style="padding:0;height:42px" type="range" min="0.6" max="1.0" step="0.05" value="0.8">
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
        <button class="btn btn-primary" id="btnGenTargets" type="button">Gerar metas</button>
        <button class="btn btn-primary" id="btnApplyToDiet" type="button">Aplicar na Dieta</button>
      </div>

      <div id="tdeeTargetsOut" style="margin-top:12px;"></div>
    </div>

    <div class="card">
      <h2>Backup JSON</h2>
      <small>Exportar/importar mantém tudo (rotina, sessões, dieta, tdee, etc.).</small>
      <div class="row" style="margin-top:12px;">
        <button class="btn btn-ghost" id="btnExportJSON" type="button">Exportar</button>
        <button class="btn btn-ghost" id="btnImportJSON" type="button">Importar</button>
      </div>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <textarea id="rawState" class="field" spellcheck="false" wrap="off" rows="10" style="margin-top:12px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;line-height:1.35" placeholder="Estado JSON..."></textarea>
    </div>
  </section>
</main>

<nav class="nav" aria-label="Navegação">
  <div class="nav-inner">
    <button class="tab active" id="tab-dashboard" type="button" data-target="dashboard">Dashboard</button>
    <button class="tab" id="tab-logbook" type="button" data-target="logbook">Logbook</button>
    <button class="tab" id="tab-rotina" type="button" data-target="rotina">Rotina</button>
    <button class="tab" id="tab-dieta" type="button" data-target="dieta">Dieta</button>
    <button class="tab" id="tab-tdee" type="button" data-target="tdee">TDEE</button>
  </div>
</nav>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
(()=>{"use strict";
/* ===== State ===== */
const STORAGE_KEY="LOGBOOK_V2",OLD_KEY="LOGBOOK_V2_PLACEHOLDER";
const WEEK_KEYS=["Domingo","Segunda","Terça","Quarta","Quinta","Sexta","Sábado"];
const MEAL_KEYS=["cafe","almoco","lanche","jantar","ceia"];
const MEAL_LABEL={cafe:"Café",almoco:"Almoço",lanche:"Lanche",jantar:"Jantar",ceia:"Ceia"};
let toastTimer=null;

let state={version:2,routineText:"",routineParsed:{},sessions:[],days:{},tdee:{},measures:[],photos:[],gems:[]};

const $=id=>document.getElementById(id);
const qsa=(sel,root=document)=>Array.from(root.querySelectorAll(sel));
const qs=(sel,root=document)=>root.querySelector(sel);

function escapeHtml(str){return (str||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m]))}
function showToast(msg){const el=$("toast");if(!el)return;el.textContent=msg;el.style.display="block";clearTimeout(toastTimer);toastTimer=setTimeout(()=>{el.style.display="none"},2200)}
function deepClone(o){try{return JSON.parse(JSON.stringify(o))}catch{return {}}}
function migrateState(old){
const base=deepClone({version:2,routineText:"",routineParsed:{},sessions:[],days:{},tdee:{},measures:[],photos:[],gems:[]});
if(!old||typeof old!=="object")return base;
const m=deepClone(base);
m.routineText=typeof old.routineText==="string"?old.routineText:typeof old.routine==="string"?old.routine:typeof old.routineRaw==="string"?old.routineRaw:m.routineText;
m.routineParsed=(old.routineParsed&&typeof old.routineParsed==="object")?old.routineParsed:(old.routineJSON&&typeof old.routineJSON==="object")?old.routineJSON:m.routineParsed;
m.sessions=Array.isArray(old.sessions)?old.sessions:Array.isArray(old.logbook)?old.logbook:m.sessions;
m.days=(old.days&&typeof old.days==="object")?old.days:(old.dietDays&&typeof old.dietDays==="object")?old.dietDays:(old.nutritionDays&&typeof old.nutritionDays==="object")?old.nutritionDays:(old.dietTargets&&typeof old.dietTargets==="object")?old.dietTargets:m.days;
m.tdee=(old.tdee&&typeof old.tdee==="object")?old.tdee:m.tdee;
m.measures=Array.isArray(old.measures)?old.measures:m.measures;
m.photos=Array.isArray(old.photos)?old.photos:m.photos;
m.gems=Array.isArray(old.gems)?old.gems:m.gems;
if(typeof m.routineText!=="string")m.routineText="";
if(!m.routineParsed||typeof m.routineParsed!=="object")m.routineParsed={};
if(!Array.isArray(m.sessions))m.sessions=[];
if(!m.days||typeof m.days!=="object")m.days={};
if(!m.tdee||typeof m.tdee!=="object")m.tdee={};
m.version=2;return m;
}
function saveState(){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(state))}catch{showToast("Erro ao salvar (storage cheio?)")}}
function loadState(){
try{
const cur=localStorage.getItem(STORAGE_KEY);
if(cur){state=migrateState(JSON.parse(cur));saveState();return}
const old=localStorage.getItem(OLD_KEY);
if(old){state=migrateState(JSON.parse(old));saveState();showToast("Dados migrados para LOGBOOK_V2");return}
state=migrateState(null);saveState();
}catch{state=migrateState(null);saveState();showToast("Estado resetado por erro")}
}

/* ===== Dates / Weeks ===== */
function isoDay(d=new Date()){return new Date(d).toISOString().slice(0,10)}
function todayWeekKey(){return WEEK_KEYS[new Date().getDay()]}
function unaccent(s){return (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"")}
function isoWeekKey(date){
const d=new Date(date);
const t=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));
const dayNum=t.getUTCDay()||7;
t.setUTCDate(t.getUTCDate()+4-dayNum);
const yearStart=new Date(Date.UTC(t.getUTCFullYear(),0,1));
const weekNo=Math.ceil((((t-yearStart)/86400000)+1)/7);
const ww=String(weekNo).padStart(2,"0");
return `${t.getUTCFullYear()}-W${ww}`;
}
function prevWeekKeyFrom(date){
const d=new Date(date);
d.setDate(d.getDate()-7);
return isoWeekKey(d);
}

/* ===== Routine Parser ===== */
function parseRoutineV2(text){
const lines=(text||"").split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
const days=[
{key:"Segunda",re:/^segunda\b/i},
{key:"Terça",re:/^(terça|terca)\b/i},
{key:"Quarta",re:/^quarta\b/i},
{key:"Quinta",re:/^quinta\b/i},
{key:"Sexta",re:/^sexta\b/i},
{key:"Sábado",re:/^(sábado|sabado)\b/i},
{key:"Domingo",re:/^domingo\b/i},
];
const out={};let cur=null;
for(const raw of lines){
const d=days.find(x=>x.re.test(raw));
if(d){cur=d.key;if(!out[cur])out[cur]=[];continue}
if(!cur)continue;
const blockRe=/(\d+)\s*x\s*(\d+)\s*-\s*(\d+)/ig;
const first=blockRe.exec(raw);if(!first)continue;
const name=raw.slice(0,first.index).trim().replace(/\s+/g," ");
if(!name)continue;
const blocks=[];blockRe.lastIndex=0;let m;
while((m=blockRe.exec(raw))!==null){
const nSets=parseInt(m[1],10),repMin=parseInt(m[2],10),repMax=parseInt(m[3],10);
if(nSets>0&&repMin>0&&repMax>=repMin)blocks.push({nSets,repMin,repMax});
}
if(!blocks.length)continue;
out[cur].push({name,blocks});
}
return out;
}

/* ===== Navigation ===== */
function nav(target){
const tid=String(target||"").trim();
qsa(".screen").forEach(s=>s.classList.remove("active"));
const screen=$("screen-"+tid);if(screen)screen.classList.add("active");
qsa(".tab").forEach(t=>t.classList.remove("active"));
const tab=$("tab-"+tid);if(tab)tab.classList.add("active");
if(tid==="dashboard"){updateDashboard();drawChart(state.sessions)}
else if(tid==="logbook"){renderLogbook()}
else if(tid==="rotina"){renderRoutine()}
else if(tid==="dieta"){renderDiet()}
else if(tid==="tdee"){renderTdee();renderBackupBox()}
}

/* ===== Dashboard ===== */
function sessionVolume(session){
let v=0;if(!session||!session.exercises)return 0;
session.exercises.forEach(ex=>(ex.sets||[]).forEach(s=>{const kg=+s.kg,reps=+s.reps;if(kg>0&&reps>0)v+=kg*reps}));
return Math.round(v);
}
function dietTotals(dayObj){
const t={kcal:0,p:0,c:0,f:0};
MEAL_KEYS.forEach(mk=>(dayObj.meals[mk]||[]).forEach(it=>{t.kcal+=(+it.kcal||0);t.p+=(+it.p||0);t.c+=(+it.c||0);t.f+=(+it.f||0)}));
t.kcal=Math.round(t.kcal);t.p=+t.p.toFixed(1);t.c=+t.c.toFixed(1);t.f=+t.f.toFixed(1);return t;
}
function computeWeeklyPRs(weekKey){
const prs={}; // name -> {kg,reps,rir}
for(const s of state.sessions){
if(isoWeekKey(s.date)!==weekKey)continue;
for(const ex of (s.exercises||[])){
const name=(ex.name||"").trim();
if(!name)continue;
if(!prs[name]) prs[name]={kg:0,reps:0,rir:null};
for(const set of (ex.sets||[])){
const kg=+set.kg||0, reps=+set.reps||0;
const rir=(set.rir===null||set.rir===undefined||set.rir==="")?null:+set.rir;
if(kg>prs[name].kg) prs[name].kg=kg;
if(reps>prs[name].reps) prs[name].reps=reps;
if(rir!==null && Number.isFinite(rir)){
if(prs[name].rir===null) prs[name].rir=rir;
else prs[name].rir=Math.min(prs[name].rir,rir); // "melhor" = menor RIR (mais difícil)
}
}
}
}
return prs;
}
function deltaClass(cur,prev,isLowerBetter=false){
if(prev===null||prev===undefined||prev==="") return "eq";
if(cur===null||cur===undefined||cur==="") return "eq";
if(isLowerBetter){
if(cur<prev) return "up";
if(cur>prev) return "down";
return "eq";
}
if(cur>prev) return "up";
if(cur<prev) return "down";
return "eq";
}
function fmtRir(v){return (v===null||v===undefined||v==="")?"—":String(v)}
function renderWeeklyPRs(){
const now=new Date();
const wk=isoWeekKey(now);
const prev=prevWeekKeyFrom(now);
$("weekBadge").textContent=`Semana atual: ${wk} • anterior: ${prev}`;
const curPR=computeWeeklyPRs(wk);
const prevPR=computeWeeklyPRs(prev);

const names=Object.keys(curPR).sort((a,b)=>a.localeCompare(b,"pt-BR"));
if(!names.length){
$("weeklyPRs").innerHTML=`<div class="empty">Sem PRs nesta semana ainda. Salve sessões no Logbook.</div>`;
return;
}
let html=`<div class="grid2">`;
for(const name of names){
const c=curPR[name], p=prevPR[name]||{kg:0,reps:0,rir:null};
const kgCls=deltaClass(c.kg,p.kg,false);
const rCls=deltaClass(c.reps,p.reps,false);
const rirCls=deltaClass(c.rir,p.rir,true);
html+=`
<div class="card" style="margin:0">
  <div style="font-weight:950;letter-spacing:.2px">${escapeHtml(name)}</div>
  <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
    <span class="badge"><span class="${kgCls}">kg</span> <b>${c.kg||0}</b> <small style="opacity:.7">(${p.kg||0})</small></span>
    <span class="badge"><span class="${rCls}">reps</span> <b>${c.reps||0}</b> <small style="opacity:.7">(${p.reps||0})</small></span>
    <span class="badge"><span class="${rirCls}">RIR</span> <b>${fmtRir(c.rir)}</b> <small style="opacity:.7">(${fmtRir(p.rir)})</small></span>
  </div>
  <small style="display:block;margin-top:10px">Parênteses = semana anterior</small>
</div>`;
}
html+=`</div>`;
$("weeklyPRs").innerHTML=html;
}
function updateDashboard(){
const total=state.sessions.length;
const nowW=isoWeekKey(new Date());
let weekSessions=0,weekVolume=0;
for(const s of state.sessions){
if(isoWeekKey(s.date)===nowW){weekSessions++;weekVolume+=sessionVolume(s)}
}
$("kpiTotalSessions").textContent=String(total);
$("kpiWeekSessions").textContent=String(weekSessions);
$("kpiWeekVolume").textContent=String(Math.round(weekVolume));
$("kpiTotalSessionsSub").textContent=total?new Date(state.sessions[total-1].date).toLocaleDateString("pt-BR"):"—";
$("kpiWeekSessionsSub").textContent=`Semana ${nowW}`;

const today=isoDay(new Date());
let adhText="—",adhSub="kcal / P";
if(state.days&&state.days[today]){
const d=ensureDietDay(today);
const totals=dietTotals(d);
const tgt=d.targets||{kcal:0,p:0,c:0,f:0};
const kcalPct=tgt.kcal>0?Math.round((totals.kcal/tgt.kcal)*100):null;
const pPct=tgt.p>0?Math.round((totals.p/tgt.p)*100):null;
if(kcalPct!==null||pPct!==null){
adhText=`${kcalPct!==null?Math.min(999,kcalPct):"—"}%`;
adhSub=`kcal ${kcalPct!==null?Math.min(999,kcalPct):"—"}% • P ${pPct!==null?Math.min(999,pPct):"—"}%`;
}else if(totals.kcal>0){adhText=`${totals.kcal} kcal`;adhSub="sem meta";}
}
$("kpiDietAdherence").textContent=adhText;
$("kpiDietAdherenceSub").textContent=adhSub;

renderWeeklyPRs();
}
function drawChart(sessions){
const canvas=$("volumeChart");if(!canvas)return;
const ctx=canvas.getContext("2d");
const cssW=canvas.clientWidth||400,cssH=canvas.clientHeight||200;
const dpr=window.devicePixelRatio||1;
canvas.width=Math.round(cssW*dpr);canvas.height=Math.round(cssH*dpr);
ctx.setTransform(dpr,0,0,dpr,0,0);
ctx.clearRect(0,0,cssW,cssH);
const last=(sessions||[]).slice(-7);
const vols=last.map(s=>sessionVolume(s));
const max=Math.max(...vols,1);
const padL=10,padR=10,padT=12,padB=26;
const innerW=cssW-padL-padR,innerH=cssH-padT-padB;
ctx.globalAlpha=.16;ctx.fillStyle="#fff";
for(let i=0;i<=3;i++){const y=padT+(innerH/3)*i;ctx.fillRect(padL,y,innerW,1)}
ctx.globalAlpha=1;
const n=Math.max(vols.length,1),gap=10,barW=Math.max(14,Math.floor((innerW-gap*(n-1))/n));
vols.forEach((v,i)=>{const x=padL+i*(barW+gap);const h=Math.round((v/max)*innerH);const y=padT+(innerH-h);
ctx.fillStyle="#ff1a1a";ctx.fillRect(x,y,barW,h);
ctx.fillStyle="rgba(255,255,255,.60)";ctx.font="11px -apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif";
ctx.fillText(String(v),x,cssH-10);
});
}

/* ===== Hevy Mode Prefill (previous week) ===== */
function totalSetsFromBlocks(blocks){
return Array.isArray(blocks)?blocks.reduce((a,b)=>a+((b&&b.nSets)||0),0):0;
}
function findPrevWeekTemplateForExercise(exName,weekdayKey){
const now=new Date();
const prevW=prevWeekKeyFrom(now);
let best=null;
for(const s of state.sessions){
if(isoWeekKey(s.date)!==prevW) continue;
if((s.weekdayKey||s.weekday||"")!==weekdayKey) continue;
const ex=(s.exercises||[]).find(e=>((e.name||"").trim().toLowerCase()===exName.trim().toLowerCase()));
if(!ex) continue;
if(!best || new Date(s.date)>new Date(best.sessionDate)){
best={sessionDate:s.date,ex};
}
}
return best?best.ex:null;
}
function findFallbackLastExercise(exName){
let best=null;
for(const s of state.sessions){
const ex=(s.exercises||[]).find(e=>((e.name||"").trim().toLowerCase()===exName.trim().toLowerCase()));
if(!ex) continue;
if(!best || new Date(s.date)>new Date(best.sessionDate)){
best={sessionDate:s.date,ex};
}
}
return best?best.ex:null;
}

/* ===== Logbook ===== */
function buildSetRow(pref){
const row=document.createElement("div");row.className="set-row";
row.innerHTML=`<input class="field" type="number" step="0.5" placeholder="kg" style="margin:0">
<input class="field" type="number" step="1" placeholder="reps" style="margin:0">
<input class="field" type="number" step="1" placeholder="RIR" style="margin:0">
<button class="btn btn-ghost" type="button" style="padding:10px 12px">X</button>`;
row.querySelector("button").addEventListener("click",()=>row.remove());
if(pref){
const ins=row.querySelectorAll("input");
if(pref.kg) ins[0].value=pref.kg;
if(pref.reps) ins[1].value=pref.reps;
if(pref.rir!==null && pref.rir!==undefined && pref.rir!=="") ins[2].value=pref.rir;
}
return row;
}
function buildExerciseCard(name,blocks,templateEx){
const wrap=document.createElement("div");wrap.className="card";wrap.dataset.exercise="1";
wrap.innerHTML=`<div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;">
<div><div class="ex-name" style="font-weight:950;letter-spacing:.2px;">${escapeHtml(name)}</div><small>RIR por set • Pré-preenchido da semana anterior (editável).</small></div>
<div style="display:flex;gap:8px;flex-wrap:wrap;">
<button class="btn btn-ghost" type="button" data-act="addset">+ Set</button>
<button class="btn btn-ghost" type="button" data-act="rmex">Remover</button>
</div></div>
<div class="sets-host" style="margin-top:12px;"></div>`;
const setsHost=wrap.querySelector(".sets-host");
const n=totalSetsFromBlocks(blocks)||3;
for(let i=0;i<n;i++){
const pref=templateEx && Array.isArray(templateEx.sets) ? templateEx.sets[i] : null;
setsHost.appendChild(buildSetRow(pref));
}
wrap.querySelector('[data-act="addset"]').addEventListener("click",()=>setsHost.appendChild(buildSetRow(null)));
wrap.querySelector('[data-act="rmex"]').addEventListener("click",()=>{wrap.remove();showToast("Exercício removido (salve para gravar).")});
return wrap;
}
function renderLogbook(){
const wk=todayWeekKey();
$("todayLabel").textContent=`${wk} • ${isoDay(new Date())}`;
const host=$("todayExercises");host.innerHTML="";
const rp=state.routineParsed||{};
const exs=rp[wk]||rp[unaccent(wk)]||[];

const prevW=prevWeekKeyFrom(new Date());
$("hevyHint").textContent=`Hevy mode: pré-preencher da semana anterior (${prevW})`;

if(!exs.length){host.innerHTML=`<div class="empty">Nenhuma rotina para <b>${wk}</b>. Vá em <b>Rotina</b> e salve.</div>`;return}

let anyPrefilled=false;
exs.forEach(ex=>{
const templ=findPrevWeekTemplateForExercise(ex.name,wk) || findPrevWeekTemplateForExercise(ex.name,unaccent(wk));
if(templ) anyPrefilled=true;
host.appendChild(buildExerciseCard(ex.name,ex.blocks,templ));
});
if(!anyPrefilled && state.sessions.length){
$("hevyHint").textContent=`Hevy mode: sem sessão da semana anterior • usando sets em branco`;
}
}
function saveSession(){
const wk=todayWeekKey();
const cards=qsa("#todayExercises .card").filter(c=>c.dataset.exercise==="1");
if(!cards.length){showToast("Nenhum exercício para salvar.");return}
const exercises=[];
for(const card of cards){
const nameEl=card.querySelector(".ex-name");const name=nameEl?nameEl.textContent.trim():"Exercício";
const sets=[];
qsa(".set-row",card).forEach(row=>{
const ins=qsa("input",row);
const kg=parseFloat(ins[0]?.value||"");
const reps=parseInt(ins[1]?.value||"",10);
const rir=parseInt(ins[2]?.value||"",10);
sets.push({kg:Number.isFinite(kg)?kg:0,reps:Number.isFinite(reps)?reps:0,rir:Number.isFinite(rir)?rir:null});
});
exercises.push({name,sets});
}
const notes=($("sessionNotes").value||"").trim();
state.sessions.push({date:new Date().toISOString(),weekdayKey:wk,exercises,notes});
saveState();$("sessionNotes").value="";showToast("Sessão salva.");
}

/* ===== Routine ===== */
function renderRoutine(){
$("routineTextarea").value=state.routineText||"";
$("routinePreview").textContent=JSON.stringify(state.routineParsed||{},null,2);
}
function saveRoutine(){
const text=$("routineTextarea").value||"";
const parsed=parseRoutineV2(text);
if(!Object.keys(parsed).length){showToast("Não consegui parsear. Use NxA-B (ex: Supino 3x8-10).");return}
state.routineText=text;state.routineParsed=parsed;saveState();
$("routinePreview").textContent=JSON.stringify(state.routineParsed,null,2);
showToast("Rotina salva ✅");
}

/* ===== Diet ===== */
function ensureDietDay(dateStr){
if(!state.days||typeof state.days!=="object")state.days={};
if(!state.days[dateStr]){
state.days[dateStr]={targets:{kcal:0,p:0,c:0,f:0},meals:{cafe:[],almoco:[],lanche:[],jantar:[],ceia:[]}};
}else{
const d=state.days[dateStr];
if(!d.targets)d.targets={kcal:0,p:0,c:0,f:0};
if(!d.meals)d.meals={cafe:[],almoco:[],lanche:[],jantar:[],ceia:[]};
MEAL_KEYS.forEach(k=>{if(!Array.isArray(d.meals[k]))d.meals[k]=[]});
}
return state.days[dateStr];
}
function renderProgressBars(totals,tgt){
function bar(label,cur,goal){
if(!(goal>0))return `<div style="margin:8px 0;"><small>${label}: <b>${cur}</b> (sem meta)</small></div>`;
const pct=Math.min(100,Math.round((cur/goal)*100));
const left=Math.max(0,Math.round(goal-cur));
return `<div style="margin:8px 0;"><small>${label}: <b>${cur}</b> / ${goal} • ${pct}% • faltam ${left}</small><div class="progress"><div style="width:${pct}%;"></div></div></div>`;
}
return `${bar("kcal",totals.kcal,tgt.kcal)}${bar("Proteína (g)",totals.p,tgt.p)}${bar("Carbo (g)",totals.c,tgt.c)}${bar("Gordura (g)",totals.f,tgt.f)}`;
}
function renderDiet(){
const day=$("dietDate").value||isoDay(new Date());
$("dietDate").value=day;
const d=ensureDietDay(day);
$("tKcal").value=d.targets.kcal||0;
$("tP").value=d.targets.p||0;
$("tC").value=d.targets.c||0;
$("tF").value=d.targets.f||0;
const totals=dietTotals(d);
$("dietTotals").innerHTML=`<b>kcal:</b> ${totals.kcal} • <b>P:</b> ${totals.p}g • <b>C:</b> ${totals.c}g • <b>F:</b> ${totals.f}g`;
$("dietProgress").innerHTML=renderProgressBars(totals,d.targets||{kcal:0,p:0,c:0,f:0});
renderDietMealsList(day);
updateDashboard();
}
function renderDietMealsList(day){
const d=ensureDietDay(day);
let html="";
MEAL_KEYS.forEach(mk=>{
const items=d.meals[mk]||[];
html+=`<div style="border-top:1px solid rgba(255,255,255,.06);padding-top:10px;margin-top:10px;">
<div style="font-weight:950;margin-bottom:6px;">${MEAL_LABEL[mk]}</div>`;
if(!items.length){html+=`<small>Sem itens.</small>`}
else{
items.forEach(it=>{
html+=`<div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;margin-top:8px;">
<div><div><b>${escapeHtml(it.name)}</b></div><small>kcal ${Math.round(it.kcal)} • P ${it.p} • C ${it.c} • F ${it.f}</small></div>
<button class="btn btn-ghost" type="button" data-rm="1" data-day="${day}" data-meal="${mk}" data-id="${it.id}">X</button>
</div>`;
});
}
html+=`</div>`;
});
$("dietMealsList").innerHTML=html;
qsa('button[data-rm="1"]',$("dietMealsList")).forEach(btn=>{
btn.addEventListener("click",()=>{
const day=btn.getAttribute("data-day");
const meal=btn.getAttribute("data-meal");
const id=btn.getAttribute("data-id");
removeDietItem(day,meal,id);
});
});
}
function saveDietTargets(){
const day=$("dietDate").value||isoDay(new Date());
const d=ensureDietDay(day);
d.targets.kcal=Math.max(0,Math.round(parseFloat($("tKcal").value)||0));
d.targets.p=Math.max(0,Math.round(parseFloat($("tP").value)||0));
d.targets.c=Math.max(0,Math.round(parseFloat($("tC").value)||0));
d.targets.f=Math.max(0,Math.round(parseFloat($("tF").value)||0));
saveState();renderDiet();showToast("Metas salvas.");
}
function addFoodManual(){
const day=$("dietDate").value||isoDay(new Date());
const meal=$("dietMeal").value||"cafe";
const d=ensureDietDay(day);
const name=($("foodName").value||"").trim();
const kcalIn=Math.round(parseFloat($("fKcal").value)||0);
const p=parseFloat($("fP").value)||0;
const c=parseFloat($("fC").value)||0;
const f=parseFloat($("fF").value)||0;
if(!name){showToast("Informe o nome.");return}
if(!(kcalIn>0||p>0||c>0||f>0)){showToast("Informe kcal ou macros.");return}
const kcal=kcalIn>0?kcalIn:Math.round(p*4+c*4+f*9);
d.meals[meal].push({id:"D"+Date.now()+Math.random().toString(16).slice(2),name,kcal,p:+p.toFixed(1),c:+c.toFixed(1),f:+f.toFixed(1)});
$("foodName").value="";$("fKcal").value="";$("fP").value="";$("fC").value="";$("fF").value="";
saveState();renderDiet();showToast("Item adicionado.");
}
function removeDietItem(day,meal,id){
const d=ensureDietDay(day);
const arr=d.meals[meal]||[];
const idx=arr.findIndex(x=>x.id===id);
if(idx>=0){arr.splice(idx,1);saveState();renderDiet();showToast("Removido.");}
}

/* ===== TDEE ===== */
function num(v){const n=parseFloat(v);return Number.isFinite(n)?n:0}
function calcBMR(sex,kg,cm,age){return sex==="female"?(10*kg+6.25*cm-5*age-161):(10*kg+6.25*cm-5*age+5)}
function updateTdeeLabels(){$("pKgLabel").textContent=(+$("pKg").value).toFixed(2);$("fKgLabel").textContent=(+$("fKg").value).toFixed(2)}
function syncCalTargetFromMode(){
const t=state.tdee||{};if(!(t.tdee>0))return;
const mode=$("tdeeMode").value;
let cal=t.tdee; if(mode==="cut")cal=t.tdee-300; if(mode==="bulk")cal=t.tdee+200;
$("tdeeCalTarget").value=Math.round(cal);
}
function doCalcTdee(){
const sex=$("tdeeSex").value;
const activity=num($("tdeeActivity").value);
const age=num($("tdeeAge").value);
const height=num($("tdeeHeight").value);
const weight=num($("tdeeWeight").value);
if(!(age>0&&height>0&&weight>0)){showToast("Preencha idade, altura e peso.");return}
const bmr=calcBMR(sex,weight,height,age);
const tdee=bmr*activity;
state.tdee=state.tdee||{};
Object.assign(state.tdee,{sex,activity,age,height,weight,bmr:Math.round(bmr),tdee:Math.round(tdee)});
saveState();
renderTdeeResult();
syncCalTargetFromMode();
showToast("TDEE calculado.");
}
function renderTdeeResult(){
const t=state.tdee||{};
if(t.bmr&&t.tdee){
$("tdeeResult").innerHTML=`<div class="card" style="margin:0;margin-top:12px;">
<div style="display:flex;gap:12px;flex-wrap:wrap;">
<div style="flex:1;min-width:160px;"><small>BMR</small><div style="font-weight:950;font-size:18px;">${t.bmr} kcal</div></div>
<div style="flex:1;min-width:160px;"><small>TDEE</small><div style="font-weight:950;font-size:18px;">${t.tdee} kcal</div></div>
</div></div>`;
}else{$("tdeeResult").innerHTML=`<div class="empty" style="margin-top:12px;">Preencha os dados e clique <b>Calcular</b>.</div>`}
}
function genTargets(){
const t=state.tdee||{};
const weight=num($("tdeeWeight").value)||t.weight||0;
if(!(t.tdee>0)||!(weight>0)){showToast("Calcule o TDEE e informe o peso.");return}
const mode=$("tdeeMode").value;
let cal=num($("tdeeCalTarget").value);
if(!(cal>0)){cal=t.tdee+(mode==="cut"?-300:mode==="bulk"?200:0);cal=Math.round(cal);$("tdeeCalTarget").value=cal}
const pKg=num($("pKg").value),fKg=num($("fKg").value);
const p=Math.round(pKg*weight);
const f=Math.round(fKg*weight);
const kcalPF=p*4+f*9;
const c=Math.max(0,Math.round((cal-kcalPF)/4));
state.tdee=state.tdee||{};
Object.assign(state.tdee,{mode,calTarget:cal,pKg,fKg,targets:{kcal:cal,p,c,f}});
saveState();
renderTdeeTargetsBox();
showToast("Metas geradas.");
}
function renderTdeeTargetsBox(){
const t=state.tdee||{};
const g=t.targets;
if(!g){$("tdeeTargetsOut").innerHTML=`<div class="empty">Clique <b>Gerar metas</b> para ver P/C/F.</div>`;return}
$("tdeeTargetsOut").innerHTML=`<div class="card" style="margin:0;">
<div style="display:flex;gap:12px;flex-wrap:wrap;">
<div style="flex:1;min-width:140px;"><small>Calorias</small><div style="font-weight:950;font-size:18px;">${g.kcal}</div></div>
<div style="flex:1;min-width:140px;"><small>Proteína (g)</small><div style="font-weight:950;font-size:18px;">${g.p}</div></div>
<div style="flex:1;min-width:140px;"><small>Carbo (g)</small><div style="font-weight:950;font-size:18px;">${g.c}</div></div>
<div style="flex:1;min-width:140px;"><small>Gordura (g)</small><div style="font-weight:950;font-size:18px;">${g.f}</div></div>
</div></div>`;
}
function applyTargetsToDiet(){
const t=state.tdee||{};
if(!t.targets){showToast("Gere metas antes de aplicar.");return}
const day=($("dietDate")&&$("dietDate").value)?$("dietDate").value:isoDay(new Date());
const d=ensureDietDay(day);
d.targets.kcal=t.targets.kcal; d.targets.p=t.targets.p; d.targets.c=t.targets.c; d.targets.f=t.targets.f;
saveState(); showToast(`Metas aplicadas em ${day}.`);
renderDiet(); updateDashboard();
}
function renderTdee(){
const t=state.tdee||{};
if(t.sex) $("tdeeSex").value=t.sex;
if(t.activity) $("tdeeActivity").value=String(t.activity);
if(t.age) $("tdeeAge").value=t.age;
if(t.height) $("tdeeHeight").value=t.height;
if(t.weight) $("tdeeWeight").value=t.weight;
if(t.mode) $("tdeeMode").value=t.mode;
if(t.pKg) $("pKg").value=t.pKg;
if(t.fKg) $("fKg").value=t.fKg;
updateTdeeLabels();
if(t.calTarget) $("tdeeCalTarget").value=t.calTarget;
renderTdeeResult();
renderTdeeTargetsBox();
}
function useDietDate(){showToast(`Data alvo: ${$("dietDate").value||isoDay(new Date())}`)}

/* ===== Backup JSON ===== */
function renderBackupBox(){const ta=$("rawState"); if(!ta) return; ta.value=JSON.stringify(state,null,2); ta.scrollTop=0;}
function exportJSON(){
renderBackupBox();
const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="logbook_v2_backup.json";a.click();
showToast("Exportado.");
}
function importJSON(file){
const fr=new FileReader();
fr.onload=()=>{try{state=migrateState(JSON.parse(fr.result));saveState();showToast("Importado ✅");renderAll();nav("dashboard")}catch{showToast("JSON inválido.")}};
fr.readAsText(file);
}

/* ===== Inline prompt (no alert/prompt) ===== */
function openInlinePrompt(label){
return new Promise(resolve=>{
const existing=qs("[data-inlineprompt='1']");if(existing)existing.remove();
const overlay=document.createElement("div");
overlay.dataset.inlineprompt="1";
overlay.style.position="fixed";overlay.style.inset="0";overlay.style.background="rgba(0,0,0,.55)";
overlay.style.zIndex="999";overlay.style.display="flex";overlay.style.alignItems="center";
overlay.style.justifyContent="center";overlay.style.padding="18px";
const box=document.createElement("div");
box.style.width="min(520px,100%)";
box.style.background="rgba(13,13,20,.98)";
box.style.border="1px solid rgba(255,255,255,.10)";
box.style.borderRadius="18px";
box.style.boxShadow="0 18px 40px rgba(0,0,0,.55)";
box.style.padding="14px";
box.innerHTML=`<div style="font-weight:950;color:#fff;margin-bottom:6px;">${escapeHtml(label)}</div>
<input class="field" id="inlinePromptInput" placeholder="Ex: Rosca direta" style="margin-top:10px;">
<div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px;">
<button class="btn btn-ghost" id="inlinePromptCancel" type="button">Cancelar</button>
<button class="btn btn-primary" id="inlinePromptOk" type="button">OK</button>
</div>`;
overlay.appendChild(box);document.body.appendChild(overlay);
const input=$("inlinePromptInput");if(input)input.focus();
const cleanup=val=>{overlay.remove();resolve(val)};
$("inlinePromptCancel").onclick=()=>cleanup("");
$("inlinePromptOk").onclick=()=>cleanup((input&&input.value||"").trim());
overlay.addEventListener("click",e=>{if(e.target===overlay)cleanup("")});
});
}

/* ===== Bind / Init ===== */
function bind(){
qsa(".tab").forEach(btn=>btn.addEventListener("click",()=>nav(btn.getAttribute("data-target"))));
$("btnSaveRoutine").addEventListener("click",saveRoutine);
$("btnClearRoutine").addEventListener("click",()=>{state.routineText="";state.routineParsed={};saveState();renderRoutine();showToast("Rotina limpa.")});
$("btnSaveSession").addEventListener("click",()=>{saveSession();updateDashboard();drawChart(state.sessions);nav("dashboard")});
$("btnAddExercise").addEventListener("click",()=>openInlinePrompt("Nome do exercício extra:").then(name=>{
if(!name)return;
$("todayExercises").appendChild(buildExerciseCard(name,[{nSets:3,repMin:0,repMax:0}],findFallbackLastExercise(name))); // extra: usa fallback (última sessão) para ajudar
showToast("Exercício extra adicionado.");
}));
$("dietDate").addEventListener("change",renderDiet);
$("btnSaveTargets").addEventListener("click",saveDietTargets);
$("btnAddFood").addEventListener("click",addFoodManual);

$("pKg").addEventListener("input",updateTdeeLabels);
$("fKg").addEventListener("input",updateTdeeLabels);
$("tdeeMode").addEventListener("change",()=>{state.tdee=state.tdee||{};state.tdee.mode=$("tdeeMode").value;saveState();syncCalTargetFromMode()});
$("btnCalcTdee").addEventListener("click",doCalcTdee);
$("btnUseDietDate").addEventListener("click",useDietDate);
$("btnGenTargets").addEventListener("click",genTargets);
$("btnApplyToDiet").addEventListener("click",applyTargetsToDiet);

$("btnExportJSON").addEventListener("click",exportJSON);
$("btnImportJSON").addEventListener("click",()=>$("importFile").click());
$("importFile").addEventListener("change",e=>{const f=e.target.files&&e.target.files[0];if(f)importJSON(f);e.target.value=""});
}
function renderAll(){
$("dietDate").value=$("dietDate").value||isoDay(new Date());
renderRoutine();
renderDiet();
renderTdee();
renderBackupBox();
updateDashboard();
drawChart(state.sessions);
}
window.addEventListener("DOMContentLoaded",()=>{
loadState();
bind();
renderAll();
nav("dashboard");
});
})();</script>
</body>
</html>
