<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Logbook">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%2338bdf8'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='%230f172a'%3Eüí™%3C/text%3E%3C/svg%3E">
    <title>Logbook</title>
    <style>
        :root {
    --color-bg: #050509;
    --color-bg-secondary: #0d0d14;
    --color-primary: #ff0000;
    --color-primary-dark: #7a0000;
    --color-accent: #ff2a2a;
    --color-warning: #f59e0b;
    --color-text: #f5f5f7;
    --color-text-muted: #9aa0a6;
}

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            padding-bottom: 80px;
            -webkit-font-smoothing: antialiased;
        }

        .header {
            background: var(--color-surface);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--color-primary);
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--color-bg);
            position: sticky;
            top: 73px;
            z-index: 99;
            overflow-x: auto;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .tab {
            padding: 0.5rem 1rem;
            background: var(--color-surface);
            border: none;
            color: var(--color-text-muted);
            font-size: 0.875rem;
            border-radius: 6px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .tab.active {
            background: var(--color-primary);
            color: var(--color-bg);
            font-weight: 600;
        }

        .content {
            padding: 1rem;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .card {
            background: var(--color-surface);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .card h3 {
            color: var(--color-primary);
            font-size: 1.125rem;
            margin-bottom: 0.75rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--color-text);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--color-bg);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: var(--color-text);
            font-size: 1rem;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--color-primary);
            color: var(--color-bg);
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn:active {
            opacity: 0.8;
        }

        .btn-secondary {
            background: var(--color-surface);
            color: var(--color-text);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: var(--color-bg);
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--color-primary);
        }

        .log-entry {
            background: var(--color-bg);
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            border-left: 3px solid var(--color-primary);
        }

        .log-date {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            margin-bottom: 0.25rem;
        }

        .log-content {
            font-size: 0.875rem;
        }

        .btn-delete {
            background: var(--color-error);
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }

        .macro-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .macro-row:last-child {
            border-bottom: none;
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--color-text-muted);
        }

        .progress-bar {
            background: var(--color-bg);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-primary);
            transition: width 0.3s;
        }

        .workout-log {
            background: var(--color-bg);
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 0.75rem;
        }

        .workout-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .workout-name {
            font-weight: 600;
            color: var(--color-primary);
        }

        .workout-date {
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }

        .exercise-entry {
            font-size: 0.875rem;
            padding: 0.25rem 0;
            color: var(--color-text);
        }

        .exercise-input {
            background: var(--color-bg);
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .exercise-input input {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--color-text);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
        }

        .set-inputs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .set-inputs input {
            width: 100%;
            padding: 0.5rem;
            background: var(--color-surface);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            color: var(--color-text);
            font-size: 0.875rem;
            text-align: center;
        }

        .btn-small {
            padding: 0.5rem;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .comparison-card {
            background: var(--color-bg);
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.75rem;
            border-left: 3px solid var(--color-primary);
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--color-primary);
        }

        .comparison-data {
            font-size: 0.875rem;
            line-height: 1.6;
        }

        .pr-badge {
            display: inline-block;
            background: var(--color-success);
            color: var(--color-bg);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .trend-up {
            color: var(--color-success);
        }

        .trend-down {
            color: var(--color-error);
        }

        .trend-stable {
            color: var(--color-warning);
        }

        .volume-chart {
            background: var(--color-bg);
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            height: 200px;
            position: relative;
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
        }

        .volume-bar {
            flex: 1;
            background: var(--color-primary);
            border-radius: 4px 4px 0 0;
            position: relative;
            min-height: 20px;
            cursor: pointer;
        }

        .volume-bar-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.65rem;
            color: var(--color-text-muted);
            white-space: nowrap;
        }

        .volume-bar-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-primary);
            white-space: nowrap;
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            background: var(--color-surface);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--color-text-muted);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: var(--color-primary);
            color: var(--color-bg);
            border-color: var(--color-primary);
        }

        .notification-banner {
            background: linear-gradient(135deg, var(--color-primary), #dc2626);
            color: white;
            padding: 1rem;
            margin: 1rem;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .notification-banner:active {
            transform: scale(0.98);
        }

        .gems-message {
            background: var(--color-surface);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            border-left: 3px solid var(--color-primary);
        }

        .gems-message.user {
            background: var(--color-bg);
            border-left-color: var(--color-success);
        }

        .gems-message-label {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            margin-bottom: 0.25rem;
            font-weight: 600;
        }

        .gems-message-content {
            font-size: 0.875rem;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .reminder-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--color-error);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .notification-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--color-success);
            border-radius: 50%;
            margin-right: 0.5rem;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    .photo-card{
    border:1px solid rgba(255,255,255,0.12);
    border-radius:10px;
    overflow:hidden;
    background:var(--color-bg);
}
.photo-card img{width:100%;height:140px;object-fit:cover;display:block;}
.photo-card .meta{padding:0.5rem;font-size:0.75rem;color:var(--color-text-muted);}
.photo-card .actions{padding:0.5rem;display:flex;gap:0.5rem;flex-wrap:wrap;}
.mini-btn{
    padding:0.45rem 0.6rem;
    border-radius:6px;
    border:1px solid rgba(255,255,255,0.12);
    background:transparent;
    color:var(--color-text);
    cursor:pointer;
    font-size:0.75rem;
}
/* ===== Batman Beyond (clean) ===== */
body{
  background:
    radial-gradient(900px 500px at 15% 0%, rgba(255,26,26,0.10), transparent 55%),
    radial-gradient(700px 400px at 90% 10%, rgba(153,0,0,0.12), transparent 60%),
    var(--color-bg);
}
.card{
  border: 1px solid rgba(255,255,255,0.08);
  box-shadow: 0 10px 28px rgba(0,0,0,0.65);
}
.btn:not(.btn-secondary){
  background: linear-gradient(180deg, rgba(255,26,26,0.95), rgba(153,0,0,0.92));
  border: 1px solid rgba(255,26,26,0.35);
  box-shadow: 0 0 0 1px rgba(255,26,26,0.18), 0 0 22px rgba(255,26,26,0.20), 0 14px 28px rgba(0,0,0,0.55);
}
.btn:not(.btn-secondary):active{ transform: translateY(1px); }
.tab.active{ box-shadow: 0 0 0 1px rgba(255,26,26,0.5), 0 0 18px rgba(255,26,26,0.12); }
input, select, textarea{
  background: rgba(9,9,15,0.95);
  border: 1px solid rgba(255,255,255,0.10);
}
input:focus, select:focus, textarea:focus{
  border-color: rgba(255,26,26,0.55);
  box-shadow: 0 0 0 3px rgba(255,26,26,0.12);
  outline: none;
}
h3::after{
  content:"";
  display:block;
  height:2px;
  width:70px;
  margin-top:10px;
  background: linear-gradient(90deg, rgba(255,26,26,0.95), transparent);
  border-radius:999px;
}
/* Ensure tabs always clickable (no overlays) */
.app-container, .tabs, .tab { position: relative; z-index: 1; }
/* =================================== */
/* ===== BATMAN FUTURE THEME (SAFE) ===== */
body{
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background: radial-gradient(1200px 600px at 20% 0%, rgba(255,0,0,0.08), transparent 55%),
                radial-gradient(900px 500px at 90% 10%, rgba(122,0,0,0.10), transparent 60%),
                var(--color-bg);
}
.card{
    border: 1px solid rgba(255,0,0,0.18);
    box-shadow: 0 10px 30px rgba(0,0,0,0.55);
}
.btn:not(.btn-secondary){
    background: linear-gradient(180deg, #ff0000, #7a0000);
    border: 1px solid rgba(255,0,0,0.40);
    box-shadow: 0 0 8px rgba(255,0,0,0.6), 0 0 18px rgba(255,0,0,0.30), 0 14px 28px rgba(0,0,0,0.60);
}
.tab.active{
    box-shadow: 0 0 6px rgba(255,0,0,0.75), 0 0 14px rgba(255,0,0,0.35);
}
input,select,textarea{
    background:#0a0a12;
    border:1px solid rgba(255,255,255,0.10);
}
input:focus,select:focus,textarea:focus{
    border-color: rgba(255,0,0,0.65);
    box-shadow: 0 0 0 2px rgba(255,0,0,0.15);
}
/* Scanlines (subtle) */
.app-container::before{
    content:"";
    position: fixed;
    inset: 0;
    pointer-events: none;
    background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,0.02),
        rgba(255,255,255,0.02) 1px,
        transparent 1px,
        transparent 4px
    );
    mix-blend-mode: overlay;
    opacity: 0.22;
}
/* ===================================== */
</style>
</head>
<body>
    <div id="runtimeErrorBanner" style="display:none;position:sticky;top:0;z-index:9999;background:rgba(255,26,26,0.12);border-bottom:1px solid rgba(255,26,26,0.35);padding:10px 12px;color:var(--color-text);font-size:0.9rem;"></div>

    <div class="header">
        <h1>üí™ Logbook</h1>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('dashboard', this)">Dashboard</button>
        <button class="tab" onclick="showTab('macros', this)" type="button">Macros</button>
        <button class="tab" onclick="showTab('diario', this)" type="button">Di√°rio</button>
        <button class="tab" onclick="showTab('medidas', this)" type="button">Medidas</button>
        <button class="tab" onclick="showTab('rotina', this)" type="button">Rotina de Treino</button>
        <button class="tab" onclick="showTab('dieta', this)" type="button">Dieta</button>
        <button class="tab" onclick="showTab('logbook', this)" type="button">Log</button>
        <button class="tab" onclick="showTab('analise', this)" type="button">An√°lise</button>
        <button class="tab" onclick="showTab('fisico', this)" type="button">F√≠sico</button>
        <button class="tab" onclick="showTab('gems', this)" type="button">üíé GEMS</button>
        <button class="tab" onclick="showTab('refeeds', this)" type="button">üîÑ Refeeds</button>
        <button class="tab" onclick="showTab('deload', this)" type="button">üò¥ Deload</button>
    </div>

    <div class="content">
        <!-- DASHBOARD -->
        <div id="dashboard" class="section active">
            <div class="card">
                <h3>Seu Progresso</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Peso Atual</div>
                        <div class="stat-value" id="currentWeight">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Cintura</div>
                        <div class="stat-value" id="currentWaist">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Meta Semanal</div>
                        <div class="stat-value">-0.43kg</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Status</div>
                        <div class="stat-value" id="statusEmoji">üî•</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Macros Hoje</h3>
                <div class="macro-row">
                    <span>Prote√≠na</span>
                    <span id="proteinToday">0g / 160g</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="proteinBar" style="width: 0%"></div>
                </div>
                <div class="macro-row">
                    <span>Carbo</span>
                    <span id="carbToday">0g / 315g</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="carbBar" style="width: 0%"></div>
                </div>
                <div class="macro-row">
                    <span>Gordura</span>
                    <span id="fatToday">0g / 55g</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="fatBar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- MACROS -->
        <div id="macros" class="section">
            <div class="card">
                <h3>Calculadora de Macros</h3>
                <div class="form-group">
                    <label>Peso (kg)</label>
                    <input type="number" id="macroWeight" value="86" step="0.1">
                </div>
                <div class="form-group">
                    <label>Meta Cal√≥rica Di√°ria</label>
                    <input type="number" id="macroCalories" value="2700" step="50">
                </div>
                <div class="form-group">
                    <label>Prote√≠na (g/kg)</label>
                    <input type="number" id="macroProteinRatio" value="1.9" step="0.1">
                </div>
                <div class="form-group">
                    <label>% Gordura</label>
                    <input type="number" id="macroFatPercent" value="18" step="1">
                </div>
                <button class="btn" onclick="calculateMacros()">Calcular Macros</button>
            </div>

            <div class="card" id="macroResults" style="display:none;">
                <h3>Seus Macros</h3>
                <div class="macro-row">
                    <span>Prote√≠na</span>
                    <span id="resultProtein">--g</span>
                </div>
                <div class="macro-row">
                    <span>Gordura</span>
                    <span id="resultFat">--g</span>
                </div>
                <div class="macro-row">
                    <span>Carboidrato</span>
                    <span id="resultCarb">--g</span>
                </div>
                <button class="btn" onclick="saveMacros()">Salvar como Meta</button>
            </div>
        </div>

        <!-- DI√ÅRIO -->
        <div id="diario" class="section">
            <div class="card" id="diaryReferences" style="margin-bottom:1rem;"></div>
            <div class="card">
                <h3>Registrar Refei√ß√£o</h3>
                <div class="form-group">
                    <label>Refei√ß√£o</label>
                    <select id="mealType">
                        <option>Caf√© da manh√£</option>
                        <option>Almo√ßo</option>
                        <option>Lanche</option>
                        <option>Janta</option>
                        <option>P√≥s-treino</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Alimentos (um por linha)</label>
                    <textarea id="mealFoods" placeholder="Ex:&#10;300g de arroz&#10;100g de feij√£o preto&#10;150g de bife de boi" style="min-height:120px;"></textarea>
                </div>
                <button class="btn" onclick="calculateAndAddMeal()">Calcular e Adicionar Refei√ß√£o</button>
                
                <div id="mealCalculation" style="display:none;margin-top:1rem;padding:1rem;background:var(--color-bg);border-radius:6px;">
                    <h4 style="color:var(--color-primary);font-size:1rem;margin-bottom:0.5rem;">Macros Calculados:</h4>
                    <div style="font-size:0.875rem;">
                        <strong>Prote√≠na:</strong> <span id="calcProtein">0g</span><br>
                        <strong>Carboidrato:</strong> <span id="calcCarb">0g</span><br>
                        <strong>Gordura:</strong> <span id="calcFat">0g</span><br>
                        <strong>Calorias:</strong> <span id="calcCalories">0 kcal</span>
                    </div>
                    <button class="btn" onclick="confirmMeal()" style="margin-top:1rem;">Confirmar e Salvar</button>
                    <button class="btn btn-secondary" onclick="cancelMealCalculation()" style="margin-top:0.5rem;">Cancelar</button>
                </div>
            </div>

            <div class="card">
                <h3>Refei√ß√µes de Hoje</h3>
                <div id="mealList"></div>
                <button class="btn btn-secondary" onclick="clearTodayMeals()" style="margin-top:1rem;">Limpar Dia</button>
            </div>
        </div>

        <!-- MEDIDAS -->
        <div id="medidas" class="section">
            <div class="card">
                <h3>Registrar Medidas</h3>
                <div class="form-group">
                    <label>Data</label>
                    <input type="date" id="measureDate">
                </div>
                <div class="form-group">
                    <label>Peso (kg)</label>
                    <input type="number" id="measureWeight" step="0.1">
                </div>
                <div class="form-group">
                    <label>Cintura (cm)</label>
                    <input type="number" id="measureWaist" step="0.1">
                </div>
                <div class="form-group">
                    <label>Percep√ß√£o no Treino</label>
                    <select id="measurePerformance">
                        <option value="forte">üí™ Forte - Cargas subindo</option>
                        <option value="mantendo">‚úÖ Mantendo - Performance est√°vel</option>
                        <option value="fraco">‚ö†Ô∏è Fraco - Cargas caindo</option>
                    </select>
                </div>
                <button class="btn" onclick="addMeasurement()">Salvar Medida</button>
            </div>

            <div class="card">
                <h3>Hist√≥rico de Medidas</h3>
                <div id="measurementList"></div>
            </div>
        </div>

        
        <!-- ROTINA DE TREINO -->
        <div id="rotina" class="section">
            <div class="card">
                <h3>üìù Rotina de Treino (Edit√°vel)</h3>
                <p style="color:var(--color-text-muted);font-size:0.875rem;margin-bottom:1rem;">
                    Cole ou escreva sua rotina do jeito que quiser. O Log (Logbook) vai se adaptar automaticamente aos dias e exerc√≠cios.
                </p>

                <div class="form-group">
                    <label>Sua rotina</label>
                    <textarea id="customRoutine" style="min-height:240px;"
                        placeholder="Ex:
Segunda - Torso
1. Supino reto
2. Remada curvada

Ter√ßa - Pernas
1. Agachamento
2. Mesa flexora
...
"></textarea>
                </div>

                <button class="btn" onclick="saveCustomRoutine()">üíæ Salvar Rotina</button>
                <button class="btn btn-secondary" type="button" onclick="clearRoutine()" style="margin-left:0.5rem;">üóë Limpar Rotina</button>
                <div id="routineStatus" style="margin-top:1rem;color:var(--color-text-muted);font-size:0.85rem;"></div>
                <div id="routinePreview" style="margin-top:1rem;"></div>
            </div>
        </div>


        <div id="dieta" class="section">
            <div class="card">
                <h3>ü•ó Dieta / Macros (Edit√°vel)</h3>
                <p style="color:var(--color-text-muted);font-size:0.875rem;margin-bottom:1rem;">
                    Escreva sua dieta (texto livre) e/ou ajuste suas metas de macros. O Di√°rio usa isso como refer√™ncia.
                </p>

                <div class="stats-grid" style="margin-bottom:1rem;">
                    <div class="stat-card">
                        <div class="stat-label">Calorias</div>
                        <input type="number" id="dietCalories" placeholder="kcal" style="width:100%;margin-top:0.5rem;">
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Prote√≠na</div>
                        <input type="number" id="dietProtein" placeholder="g" style="width:100%;margin-top:0.5rem;">
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Carbo</div>
                        <input type="number" id="dietCarb" placeholder="g" style="width:100%;margin-top:0.5rem;">
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Gordura</div>
                        <input type="number" id="dietFat" placeholder="g" style="width:100%;margin-top:0.5rem;">
                    </div>
                </div>

                <button class="btn" onclick="saveDietMacros()">üíæ Salvar Metas</button>

                <div class="form-group" style="margin-top:1rem;">
                    <label>Sua dieta (texto)</label>
                    <textarea id="customDiet" style="min-height:200px;"
                        placeholder="Ex:
Caf√©: 4 ovos + p√£o
Almo√ßo: 300g arroz + 150g frango
...
Ou s√≥ macros e regras: sem fritura, 2L √°gua, etc."></textarea>
                </div>

                <button class="btn" onclick="saveCustomDiet()">üíæ Salvar Dieta</button>
                <button class="btn btn-secondary" type="button" onclick="clearDiet()" style="margin-left:0.5rem;">üóë Limpar Dieta</button>
                <button class="btn btn-secondary" onclick="clearCustomDiet()" style="margin-left:0.5rem;">üóë Limpar</button>

                <div id="dietStatus" style="margin-top:1rem;color:var(--color-text-muted);font-size:0.85rem;"></div>
            </div>
        </div>


        <!-- LOGBOOK -->
        <div id="logbook" class="section">
            <div class="card">
                <h3>Logbook</h3>

                <div class="form-group">
                    <label>Dia do Treino</label>
                    <select id="logDaySelect" onchange="onLogDayChange()"></select>
                    <div style="font-size:0.75rem;color:var(--color-text-muted);margin-top:0.5rem;">
                        O Logbook carrega os exerc√≠cios do dia escolhido com base na sua Rotina.
                    </div>
                </div>

                <div class="form-group">
                    <label>Treino Detectado</label>
                    <input type="text" id="autoWorkoutName" readonly style="font-weight:600;color:var(--color-primary);">
                </div>

                <div class="card" style="padding:1rem;margin-bottom:1rem;background:var(--color-bg);border:1px solid rgba(255,255,255,0.1);">
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
                        <div>
                            <div style="font-size:0.75rem;color:var(--color-text-muted);">‚è±Ô∏è Tempo de Treino</div>
                            <div id="workoutTimerDisplay" style="font-size:1.5rem;font-weight:700;letter-spacing:0.5px;">00:00:00</div>
                        </div>
                        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                            <button class="btn" id="timerStartBtn" onclick="startWorkoutTimer()">Iniciar</button>
                            <button class="btn btn-secondary" id="timerPauseBtn" onclick="toggleWorkoutTimer()" disabled>Pausar</button>
                            <button class="btn btn-secondary" id="timerResetBtn" onclick="resetWorkoutTimer()" disabled>Reset</button>
                        </div>
                    </div>
                    <div style="margin-top:0.75rem;display:flex;gap:0.75rem;align-items:flex-end;flex-wrap:wrap;">
                        <div class="form-group" style="margin:0;min-width:160px;">
                            <label style="font-size:0.8rem;color:var(--color-text-muted);">‚è≥ Descanso padr√£o (seg)</label>
                            <input type="number" id="restDurationSec" value="120" min="10" step="10" style="width:100%;">
                        </div>
                        <div style="font-size:0.8rem;color:var(--color-text-muted);margin-bottom:0.25rem;">
                            (HEVY vibe) Use o descanso por exerc√≠cio com 1 toque.
                        </div>
                    </div>
                    <div style="margin-top:0.5rem;font-size:0.8rem;color:var(--color-text-muted);">
                        Dica (estilo HEVY): inicie o timer quando come√ßar o treino e salve no final ‚Äî o tempo fica registrado no hist√≥rico.
                    </div>
                </div>
                
                <div id="exerciseInputs"></div>
                
                <div class="form-group" style="margin-top:1rem;">
                    <label>Observa√ß√µes do Treino</label>
                    <textarea id="workoutNotes" placeholder="Ex: Treino bom, meio cansado mas bom..."></textarea>
                </div>
                
                <button class="btn" onclick="addWorkout()">Salvar Treino</button>
            </div>

            <div class="card">
                <h3>Hist√≥rico de Treinos</h3>
                <div id="workoutList"></div>
            </div>
        
            <div class="card">
                <h3>üìà Hist√≥rico por Exerc√≠cio</h3>
                <div class="form-group">
                    <label>Escolha o exerc√≠cio</label>
                    <input type="text" id="exerciseSearch" placeholder="Digite para filtrar (ex: supino)" oninput="filterExerciseOptions()" style="margin-bottom:0.75rem;">
                    <select id="exerciseSelect" onchange="renderExerciseHistory()"></select>
                </div>
                <div id="exerciseHistoryPanel"></div>
            </div>
</div>

        <!-- AN√ÅLISE -->
        <div id="analise" class="section">
            <div class="card">
                <h3>Volume Semanal</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Esta Semana</div>
                        <div class="stat-value" id="weeklyVolume">0 kg</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Semana Passada</div>
                        <div class="stat-value" id="lastWeekVolume">0 kg</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Tend√™ncia</div>
                        <div class="stat-value" id="volumeTrend">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Treinos</div>
                        <div class="stat-value" id="totalWorkouts">0</div>
                    </div>
                </div>
                
                <div class="volume-chart" id="volumeChart"></div>
            </div>

            <div class="card">
                <h3>Compara√ß√£o de Treinos</h3>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterWorkoutType('all')">Todos</button>
                    <button class="filter-btn" onclick="filterWorkoutType('T1')">T1</button>
                    <button class="filter-btn" onclick="filterWorkoutType('T2')">T2</button>
                    <button class="filter-btn" onclick="filterWorkoutType('T3')">T3</button>
                    <button class="filter-btn" onclick="filterWorkoutType('L1')">L1</button>
                    <button class="filter-btn" onclick="filterWorkoutType('L2')">L2</button>
                </div>
                <div id="comparisonList"></div>
            </div>

            <div class="card">
                <h3>üèÜ Recordes Pessoais</h3>
                <div id="prList"></div>
            </div>
        </div>

        <!-- GEMS -->
        <div id="gems" class="section">
            <div class="card">
                <h3>üíé GEMS - Teu Assistente AI</h3>
                <p style="color:var(--color-text-muted);font-size:0.875rem;margin-bottom:1rem;">
                    GEMS √© um assistente AI completo baseado no Samuel Meller + Justin Shier! Analisa automaticamente todos os dados do teu Logbook (peso, treinos, dieta, fotos) e te d√° respostas personalizadas. Quanto mais tu usar o app, mais preciso ele fica!
                </p>
                
                <div style="background:var(--color-bg);padding:1rem;border-radius:6px;border:1px solid var(--color-primary);margin-bottom:1rem;">
                    <strong style="color:var(--color-primary);display:block;margin-bottom:0.5rem;">ü§ñ AN√ÅLISE AUTOM√ÅTICA ATIVADA!</strong>
                    <p style="font-size:0.875rem;color:var(--color-text);line-height:1.6;margin:0;">
                        GEMS agora analisa automaticamente:<br>
                        ‚úÖ Tend√™ncia de peso e composi√ß√£o corporal<br>
                        ‚úÖ Progress√£o de for√ßa por exerc√≠cio<br>
                        ‚úÖ Volume semanal de treino<br>
                        ‚úÖ Ader√™ncia aos macros<br>
                        ‚úÖ Identifica problemas antes de virarem grandes<br><br>
                        <strong>Faz tua pergunta e ele vai buscar nos teus dados reais!</strong>
                    </p>
                </div>
                
                <div class="form-group">
                    <label>üìã Contexto Pessoal (Opcional - GEMS j√° analisa teus dados automaticamente!)</label>
                    <textarea id="gemsContext" placeholder="OPCIONAL: Se quiser adicionar informa√ß√µes extras que n√£o est√£o no Logbook:&#10;&#10;Ex:&#10;- Hor√°rios espec√≠ficos (acordo 6h, trabalho 8-18h)&#10;- Prefer√™ncias alimentares (odeio br√≥colis, amo batata doce)&#10;- Observa√ß√µes pessoais (durmo mal, stress alto no trabalho)&#10;- Qualquer coisa que queira que o GEMS saiba&#10;&#10;GEMS j√° tem acesso a:&#10;‚úì Todos teus treinos e progress√µes&#10;‚úì Todas tuas medidas e peso&#10;‚úì Toda tua dieta registrada&#10;‚úì Tuas fotos de progresso&#10;‚úì Hist√≥rico de refeeds e deloads" style="min-height:180px;"></textarea>
                </div>
                
                <button class="btn" onclick="saveGemsContext()">üíæ Salvar Contexto Extra</button>
                
                <div style="margin-top:1rem;padding:1rem;background:var(--color-bg);border-radius:6px;border:1px solid rgba(255,255,255,0.1);">
                    <strong style="color:var(--color-primary);display:block;margin-bottom:0.5rem;">üí° Exemplos de perguntas pro GEMS:</strong>
                    <p style="font-size:0.875rem;color:var(--color-text-muted);line-height:1.6;margin:0;">
                        <strong>üìä AN√ÅLISE:</strong><br>
                        "Como t√° meu progresso?" "T√¥ evoluindo?" "Por que n√£o vejo resultado?"<br><br>
                        
                        <strong>üí™ TREINO:</strong><br>
                        "Meu supino n√£o sobe, o que fazer?" "Treino t√° fraco, por qu√™?"<br><br>
                        
                        <strong>üçΩÔ∏è DIETA:</strong><br>
                        "T√¥ com fome fora de hora" "Posso aumentar calorias?" "Preciso de 300 kcal ainda hoje"<br><br>
                        
                        <strong>‚öñÔ∏è PESO:</strong><br>
                        "Peso estagnado, e agora?" "T√¥ perdendo peso r√°pido demais?"<br><br>
                        
                        <strong>üéØ ESTRAT√âGIAS:</strong><br>
                        "Quando fazer refeed?" "Preciso de deload?" "Como montar minha dieta?"<br><br>
                        
                        <em>GEMS analisa automaticamente todos os dados do Logbook antes de responder!</em>
                    </p>
                </div>
            </div>
            
            <div class="card">
                <h3>üí¨ Chat com GEMS</h3>

                <div class="card" style="background:var(--color-bg);border:1px solid rgba(255,255,255,0.12);margin-bottom:1rem;">
                    <h3 style="margin-bottom:0.5rem;">‚öôÔ∏è Motor de IA (opcional)</h3>
                    <p style="color:var(--color-text-muted);font-size:0.85rem;line-height:1.5;margin-bottom:0.75rem;">
                        Por padr√£o o GEMS roda <strong>offline</strong> (sem internet) usando teus dados do app.
                        Se quiser conectar <strong>GPT‚Äë5.2</strong> ou <strong>Gemini</strong>, use um <strong>proxy</strong> (recomendado) e tua chave.
                        <br><em>Obs: colocar chave direto no GitHub Pages n√£o √© seguro.</em>
                    </p>

                    <div class="form-group">
                        <label>Fornecedor</label>
                        <select id="gemsProvider" onchange="saveGemsProviderSettings()">
                            <option value="offline">Offline (regras + teus dados)</option>
                            <option value="openai">OpenAI (GPT‚Äë5.2 via proxy)</option>
                            <option value="gemini">Google (Gemini via proxy)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Proxy URL (recomendado)</label>
                        <input id="gemsProxyUrl" type="text" placeholder="Ex: https://seu-proxy.seudominio.workers.dev" onblur="saveGemsProviderSettings()">
                    </div>

                    <div class="form-group">
                        <label>API Key (fica salva s√≥ neste aparelho)</label>
                        <input id="gemsApiKey" type="password" placeholder="Cole sua chave aqui" onblur="saveGemsProviderSettings()">
                    </div>

                    <button class="btn btn-secondary" onclick="testGemsConnection()">Testar conex√£o</button>
                </div>

                
                <div style="background:linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));padding:1rem;border-radius:6px;margin-bottom:1rem;border:1px solid var(--color-primary);">
                    <div style="font-size:0.875rem;color:var(--color-text);line-height:1.6;">
                        <strong style="color:var(--color-primary);">üî• GEMS est√° analisando teus dados...</strong><br>
                        <span id="gemsAnalysisPreview" style="font-size:0.8rem;color:var(--color-text-muted);">Carregando an√°lise autom√°tica...</span>
                    </div>
                </div>
                
                <div id="gemsChatHistory" style="max-height:400px;overflow-y:auto;margin-bottom:1rem;"></div>
                
                <div class="form-group">
                    <label>Tua Pergunta</label>
                    <textarea id="gemsQuestion" placeholder="Ex: Como t√° meu progresso? | Meu supino n√£o sobe | T√¥ com fome | Posso aumentar calorias?" style="min-height:80px;"></textarea>
                </div>
                
                <button class="btn" onclick="askGems()">üöÄ Perguntar ao GEMS</button>
                <button class="btn btn-secondary" onclick="clearGemsChat()" style="margin-top:0.5rem;">üóëÔ∏è Limpar Chat</button>
                
                <div style="margin-top:1rem;padding:0.75rem;background:var(--color-surface);border-radius:6px;border:1px solid rgba(255,255,255,0.1);">
                    <p style="font-size:0.75rem;color:var(--color-text-muted);margin:0;line-height:1.5;">
                        üíæ Todas as respostas s√£o baseadas nos teus dados reais do Logbook<br>
                        üìä Quanto mais tu usar o app, mais preciso o GEMS fica<br>
                        üîí Tudo processado localmente no teu celular
                    </p>
                </div>
            </div>
        </div>

        <!-- REFEEDS -->
        <div id="refeeds" class="section">
            <div class="card">
                <h3>üîÑ Protocolo de Refeed</h3>
                <p style="color:var(--color-text-muted);font-size:0.875rem;margin-bottom:1rem;">
                    Refeed = dia estrat√©gico com MAIS carboidratos pra repor glicog√™nio, melhorar horm√¥nios e quebrar adapta√ß√£o metab√≥lica.
                </p>
                
                <div style="background:var(--color-bg);padding:1rem;border-radius:6px;margin-bottom:1rem;border-left:3px solid var(--color-primary);">
                    <strong style="color:var(--color-primary);">üìä Quando fazer?</strong>
                    <div style="font-size:0.875rem;margin-top:0.5rem;line-height:1.6;">
                        ‚úÖ A cada 7-14 dias em cutting<br>
                        ‚úÖ Quando for√ßa t√° caindo muito<br>
                        ‚úÖ Peso estagnado h√° 2+ semanas<br>
                        ‚ùå N√ÉO √© dia do lixo descontrolado!
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Data do Refeed</label>
                    <input type="date" id="refeedDate">
                </div>
                
                <div class="form-group">
                    <label>Peso no Dia (kg)</label>
                    <input type="number" id="refeedWeight" step="0.1" placeholder="Ex: 86.5">
                </div>
                
                <div class="stats-grid" style="margin-bottom:1rem;">
                    <div class="stat-card">
                        <div class="stat-label">Prote√≠na</div>
                        <div class="stat-value" id="refeedProtein" style="font-size:1.25rem;">160g</div>
                        <div style="font-size:0.75rem;color:var(--color-text-muted);margin-top:0.25rem;">Mant√©m igual</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Carboidrato</div>
                        <div class="stat-value" id="refeedCarb" style="font-size:1.25rem;">520g</div>
                        <div style="font-size:0.75rem;color:var(--color-text-muted);margin-top:0.25rem;">~6g/kg</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Gordura</div>
                        <div class="stat-value" id="refeedFat" style="font-size:1.25rem;">30g</div>
                        <div style="font-size:0.75rem;color:var(--color-text-muted);margin-top:0.25rem;">Reduz pela metade</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Calorias</div>
                        <div class="stat-value" id="refeedCals" style="font-size:1.25rem;">3150</div>
                        <div style="font-size:0.75rem;color:var(--color-text-muted);margin-top:0.25rem;">Total</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Como foi? (percep√ß√£o)</label>
                    <select id="refeedFeeling">
                        <option value="otimo">üî• √ìtimo - Cheio de energia depois</option>
                        <option value="bom">‚úÖ Bom - Ajudou na recupera√ß√£o</option>
                        <option value="normal">‚û°Ô∏è Normal - N√£o notei diferen√ßa</option>
                        <option value="ruim">‚ö†Ô∏è Ruim - Me senti mal/pesado</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Observa√ß√µes</label>
                    <textarea id="refeedNotes" placeholder="Ex: Acordei 1.5kg mais pesado (√°gua), treino do dia seguinte foi INSANO..." style="min-height:80px;"></textarea>
                </div>
                
                <button class="btn" onclick="addRefeed()">Salvar Refeed</button>
                
                <div style="margin-top:1rem;padding:1rem;background:var(--color-bg);border-radius:6px;border:1px solid rgba(255,255,255,0.1);">
                    <strong style="color:var(--color-primary);display:block;margin-bottom:0.5rem;">üí° Dicas Meller:</strong>
                    <p style="font-size:0.875rem;color:var(--color-text-muted);line-height:1.6;">
                        <strong>Alimentos:</strong> Arroz, batata, massa, p√£o, aveia, frutas<br>
                        <strong>EVITA:</strong> Gordura (pizza, hamb√∫rguer, frituras)<br>
                        <strong>Doce?</strong> SIM, mas low fat (balas, picol√© fruta, gelatina)<br>
                        <strong>Peso vai subir:</strong> 1-2kg de √°gua = NORMAL! Volta em 2-3 dias<br>
                        <strong>Pr√≥ximo dia:</strong> Volta pro d√©ficit normal
                    </p>
                </div>
            </div>

            <div class="card">
                <h3>üìä Hist√≥rico de Refeeds</h3>
                <div id="refeedList"></div>
            </div>
        </div>

        <!-- DELOAD -->
        <div id="deload" class="section">
            <div class="card">
                <h3>üò¥ Semana de Deload</h3>
                <p style="color:var(--color-text-muted);font-size:0.875rem;margin-bottom:1rem;">
                    Deload = semana com 40-60% do volume/intensidade normal pra recuperar de verdade. N√£o √© descanso total!
                </p>
                
                <div style="background:var(--color-bg);padding:1rem;border-radius:6px;margin-bottom:1rem;border-left:3px solid var(--color-warning);">
                    <strong style="color:var(--color-warning);">‚ö†Ô∏è Quando fazer deload?</strong>
                    <div style="font-size:0.875rem;margin-top:0.5rem;line-height:1.6;">
                        ‚úÖ A cada 4-6 semanas de treino pesado<br>
                        ‚úÖ Quando for√ßa t√° caindo consistente<br>
                        ‚úÖ Articula√ß√µes doloridas<br>
                        ‚úÖ Cansa√ßo acumulado/overtraining<br>
                        ‚úÖ Antes de intensificar treino
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Semana de Deload</label>
                    <input type="week" id="deloadWeek">
                </div>
                
                <div class="form-group">
                    <label>Protocolo escolhido</label>
                    <select id="deloadProtocol">
                        <option value="volume">Volume Reduzido (50% s√©ries, mesma carga)</option>
                        <option value="intensidade">Intensidade Reduzida (60% carga, mesmas s√©ries)</option>
                        <option value="completo">Completo (50% volume + 60% carga)</option>
                        <option value="ativo">Descanso Ativo (caminhada, mobilidade)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Como se sentiu durante?</label>
                    <textarea id="deloadFeeling" placeholder="Ex: Semana chata mas necess√°ria, articula√ß√µes melhoraram muito..." style="min-height:80px;"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Resultado p√≥s-deload</label>
                    <select id="deloadResult">
                        <option value="excelente">üî• Excelente - Voltei muito mais forte</option>
                        <option value="bom">‚úÖ Bom - Recuperei bem</option>
                        <option value="normal">‚û°Ô∏è Normal - Ajudou um pouco</option>
                        <option value="ruim">‚ö†Ô∏è Ruim - Ainda cansado</option>
                    </select>
                </div>
                
                <button class="btn" onclick="addDeload()">Salvar Deload</button>
                
                <div style="margin-top:1rem;padding:1rem;background:var(--color-bg);border-radius:6px;border:1px solid rgba(255,255,255,0.1);">
                    <strong style="color:var(--color-warning);display:block;margin-bottom:0.5rem;">üí° Filosofia Meller:</strong>
                    <p style="font-size:0.875rem;color:var(--color-text-muted);line-height:1.6;">
                        <strong>N√£o √© fraqueza:</strong> Guri inteligente deloada, burro fica lesionado<br>
                        <strong>Calorias:</strong> MANT√âM ou aumenta um pouco (n√£o corta!)<br>
                        <strong>Prote√≠na:</strong> Mant√©m alta (2g/kg)<br>
                        <strong>Sono:</strong> Prioriza dormir mais nessa semana<br>
                        <strong>Pr√≥xima semana:</strong> Volta com TUDO, mais forte
                    </p>
                </div>
            </div>

            <div class="card">
                <h3>üìä Hist√≥rico de Deloads</h3>
                <div id="deloadList"></div>
            </div>
        </div>

        <!-- F√çSICO -->
        <div id="fisico" class="section">
            <div class="card">
                <h3>üì∏ Progresso F√≠sico</h3>
                <p style="color:var(--color-text-muted);font-size:0.875rem;margin-bottom:1rem;">
                    Tire fotos semanais (frente, costas, lateral) pra acompanhar evolu√ß√£o visual e estimar BF%.
                </p>
                
                <div class="form-group">
                    <label>Data da Foto</label>
                    <input type="date" id="photoDate">
                </div>
                
                <div class="form-group">
                    <label>Peso no Dia (kg)</label>
                    <input type="number" id="photoWeight" step="0.1" placeholder="Ex: 86.5">
                </div>
                
                <div class="form-group">
                    <label>Foto (Anexar ou colar URL)</label>
                    <input type="file" id="photoFile" accept="image/*" style="margin-bottom:0.5rem;">
                    <input type="text" id="photoUrl" placeholder="Ou cole o link da imagem aqui" style="margin-top:0.5rem;">
                    <div style="font-size:0.75rem;color:var(--color-text-muted);margin-top:0.5rem;">
                        üì∑ Anexe uma foto do seu dispositivo ou cole um link externo.
                    </div>
                </div>
                
                <div class="form-group">
                    <label>BF% Estimado (opcional)</label>
                    <input type="number" id="photoBf" step="0.1" placeholder="Ex: 15.5">
                    <div style="font-size:0.75rem;color:var(--color-text-muted);margin-top:0.5rem;">
                        Deixe vazio se quiser estimar visualmente depois.
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Observa√ß√µes</label>
                    <textarea id="photoNotes" placeholder="Ex: Acordei bem inchado, meio flat..." style="min-height:80px;"></textarea>
                </div>
                
                <button class="btn" onclick="addPhotoProgress()">Salvar Progresso</button>
            </div>

            <div class="card">
                <h3>üìä Linha do Tempo</h3>
                <div id="photoTimeline"></div>
            </div>
        
        <!-- INSIGHTS -->
        <div id="insights" class="section">
            <div class="card">
                <h3>üìä Insights (estilo Samuel)</h3>
                <p style="color:var(--color-text-muted);font-size:0.875rem;margin-bottom:1rem;">
                    Resumo semanal, ader√™ncia √† rotina e PRs. Foco no que realmente move o ponteiro: consist√™ncia + progress√£o.
                </p>

                <div class="stats-grid" style="margin-bottom:1rem;">
                    <div class="stat-card">
                        <div class="stat-label">Sess√µes (7 dias)</div>
                        <div class="stat-value" id="wkSessions">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Ader√™ncia √† rotina</div>
                        <div class="stat-value" id="wkAdherence">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Volume (7 dias)</div>
                        <div class="stat-value" id="wkVolume">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">PRs (7 dias)</div>
                        <div class="stat-value" id="wkPRs">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Streak (‚â•80%)</div>
                        <div class="stat-value" id="wkStreak">0</div>
                    </div>
                </div>

                <div class="card" style="padding:1rem;background:var(--color-bg);border:1px solid rgba(255,255,255,0.1);">
                    <h4 style="margin:0 0 0.75rem 0;">üî• PRs recentes</h4>
                    <div id="prFeed"></div>
                </div>

                <div class="card" style="padding:1rem;margin-top:1rem;background:var(--color-bg);border:1px solid rgba(255,255,255,0.1);">
                    <h4 style="margin:0 0 0.75rem 0;">‚úÖ Checklist semanal (Rotina)</h4>
                    <div id="weekChecklist"></div>
                    <div style="margin-top:0.75rem;color:var(--color-text-muted);font-size:0.85rem;">
                        Baseado nos dias definidos na sua Rotina. Marca√ß√£o autom√°tica quando voc√™ salva um treino no dia.
                    </div>
                </div>
            </div>
        </div>


        </div>
    </div>

    <script>
// Minimal runtime guard
window.addEventListener('error', (e) => {
  const banner = document.getElementById('runtimeErrorBanner');
  if (banner) { banner.style.display = 'block'; banner.textContent = 'Erro de script: ' + (e?.message || 'desconhecido'); }
});

        // Initialize data
        let data = {
            macros: { protein: 160, carb: 315, fat: 55, calories: 2700 },
            meals: [],
            measurements: [],
            workouts: [],
            photos: [],
            refeeds: [],
            deloads: [],
            gemsContext: '',
            gemsChat: [],
            lastPhotoReminder: null,
            lastMeasureReminder: null,
            notificationsEnabled: false
        };

        let exerciseCount = 0;
        let currentFilter = 'all';

        // Load data from localStorage
        function loadData() {
            migrateStorageOnce();
            const saved = localStorage.getItem('guriDoLowData');
            if (saved) {
                data = JSON.parse(saved);
            }
            updateDashboard();
            renderMeals();
            renderMeasurements();
            renderWorkouts();
            renderRefeeds();
            renderDeloads();
            updateRefeedCalculator();
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('guriDoLowData', JSON.stringify(data));
        }

        // Tab switching
        function showTab(tabName, clickedButton) {
    try {
        const target = document.getElementById(tabName);
        if (!target) {
            console.warn('Tab section not found:', tabName);
            return;
        }

        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

        target.classList.add('active');
        if (clickedButton) clickedButton.classList.add('active');

        // Hooks (guarded)
        if (tabName === 'fisico' && typeof renderPhysique === 'function') renderPhysique();
        if (tabName === 'insights' && typeof computeWeeklyInsights === 'function') computeWeeklyInsights();
        if (tabName === 'logbook') {
            if (typeof populateLogDaySelect === 'function') populateLogDaySelect();
            if (typeof initializeExercises === 'function') initializeExercises();
        }
        if ((tabName === 'diario' || tabName === 'dashboard') && typeof updateDiaryReferences === 'function') {
            updateDiaryReferences();
        }
    } catch (e) {
        console.error('showTab error:', e);
        alert('ERRO DE SCRIPT. RECARREGUE A P√ÅGINA.');
    }
}

        // Exercise input management
        function loadExercisesFromList(list) {
            exerciseCount = 0;
            const container = document.getElementById('exerciseInputs');
            container.innerHTML = '';

            list.forEach((exerciseName) => {
                exerciseCount++;
                const div = document.createElement('div');
                div.className = 'exercise-input';
                div.id = `exercise-${exerciseCount}`;
                div.innerHTML = `
                    <div style="font-weight:600;color:var(--color-primary);margin-bottom:0.5rem;font-size:0.875rem;">${exerciseName}</div>

                    <div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;margin-bottom:0.5rem;">
                        <select id="ex-type-${exerciseCount}" style="padding:0.6rem;border-radius:6px;border:1px solid rgba(255,255,255,0.12);background:var(--color-bg);color:var(--color-text);">
                            <option value="warmup">Aquecimento</option>
                            <option value="feeder">Feeder</option>
                            <option value="normal">Work set</option>
                            <option value="top">Top set</option>
                            <option value="backoff">Back-off</option>
                        </select>

                        <button class="btn btn-secondary" type="button" onclick="startRestTimer(${exerciseCount})">‚è≥ Descanso</button>
                        <span id="ex-rest-display-${exerciseCount}" style="font-size:0.8rem;color:var(--color-text-muted);">--:--</span>
                    </div>

                    <div class="set-inputs">
                    <div id="ex-suggest-${exerciseCount}" style="margin:0.25rem 0 0.5rem 0;font-size:0.8rem;color:var(--color-text-muted);"></div>
                    <div class="set-inputs">
                        <input type="number" placeholder="Kg" id="ex-kg-${exerciseCount}" step="0.5">
                        <input type="number" placeholder="Reps" id="ex-reps-${exerciseCount}" step="1">
                        <input type="number" placeholder="RIR" id="ex-rir-${exerciseCount}" step="1" min="0" max="5">
                    </div>
                `;
                container.appendChild(div);
            });

            annotateExerciseInputsWithLast();
                updateExerciseBadgesAndSuggestions();
                wireAutoRestTimer();
        }
        function loadWorkoutTemplate(workoutType) {
            const template = workoutTemplates[workoutType];
            if (!template) {
                initializeExercises();
                return;
            }
            
            exerciseCount = 0;
            const container = document.getElementById('exerciseInputs');
            container.innerHTML = '';
            
            template.forEach((exerciseName, index) => {
                exerciseCount++;
                const div = document.createElement('div');
                div.className = 'exercise-input';
                div.id = `exercise-${exerciseCount}`;
                div.innerHTML = `
                    <div style="font-weight:600;color:var(--color-primary);margin-bottom:0.5rem;font-size:0.875rem;">${exerciseName}</div>
                    <div class="set-inputs">
                        <input type="number" placeholder="Kg" id="ex-kg-${exerciseCount}" step="0.5">
                        <input type="number" placeholder="Reps" id="ex-reps-${exerciseCount}" step="1">
                        <input type="number" placeholder="RIR" id="ex-rir-${exerciseCount}" step="1" min="0" max="5">
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function initializeExercises() {
            const routineText = localStorage.getItem('customRoutineText') || '';
            const routine = parseRoutineText(routineText);

            // Selected day (or today)
            const day = (typeof getSelectedLogDay === 'function') ? getSelectedLogDay() : getTodayLabel();
            const template = routine[day];

            if (template && template.length) {
                loadExercisesFromList(template);
                annotateExerciseInputsWithLast();
                updateExerciseBadgesAndSuggestions();
                wireAutoRestTimer();

                const input = document.getElementById('autoWorkoutName');
                if (input) input.value = `${day}`;
                return;
            }

            document.getElementById('exerciseInputs').innerHTML =
                '<div class="empty-state">Defina sua <strong>Rotina de Treino</strong> na aba Rotina de Treino para o Log se adaptar. üí™</div>';
            const input = document.getElementById('autoWorkoutName');
            if (input) input.value = 'Sem Rotina';
            exerciseCount = 0;
        }

        // Macro calculator
        function calculateMacros() {
            const weight = parseFloat(document.getElementById('macroWeight').value);
            const calories = parseFloat(document.getElementById('macroCalories').value);
            const proteinRatio = parseFloat(document.getElementById('macroProteinRatio').value);
            const fatPercent = parseFloat(document.getElementById('macroFatPercent').value);

            const protein = Math.round(weight * proteinRatio);
            const fat = Math.round((calories * (fatPercent / 100)) / 9);
            const proteinCal = protein * 4;
            const fatCal = fat * 9;
            const carbCal = calories - proteinCal - fatCal;
            const carb = Math.round(carbCal / 4);

            document.getElementById('resultProtein').textContent = protein + 'g';
            document.getElementById('resultFat').textContent = fat + 'g';
            document.getElementById('resultCarb').textContent = carb + 'g';
            document.getElementById('macroResults').style.display = 'block';

            data.tempMacros = { protein, carb, fat, calories };
        }

        function saveMacros() {
            if (data.tempMacros) {
                data.macros = data.tempMacros;
                saveData();
                alert('Macros salvos como meta!');
                updateDashboard();
            }
        }

        // Food database (macros por 100g)
        const foodDatabase = {
            'arroz': { protein: 2.7, carb: 28, fat: 0.3 },
            'feijao': { protein: 6, carb: 14, fat: 0.5 },
            'feijao preto': { protein: 6, carb: 14, fat: 0.5 },
            'bife': { protein: 26, carb: 0, fat: 8 },
            'bife de boi': { protein: 26, carb: 0, fat: 8 },
            'frango': { protein: 31, carb: 0, fat: 3.6 },
            'peito de frango': { protein: 31, carb: 0, fat: 3.6 },
            'ovo': { protein: 13, carb: 1.1, fat: 11 },
            'ovos': { protein: 13, carb: 1.1, fat: 11 },
            'batata': { protein: 2, carb: 17, fat: 0.1 },
            'batata doce': { protein: 2, carb: 20, fat: 0.1 },
            'macarrao': { protein: 5, carb: 25, fat: 0.9 },
            'pao': { protein: 9, carb: 49, fat: 3.2 },
            'pao frances': { protein: 9, carb: 49, fat: 3.2 },
            'leite': { protein: 3.2, carb: 4.8, fat: 3.2 },
            'iogurte': { protein: 3.5, carb: 4.7, fat: 3.3 },
            'queijo': { protein: 25, carb: 1.3, fat: 27 },
            'banana': { protein: 1.1, carb: 23, fat: 0.3 },
            'aveia': { protein: 13.2, carb: 66.3, fat: 6.9 },
            'whey': { protein: 80, carb: 5, fat: 3 },
            'pasta de amendoim': { protein: 25, carb: 20, fat: 50 },
            'amendoim': { protein: 26, carb: 16, fat: 49 },
            'azeite': { protein: 0, carb: 0, fat: 100 },
            'oleo': { protein: 0, carb: 0, fat: 100 }
        };

        let tempMealData = null;

        // Parse food input and calculate macros
        function calculateAndAddMeal() {
            const foodsText = document.getElementById('mealFoods').value.trim();
            if (!foodsText) {
                alert('Digite os alimentos da refei√ß√£o!');
                return;
            }

            const lines = foodsText.split('\n').filter(l => l.trim());
            let totalProtein = 0, totalCarb = 0, totalFat = 0;
            const parsedFoods = [];

            lines.forEach(line => {
                const match = line.match(/(\d+)\s*g\s+(?:de\s+)?(.+)/i);
                if (match) {
                    const grams = parseFloat(match[1]);
                    const foodName = match[2].trim().toLowerCase();
                    
                    let foundFood = null;
                    for (const [key, macros] of Object.entries(foodDatabase)) {
                        if (foodName.includes(key) || key.includes(foodName)) {
                            foundFood = { name: foodName, ...macros };
                            break;
                        }
                    }

                    if (foundFood) {
                        const multiplier = grams / 100;
                        totalProtein += foundFood.protein * multiplier;
                        totalCarb += foundFood.carb * multiplier;
                        totalFat += foundFood.fat * multiplier;
                        parsedFoods.push(`${grams}g de ${foodName}`);
                    }
                }
            });

            if (parsedFoods.length === 0) {
                alert('Nenhum alimento reconhecido! Use o formato: "300g de arroz"');
                return;
            }

            const calories = (totalProtein * 4) + (totalCarb * 4) + (totalFat * 9);

            document.getElementById('calcProtein').textContent = Math.round(totalProtein) + 'g';
            document.getElementById('calcCarb').textContent = Math.round(totalCarb) + 'g';
            document.getElementById('calcFat').textContent = Math.round(totalFat) + 'g';
            document.getElementById('calcCalories').textContent = Math.round(calories) + ' kcal';
            document.getElementById('mealCalculation').style.display = 'block';

            tempMealData = {
                protein: totalProtein,
                carb: totalCarb,
                fat: totalFat,
                foods: parsedFoods.join(', ')
            };
        }

        function confirmMeal() {
            if (!tempMealData) return;

            const meal = {
                type: document.getElementById('mealType').value,
                protein: Math.round(tempMealData.protein),
                carb: Math.round(tempMealData.carb),
                fat: Math.round(tempMealData.fat),
                notes: tempMealData.foods,
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})
            };

            data.meals.push(meal);
            saveData();
            renderMeals();
            updateDashboard();

            document.getElementById('mealFoods').value = '';
            document.getElementById('mealCalculation').style.display = 'none';
            tempMealData = null;

            alert('Refei√ß√£o salva! üçΩÔ∏è');
        }

        function cancelMealCalculation() {
            document.getElementById('mealCalculation').style.display = 'none';
            tempMealData = null;
        }

        function renderMeals() {
            const today = new Date().toISOString().split('T')[0];
            const todayMeals = data.meals.filter(m => m.date === today);
            const list = document.getElementById('mealList');

            if (todayMeals.length === 0) {
                list.innerHTML = '<div class="empty-state">Nenhuma refei√ß√£o registrada hoje</div>';
                return;
            }

            list.innerHTML = todayMeals.map((m, i) => {
                const mealIndex = data.meals.findIndex(meal => 
                    meal.date === m.date && 
                    meal.time === m.time && 
                    meal.type === m.type
                );
                return `
                    <div class="log-entry">
                        <div class="log-date">${m.time} - ${m.type}</div>
                        <div class="log-content">
                            P: ${Math.round(m.protein)}g | C: ${Math.round(m.carb)}g | G: ${Math.round(m.fat)}g
                            ${m.notes ? '<br>' + m.notes : ''}
                        </div>
                        <button class="btn btn-delete" onclick="deleteMeal(${mealIndex})">Deletar</button>
                    </div>
                `;
            }).join('');
        }

        function deleteMeal(index) {
            if (index >= 0 && index < data.meals.length) {
                data.meals.splice(index, 1);
                saveData();
                renderMeals();
                updateDashboard();
            }
        }

        function clearTodayMeals() {
            if (confirm('Limpar todas as refei√ß√µes de hoje?')) {
                const today = new Date().toISOString().split('T')[0];
                data.meals = data.meals.filter(m => m.date !== today);
                saveData();
                renderMeals();
                updateDashboard();
            }
        }

        // Measurements
        function addMeasurement() {
            const measurement = {
                date: document.getElementById('measureDate').value,
                weight: parseFloat(document.getElementById('measureWeight').value),
                waist: parseFloat(document.getElementById('measureWaist').value),
                performance: document.getElementById('measurePerformance').value
            };

            if (!measurement.date || !measurement.weight) {
                alert('Preencha pelo menos data e peso!');
                return;
            }

            data.measurements.push(measurement);
            saveData();
            renderMeasurements();
            updateDashboard();

            document.getElementById('measureWeight').value = '';
            document.getElementById('measureWaist').value = '';
        }

        function renderMeasurements() {
            const list = document.getElementById('measurementList');
            if (data.measurements.length === 0) {
                list.innerHTML = '<div class="empty-state">Nenhuma medida registrada</div>';
                return;
            }

            const sorted = [...data.measurements].sort((a, b) => new Date(b.date) - new Date(a.date));
            list.innerHTML = sorted.map((m, i) => {
                const perfEmoji = m.performance === 'forte' ? 'üí™' : m.performance === 'mantendo' ? '‚úÖ' : '‚ö†Ô∏è';
                return `
                    <div class="log-entry">
                        <div class="log-date">${new Date(m.date).toLocaleDateString('pt-BR')}</div>
                        <div class="log-content">
                            Peso: ${m.weight}kg ${m.waist ? `| Cintura: ${m.waist}cm` : ''}<br>
                            Status: ${perfEmoji} ${m.performance}
                        </div>
                        <button class="btn btn-delete" onclick="deleteMeasurement(${i})">Deletar</button>
                    </div>
                `;
            }).join('');
        }

        function deleteMeasurement(index) {
            data.measurements.splice(index, 1);
            saveData();
            renderMeasurements();
            updateDashboard();
        }

        
        // ===== ROTINA EDIT√ÅVEL (base do Logbook) =====
        function normalizeDayLabel(label) {
            const raw = (label || '').trim().replace(/^Ôªø/, '').replace(/:$/, '').replace(/\s+/g, ' ');
            const first = raw.split(/\s*[-‚Äî]\s*/)[0].trim();
            const key = first.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();

            const map = [
                { re: /^(dom|domingo)\b/, val: 'Domingo' },
                { re: /^(seg|segunda)\b/, val: 'Segunda' },
                { re: /^(ter|terca|ter√ßa)\b/, val: 'Ter√ßa' },
                { re: /^(qua|quarta)\b/, val: 'Quarta' },
                { re: /^(qui|quinta)\b/, val: 'Quinta' },
                { re: /^(sex|sexta)\b/, val: 'Sexta' },
                { re: /^(sab|sabado|s√°bado)\b/, val: 'S√°bado' }
            ];
            for (const m of map) if (m.re.test(key)) return m.val;
            return raw;
        }

        function getTodayLabel() {
            const d = new Date().getDay(); // 0=Dom ... 6=Sab
            const map = ['Domingo','Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado'];
            return map[d];
        }

        function parseRoutineText(text) {
            const lines = (text || '').split(/\r?\n/).map(l => l.trim()).filter(Boolean);
            const routine = {}; // { 'Segunda': ['Supino', ...] }
            let currentDay = null;

            for (const line of lines) {
                // Detect heading: "Segunda:" or "Segunda - T1" or "Seg - Torso"
                const normStart = line.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
                const looksLikeDay = /^(dom|domingo|seg|segunda|ter|terca|ter√ßa|qua|quarta|qui|quinta|sex|sexta|sab|sabado|s√°bado)\b/.test(normStart);

                const hasDash = /[-‚Äî]/.test(line);
                const isHeading = (/:$/.test(line) && looksLikeDay) || (looksLikeDay && hasDash);

                if (isHeading) {
                    currentDay = normalizeDayLabel(line);
                    if (!routine[currentDay]) routine[currentDay] = [];
                    continue;
                }

                // Exercise line: remove numbering "1." "1)" "-" etc
                if (!currentDay) continue;
                const cleaned = line
                    .replace(/^\d+\s*[\.|\)]\s*/, '')
                    .replace(/^[-‚Ä¢]\s*/, '')
                    .trim();
                if (cleaned) routine[currentDay].push(cleaned);
            }
            return routine;
        }

        function loadCustomRoutine() {
            const saved = localStorage.getItem('customRoutineText') || '';
            const ta = document.getElementById('customRoutine');
            if (ta) ta.value = saved;
            updateRoutinePreview();
            populateLogDaySelect();
            updateDiaryReferences();
        }

        function saveCustomRoutine() {
            const value = (document.getElementById('customRoutine')?.value || '').trim();
            localStorage.setItem('customRoutineText', value);
            const st = document.getElementById('routineStatus');
            if (st) st.textContent = 'Rotina salva ‚úÖ';
            updateRoutinePreview();
            populateLogDaySelect();
            initializeExercises(); // Logbook se adapta
            updateDiaryReferences();
        }

        function clearCustomRoutine() {
            if (!confirm('Apagar rotina salva?')) return;
            localStorage.removeItem('customRoutineText');
            const ta = document.getElementById('customRoutine');
            if (ta) ta.value = '';
            const st = document.getElementById('routineStatus');
            if (st) st.textContent = 'Rotina removida.';
            updateRoutinePreview();
            populateLogDaySelect();
            initializeExercises();
            updateDiaryReferences();
        }

        function updateRoutinePreview() {
            const box = document.getElementById('routinePreview');
            if (!box) return;
            const routineText = localStorage.getItem('customRoutineText') || '';
            if (!routineText.trim()) {
                box.innerHTML = '<div class="empty-state">Nenhuma rotina salva ainda.</div>';
                return;
            }
            const routine = parseRoutineText(routineText);
            const today = getTodayLabel();
            const todayList = routine[today] || [];
            const htmlList = todayList.length
                ? '<ul style="margin:0.5rem 0 0 1rem;">' + todayList.map(e => `<li>${e}</li>`).join('') + '</ul>'
                : '<div class="empty-state">Hoje (${today}) n√£o foi encontrado na sua rotina.</div>';

            box.innerHTML = `
                <div style="padding:1rem;background:var(--color-bg);border-radius:6px;border:1px solid rgba(255,255,255,0.1);">
                    <strong>üìÖ Hoje: ${today}</strong>
                    ${htmlList}
                </div>
            `;
        }

        // ===== DIETA EDIT√ÅVEL =====
        function loadCustomDiet() {
            const saved = localStorage.getItem('customDietText') || '';
            const ta = document.getElementById('customDiet');
            if (ta) ta.value = saved;

            // carregar metas nos inputs a partir do data.macros (que j√° existe no app)
            if (typeof data !== 'undefined' && data.macros) {
                document.getElementById('dietCalories').value = data.macros.calories ?? '';
                document.getElementById('dietProtein').value = data.macros.protein ?? '';
                document.getElementById('dietCarb').value = data.macros.carb ?? '';
                document.getElementById('dietFat').value = data.macros.fat ?? '';
            }
            updateDiaryReferences();
        }

        function saveDietMacros() {
            if (typeof data === 'undefined') return;
            data.macros = data.macros || {};
            data.macros.calories = parseInt(document.getElementById('dietCalories').value) || data.macros.calories || 0;
            data.macros.protein = parseInt(document.getElementById('dietProtein').value) || data.macros.protein || 0;
            data.macros.carb = parseInt(document.getElementById('dietCarb').value) || data.macros.carb || 0;
            data.macros.fat = parseInt(document.getElementById('dietFat').value) || data.macros.fat || 0;
            if (typeof saveData === 'function') saveData();
            const st = document.getElementById('dietStatus');
            if (st) st.textContent = 'Metas salvas ‚úÖ';
            if (typeof updateDashboard === 'function') updateDashboard();
            updateDiaryReferences();
        }

        function saveCustomDiet() {
            const value = (document.getElementById('customDiet')?.value || '').trim();
            localStorage.setItem('customDietText', value);
            const st = document.getElementById('dietStatus');
            if (st) st.textContent = 'Dieta salva ‚úÖ';
            updateDiaryReferences();
        }

        function clearCustomDiet() {
            if (!confirm('Apagar dieta salva?')) return;
            localStorage.removeItem('customDietText');
            const ta = document.getElementById('customDiet');
            if (ta) ta.value = '';
            const st = document.getElementById('dietStatus');
            if (st) st.textContent = 'Dieta removida.';
            updateDiaryReferences();
        }

        function updateDiaryReferences() {
            const box = document.getElementById('diaryReferences');
            if (!box) return;
            const name = localStorage.getItem('userName') || '';
            const routineText = localStorage.getItem('customRoutineText') || '';
            const dietText = localStorage.getItem('customDietText') || '';
            const today = getTodayLabel();
            const routine = parseRoutineText(routineText);
            const todayExercises = routine[today] || [];

            const macros = (typeof data !== 'undefined' && data.macros) ? data.macros : {};
            box.innerHTML = `
                <h3>üìå Suas Refer√™ncias</h3>
                ${name ? `<div style="margin-top:0.25rem;color:var(--color-text-muted);">Ol√°, <strong>${name}</strong> üëã</div>` : ''}
                <div style="margin-top:0.75rem;padding:0.75rem;background:var(--color-bg);border-radius:6px;border:1px solid rgba(255,255,255,0.1);">
                    <strong>üèãÔ∏è Treino de hoje (${today})</strong>
                    ${todayExercises.length ? `<ul style="margin:0.5rem 0 0 1rem;">${todayExercises.map(e=>`<li>${e}</li>`).join('')}</ul>` : `<div class="empty-state">Sem treino definido para hoje na rotina.</div>`}
                </div>
                <div style="margin-top:0.75rem;padding:0.75rem;background:var(--color-bg);border-radius:6px;border:1px solid rgba(255,255,255,0.1);">
                    <strong>üéØ Metas (Macros)</strong>
                    <div style="margin-top:0.5rem;color:var(--color-text-muted);font-size:0.9rem;line-height:1.6;">
                        Calorias: <strong>${macros.calories ?? '--'}</strong> kcal ¬∑
                        Prote√≠na: <strong>${macros.protein ?? '--'}</strong>g ¬∑
                        Carbo: <strong>${macros.carb ?? '--'}</strong>g ¬∑
                        Gordura: <strong>${macros.fat ?? '--'}</strong>g
                    </div>
                </div>
                <div style="margin-top:0.75rem;padding:0.75rem;background:var(--color-bg);border-radius:6px;border:1px solid rgba(255,255,255,0.1);">
                    <strong>ü•ó Dieta (texto)</strong>
                    <pre style="white-space:pre-wrap;margin-top:0.5rem;color:var(--color-text-muted);font-size:0.9rem;">${dietText || '‚Äî'}</pre>
                </div>
            `;
        }
        // ===== Repetir √∫ltimo treino do dia selecionado =====
        function copyLastWorkoutToInputs() {
            const day = (typeof getSelectedLogDay === 'function') ? getSelectedLogDay() : getTodayLabel();
            const workouts = (data.workouts || []).slice().sort((a,b) => new Date(b.date) - new Date(a.date));
            const last = workouts.find(w => workoutDayFromDateStr(w.date) === day);
            if (!last) {
                alert('N√£o encontrei treino anterior para esse dia ainda.');
                return;
            }

            // Ensure same exercise list loaded (based on routine)
            initializeExercises();

            // Fill fields matching by order/name
            const currentNames = [];
            for (let i=1; i<= (exerciseCount||0); i++) {
                const container = document.getElementById(`exercise-${i}`);
                const title = container?.querySelector('div[style*="font-weight:600"]');
                if (!title) continue;
                currentNames.push(title.textContent.trim());
            }

            (last.exercises || []).forEach((ex, idx) => {
                const i = idx + 1;
                // fill by index
                const kg = document.getElementById(`ex-kg-${i}`);
                const reps = document.getElementById(`ex-reps-${i}`);
                const rir = document.getElementById(`ex-rir-${i}`);
                const tp = document.getElementById(`ex-type-${i}`);

                if (kg) kg.value = ex.kg ?? '';
                if (reps) reps.value = ex.reps ?? '';
                if (rir) rir.value = (ex.rir ?? '');
                if (tp) tp.value = ex.setType || 'normal';
            });

            // notes/day type
            const notes = document.getElementById('sessionNotes');
            if (notes) notes.value = last.notes || '';
            const dt = document.getElementById('workoutDayType');
            if (dt) dt.value = last.dayType || 'normal';

            annotateExerciseInputsWithLast();
                updateExerciseBadgesAndSuggestions();
                wireAutoRestTimer();
            alert('Carreguei o √∫ltimo treino desse dia. Ajuste e salve novamente üí™');
        }
        // ====================================================

        // ============================================

        // ===== LOGBOOK: Sele√ß√£o de dia (estilo HEVY) =====
        function getRoutineObject() {
            const routineText = localStorage.getItem('customRoutineText') || '';
            return parseRoutineText(routineText);
        }

        function populateLogDaySelect() {
            const sel = document.getElementById('logDaySelect');
            if (!sel) return;

            const routine = getRoutineObject();
            const today = getTodayLabel();
            const prev = sel.value || '';

            sel.innerHTML = '';

            const optHoje = document.createElement('option');
            optHoje.value = '__TODAY__';
            optHoje.textContent = `Hoje (${today})`;
            sel.appendChild(optHoje);

            const order = ['Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado','Domingo'];
            const days = Object.keys(routine);
            days.sort((a,b) => order.indexOf(a) - order.indexOf(b));

            days.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d;
                opt.textContent = d;
                sel.appendChild(opt);
            });

            if (prev && Array.from(sel.options).some(o => o.value === prev)) {
                sel.value = prev;
            } else {
                sel.value = '__TODAY__';
            }
        }

        function getSelectedLogDay() {
            const sel = document.getElementById('logDaySelect');
            if (!sel) return getTodayLabel();
            if (sel.value === '__TODAY__') return getTodayLabel();
            return sel.value;
        }

        function onLogDayChange() {
            initializeExercises();
            updateRoutinePreview();
            updateDiaryReferences();
        }
        // ===============================================

        // ===== INSIGHTS (Samuel-style) =====
        function startOfDay(d) {
            const x = new Date(d);
            x.setHours(0,0,0,0);
            return x;
        }

        function getPastDaysRange(days) {
            const end = startOfDay(new Date());
            const start = new Date(end);
            start.setDate(start.getDate() - (days - 1));
            return { start, end };
        }

        function getRoutineDaysList() {
            const routine = getRoutineObject();
            const days = Object.keys(routine);
            const order = ['Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado','Domingo'];
            days.sort((a,b) => order.indexOf(a) - order.indexOf(b));
            return days;
        }

        function workoutDayFromDateStr(dateStr) {
            const d = new Date(dateStr);
            const map = ['Domingo','Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado'];
            return map[d.getDay()];
        }

        function isPR(exName, entry, histIndex) {
            // PR: highest kg for this exercise across all history
            const entries = histIndex[exName] || [];
            if (!entries.length) return false;
            let best = entries[0];
            entries.forEach(e => { if (e.kg > best.kg) best = e; });
            // entry is PR if it matches best and date matches
            return (best.kg === entry.kg && best.reps === entry.reps && best.date === entry.date);
        }

        function getPRFeedLast7Days() {
            const feed = [];
            if (!data || !Array.isArray(data.workouts)) return feed;

            const histIndex = buildExerciseHistoryIndex();
            const { start } = getPastDaysRange(7);

            data.workouts.forEach(w => {
                if (!w?.exercises?.length) return;
                const wd = startOfDay(new Date(w.date));
                if (wd < start) return;
                w.exercises.forEach(ex => {
                    if (!ex?.name) return;
                    const name = ex.name.trim();
                    const entry = {date: w.date, kg: ex.kg||0, reps: ex.reps||0};
                    if (isPR(name, entry, histIndex)) {
                        feed.push({
                            date: w.date,
                            name,
                            kg: ex.kg||0,
                            reps: ex.reps||0,
                            rir: (ex.rir ?? null),
                            setType: ex.setType || 'normal'
                        });
                    }
                });
            });

            feed.sort((a,b) => new Date(b.date) - new Date(a.date));
            return feed.slice(0, 20);
        }

        function computeWeeklyInsights() {
            const wkSessionsEl = document.getElementById('wkSessions');
            const wkAdherenceEl = document.getElementById('wkAdherence');
            const wkVolumeEl = document.getElementById('wkVolume');
            const wkPRsEl = document.getElementById('wkPRs');
            const prFeedEl = document.getElementById('prFeed');
            const checklistEl = document.getElementById('weekChecklist');

            if (!wkSessionsEl || !wkAdherenceEl || !wkVolumeEl || !wkPRsEl || !prFeedEl || !checklistEl) return;

            const { start } = getPastDaysRange(7);
            const routineDays = getRoutineDaysList();

            // sessions + volume
            let sessions = 0;
            let volume = 0;
            const doneDays = new Set(); // day labels completed this week based on workout dates
            (data.workouts || []).forEach(w => {
                const wd = startOfDay(new Date(w.date));
                if (wd < start) return;
                sessions += 1;
                doneDays.add(workoutDayFromDateStr(w.date));
                (w.exercises || []).forEach(ex => { volume += (ex.kg||0) * (ex.reps||0); });
            });

            const possible = Math.max(1, routineDays.length);
            const adherence = Math.round((doneDays.size / possible) * 100);

            // PRs feed
            const prFeed = getPRFeedLast7Days();
            wkSessionsEl.textContent = sessions;
            wkVolumeEl.textContent = Math.round(volume).toLocaleString('pt-BR');
            wkPRsEl.textContent = prFeed.length;
            const streakEl = document.getElementById('wkStreak');
            if (streakEl) streakEl.textContent = calculateStreak80();
            wkAdherenceEl.textContent = `${adherence}%`;

            if (!prFeed.length) {
                prFeedEl.innerHTML = '<div class="empty-state">Nenhum PR nos √∫ltimos 7 dias. (Isso √© normal ‚Äî mantenha consist√™ncia.)</div>';
            } else {
                prFeedEl.innerHTML = prFeed.map(p => {
                    const rir = (p.rir !== null && p.rir !== undefined) ? ` | RIR ${p.rir}` : '';
                    const type = p.setType === 'top' ? ' ‚Ä¢ Top' : p.setType === 'backoff' ? ' ‚Ä¢ Back-off' : p.setType === 'feeder' ? ' ‚Ä¢ Feeder' : p.setType === 'warmup' ? ' ‚Ä¢ Aquecimento' : p.setType === 'normal' ? ' ‚Ä¢ Work' : '';
                    return `<div class="log-entry">
                        <div class="log-date">${new Date(p.date).toLocaleDateString('pt-BR')}</div>
                        <div class="log-content">üî• <strong>${p.name}</strong>${type}: ${p.kg}kg x ${p.reps}${rir}</div>
                    </div>`;
                }).join('');
            }

            // Checklist
            const order = ['Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado','Domingo'];
            checklistEl.innerHTML = '';
            routineDays.sort((a,b) => order.indexOf(a) - order.indexOf(b));
            routineDays.forEach(d => {
                const done = doneDays.has(d);
                const row = document.createElement('div');
                row.className = 'log-entry';
                row.innerHTML = `
                    <div class="log-date">${done ? '‚úÖ' : '‚¨ú'}</div>
                    <div class="log-content"><strong>${d}</strong> ${done ? '<span style="color:var(--color-primary);">conclu√≠do</span>' : '<span style="color:var(--color-text-muted);">pendente</span>'}</div>
                `;
                checklistEl.appendChild(row);
            });
        }
        // ==================================
=

        
        // ===== LOGBOOK: Rest timer por exerc√≠cio (HEVY-inspired) =====
        const restTimers = {}; // key: exerciseIndex -> { endMs, intervalId }

        function getRestDurationMs() {
            const sec = parseInt(document.getElementById('restDurationSec')?.value) || 120;
            return Math.max(10, sec) * 1000;
        }

        function formatCountdown(ms) {
            const total = Math.max(0, Math.ceil(ms / 1000));
            const m = String(Math.floor(total / 60)).padStart(2,'0');
            const s = String(total % 60).padStart(2,'0');
            return `${m}:${s}`;
        }

        function startRestTimer(i) {
            const display = document.getElementById(`ex-rest-display-${i}`);
            if (!display) return;

            // clear previous
            if (restTimers[i]?.intervalId) clearInterval(restTimers[i].intervalId);

            const endMs = Date.now() + getRestDurationMs();
            restTimers[i] = { endMs, intervalId: null };

            display.textContent = formatCountdown(endMs - Date.now());
            display.style.color = 'var(--color-primary)';

            restTimers[i].intervalId = setInterval(() => {
                const left = restTimers[i].endMs - Date.now();
                if (left <= 0) {
                    clearInterval(restTimers[i].intervalId);
                    restTimers[i].intervalId = null;
                    display.textContent = '00:00';
                    display.style.color = 'var(--color-warning)';

                    // micro feedback (sem som for√ßado)
                    try { if (navigator.vibrate) navigator.vibrate([80, 40, 80]); } catch (e) {}
                    return;
                }
                display.textContent = formatCountdown(left);
            }, 250);
        }
        // ============================================================

// ===== LOGBOOK: Timer de treino (estilo HEVY) =====
        let workoutTimer = {
            running: false,
            startMs: null,
            elapsedMs: 0,
            intervalId: null
        };

        function formatMs(ms) {
            const total = Math.max(0, Math.floor(ms / 1000));
            const h = String(Math.floor(total / 3600)).padStart(2,'0');
            const m = String(Math.floor((total % 3600) / 60)).padStart(2,'0');
            const s = String(total % 60).padStart(2,'0');
            return `${h}:${m}:${s}`;
        }

        function getCurrentElapsedMs() {
            return workoutTimer.elapsedMs + (workoutTimer.running ? (Date.now() - workoutTimer.startMs) : 0);
        }

        function renderWorkoutTimer() {
            const el = document.getElementById('workoutTimerDisplay');
            if (el) el.textContent = formatMs(getCurrentElapsedMs());

            const startBtn = document.getElementById('timerStartBtn');
            const pauseBtn = document.getElementById('timerPauseBtn');
            const resetBtn = document.getElementById('timerResetBtn');

            if (startBtn && pauseBtn && resetBtn) {
                // Start is only for the very first start (like HEVY). After pause, use Retomar.
                const hasAny = getCurrentElapsedMs() > 0;
                startBtn.disabled = hasAny;
                pauseBtn.disabled = !hasAny;
                resetBtn.disabled = workoutTimer.running || !hasAny;

                pauseBtn.textContent = workoutTimer.running ? 'Pausar' : 'Retomar';
            }
        }

        function startWorkoutTimer() {
            if (getCurrentElapsedMs() > 0) return; // already started
            workoutTimer.running = true;
            workoutTimer.startMs = Date.now();
            workoutTimer.elapsedMs = 0;

            if (workoutTimer.intervalId) clearInterval(workoutTimer.intervalId);
            workoutTimer.intervalId = setInterval(renderWorkoutTimer, 250);
            renderWorkoutTimer();
        }

        function toggleWorkoutTimer() {
            const hasAny = getCurrentElapsedMs() > 0;
            if (!hasAny) return;

            if (workoutTimer.running) {
                // pause
                workoutTimer.elapsedMs = getCurrentElapsedMs();
                workoutTimer.running = false;
                workoutTimer.startMs = null;
                renderWorkoutTimer();
                return;
            }

            // resume
            workoutTimer.running = true;
            workoutTimer.startMs = Date.now();
            if (workoutTimer.intervalId) clearInterval(workoutTimer.intervalId);
            workoutTimer.intervalId = setInterval(renderWorkoutTimer, 250);
            renderWorkoutTimer();
        }

        function resetWorkoutTimer() {
            if (workoutTimer.running) return;
            workoutTimer.running = false;
            workoutTimer.startMs = null;
            workoutTimer.elapsedMs = 0;
            if (workoutTimer.intervalId) clearInterval(workoutTimer.intervalId);
            workoutTimer.intervalId = null;
            renderWorkoutTimer();
        }
        // ================================================


        // Workout templates
        const workoutTemplates = {
            'T1': [
                'Pull over',
                'Supino declinado m√°quina',
                'Remada neutra',
                'Desenvolvimento m√°quina',
                'Puxada aberta',
                'Eleva√ß√£o lateral polia',
                'Abd√¥men m√°quina'
            ],
            'L1': [
                'Tr√≠ceps pushdown',
                'Rosca polia',
                'Mesa flexora',
                'Cadeira adutora',
                'Hack squat',
                'Stiff',
                'Cadeira extensora uni',
                'Panturrilha uni'
            ],
            'T2': [
                'High row uni',
                'Supino inclinado m√°quina',
                'Remada T bar',
                'Voador',
                'Eleva√ß√£o lateral polia',
                'Abd√¥men m√°quina'
            ],
            'L2': [
                'Rosca Scott',
                'Tr√≠ceps franc√™s',
                'Cadeira flexora',
                'Leg press',
                'Eleva√ß√£o p√©lvica',
                'Cadeira extensora uni',
                'Panturrilha uni'
            ],
            'T3': [
                'Supino declinado',
                'Remada T-bar',
                'Fly inclinado',
                'High row uni',
                'Eleva√ß√£o lateral polia',
                'Remada uni'
            ]
        };

        // Auto-detect workout based on day
        function detectWorkout() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0=Dom, 1=Seg, 2=Ter, 3=Qua, 4=Qui, 5=Sex, 6=Sab
            
            const workoutMap = {
                1: 'T1',
                2: 'L1', 
                3: 'T2',
                4: 'L2',
                5: 'T3',
                0: 'Descanso',
                6: 'Descanso'
            };
            
            return workoutMap[dayOfWeek] || 'Descanso';
        }

        // Workouts
        function addWorkout() {
            const today = new Date().toISOString().split('T')[0];
            const workoutType = document.getElementById('autoWorkoutName').value;
            const template = workoutTemplates[workoutType];
            
            if (!template) {
                alert('Dia de descanso! N√£o h√° treino para registrar.');
                return;
            }
            
            const exercises = [];
            
            for (let i = 1; i <= exerciseCount; i++) {
                const kgElem = document.getElementById(`ex-kg-${i}`);
                const repsElem = document.getElementById(`ex-reps-${i}`);
                const rpeElem = document.getElementById(`ex-rir-${i}`);
                
                if (!kgElem || !repsElem || !rirElem) continue;
                
                const kg = parseFloat(kgElem.value) || 0;
                const reps = parseInt(repsElem.value) || 0;
                const rir = parseInt(rirElem.value) || 0;
                const name = template[i - 1];
                const setType = exTypeElem ? exTypeElem.value : 'normal';
                
                if (kg > 0 && reps > 0) {
                    exercises.push({ name, kg, reps, rir, setType });
                }
            }

            if (exercises.length === 0) {
                alert('Preencha pelo menos um exerc√≠cio com carga e reps!');
                return;
            }

            const workout = {
                date: today,
                name: workoutType,
                dayType: (document.getElementById('workoutDayType')?.value || 'normal'),
                notes: (document.getElementById('sessionNotes')?.value || '').trim(),
                durationMs: (typeof getCurrentElapsedMs === 'function') ? getCurrentElapsedMs() : 0,
                exercises: exercises,
                notes: document.getElementById('workoutNotes').value.trim()
            };

            data.workouts.push(workout);
            saveData();
            renderWorkouts();
            initializeExercises();
            document.getElementById('workoutNotes').value = '';
            resetWorkoutTimer();
            populateExerciseSelect();
            renderExerciseHistory();
            computeWeeklyInsights();
            const prs = detectPRsForWorkout(workout);
            showPRToast(prs);
            alert('Treino salvo! üí™');
        }

        function renderWorkouts() {
            const list = document.getElementById('workoutList');
            if (data.workouts.length === 0) {
                list.innerHTML = '<div class="empty-state">Nenhum treino registrado</div>';
                return;
            }

            const sorted = [...data.workouts].sort((a, b) => new Date(b.date) - new Date(a.date));
            list.innerHTML = sorted.map((w, i) => {
                let content = '';
                if (w.exercises) {
                    const volume = calculateWorkoutVolume(w);
                    content = w.exercises.map(ex => {
                        const rirText = (ex.rir !== undefined && ex.rir !== null) ? ` | RIR ${ex.rir}` : '';
                        return `${ex.name}: ${ex.kg}kg x ${ex.reps}${rirText}`;
                    }).join('<br>');
                    content += `<br><strong>Volume Total: ${volume.toFixed(0)} kg</strong>`;
                    if (w.dayType && w.dayType !== 'normal') {
                        const label = w.dayType === 'deload' ? 'Deload' : w.dayType === 'test' ? 'Teste/PR' : w.dayType;
                        content += `<br><strong>Tipo:</strong> ${label}`;
                    }
                    if (w.notes) {
                        content += `<br><strong>Notas:</strong> ${w.notes.replace(/</g,'&lt;').replace(/>/g,'&gt;')}`;
                    }
                    if (w.durationMs) {
                        const dur = formatMs(w.durationMs);
                        content += `<br><strong>Dura√ß√£o:</strong> ${dur}`;
                    }
                    if (w.notes) {
                        content += `<br><br><em style="color:var(--color-text-muted);">Obs: ${w.notes}</em>`;
                    }
                } else {
                    content = w.notes ? w.notes.replace(/\n/g, '<br>') : 'Sem detalhes';
                }
                
                return `
                    <div class="workout-log">
                        <div class="workout-header">
                            <span class="workout-name">${w.name}</span>
                            <span class="workout-date">${new Date(w.date).toLocaleDateString('pt-BR')}</span>
                        </div>
                        <div class="exercise-entry">${content}</div>
                        <button class="btn btn-delete" onclick="deleteWorkout(${i})">Deletar</button>
                    </div>
                `;
            }).join('');
        }

        // ===== HIST√ìRICO POR EXERC√çCIO (estilo HEVY) =====
        function buildExerciseHistoryIndex() {
            const idx = {}; // name -> [{date, kg, reps, rir, workoutName}]
            if (!data || !Array.isArray(data.workouts)) return idx;

            data.workouts.forEach(w => {
                if (!w || !w.exercises) return;
                w.exercises.forEach(ex => {
                    if (!ex || !ex.name) return;
                    const name = ex.name.trim();
                    if (!idx[name]) idx[name] = [];
                    idx[name].push({
                        date: w.date,
                        workoutName: w.name,
                        kg: ex.kg || 0,
                        reps: ex.reps || 0,
                        rir: (ex.rir !== undefined && ex.rir !== null) ? ex.rir : null,
                        setType: ex.setType || 'normal'
                    });
                });
            });

            // sort desc by date
            Object.keys(idx).forEach(k => {
                idx[k].sort((a,b) => new Date(b.date) - new Date(a.date));
            });
            return idx;
        }

        function populateExerciseSelect() {
            const sel = document.getElementById('exerciseSelect');
            if (!sel) return;
            const hist = buildExerciseHistoryIndex();
            const names = Object.keys(hist).sort((a,b) => a.localeCompare(b, 'pt-BR'));

            const prev = sel.value || '';
            sel.innerHTML = '';
            names.forEach(n => {
                const opt = document.createElement('option');
                opt.value = n;
                opt.textContent = n;
                sel.appendChild(opt);
            });

            if (prev && names.includes(prev)) sel.value = prev;
        }

        function filterExerciseOptions() {
            const sel = document.getElementById('exerciseSelect');
            const q = (document.getElementById('exerciseSearch')?.value || '').trim().toLowerCase();
            if (!sel) return;

            populateExerciseSelect();
            if (!q) return;

            Array.from(sel.options).forEach(opt => {
                const show = opt.value.toLowerCase().includes(q);
                opt.hidden = !show;
            });

            // pick first visible
            const first = Array.from(sel.options).find(o => !o.hidden);
            if (first) sel.value = first.value;
            renderExerciseHistory();
        }

        function calcE1RM(kg, reps) {
            // Epley formula
            if (!kg || !reps) return 0;
            return kg * (1 + reps / 30);
        }

        function renderExerciseHistory() {
            const panel = document.getElementById('exerciseHistoryPanel');
            const sel = document.getElementById('exerciseSelect');
            if (!panel || !sel) return;

            const name = sel.value;
            const hist = buildExerciseHistoryIndex();
            const entries = hist[name] || [];

            if (!name || entries.length === 0) {
                panel.innerHTML = '<div class="empty-state">Sem hist√≥rico para este exerc√≠cio ainda.</div>';
                return;
            }

            const last10 = entries.slice(0, 10);

            // PRs
            let prKg = last10[0];
            let bestE1 = {e1: 0, e: null};
            entries.forEach(e => {
                if (!prKg || e.kg > prKg.kg) prKg = e;
                const e1 = calcE1RM(e.kg, e.reps);
                if (e1 > bestE1.e1) bestE1 = {e1, e};
            });

            const prLine = prKg ? `${prKg.kg}kg x ${prKg.reps}${(prKg.rir!==null)?` | RIR ${prKg.rir}`:''} (${new Date(prKg.date).toLocaleDateString('pt-BR')})` : '--';
            const e1Line = bestE1.e ? `${bestE1.e.kg}kg x ${bestE1.e.reps} ‚âà ${bestE1.e1.toFixed(1)}kg (${new Date(bestE1.e.date).toLocaleDateString('pt-BR')})` : '--';

            const rows = last10.map(e => {
                const rir = (e.rir!==null)?` | RIR ${e.rir}`:'';
                const type = e.setType === 'top' ? ' ‚Ä¢ Top set' : e.setType === 'backoff' ? ' ‚Ä¢ Back-off' : e.setType === 'feeder' ? ' ‚Ä¢ Feeder' : e.setType === 'warmup' ? ' ‚Ä¢ Aquecimento' : e.setType === 'normal' ? ' ‚Ä¢ Work' : '';
                return `<div class="log-entry">
                            <div class="log-date">${new Date(e.date).toLocaleDateString('pt-BR')}</div>
                            <div class="log-content">
                                ${e.kg}kg x ${e.reps}${rir}${type}
                                <div style="font-size:0.75rem;color:var(--color-text-muted);margin-top:0.25rem;">Sess√£o: ${e.workoutName}</div>
                            </div>
                        </div>`;
            }).join('');

            panel.innerHTML = `
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin-bottom:0.75rem;">
                    <div class="stat-card">
                        <div class="stat-label">PR de Carga</div>
                        <div style="font-weight:700;margin-top:0.25rem;">${prLine}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Melhor e1RM (estimado)</div>
                        <div style="font-weight:700;margin-top:0.25rem;">${e1Line}</div>
                    </div>
                </div>
                ${rows}
            `;
        }

        // Mostra "√∫ltima performance" em cada exerc√≠cio do Logbook
        function getLastEntryForExercise(exName) {
            const hist = buildExerciseHistoryIndex();
            const entries = hist[exName] || [];
            return entries[0] || null;
        }

        function annotateExerciseInputsWithLast() {
            // percorre os blocos atuais do log
            for (let i = 1; i <= (exerciseCount || 0); i++) {
                const container = document.getElementById(`exercise-${i}`);
                if (!container) continue;
                const title = container.querySelector('div[style*="font-weight:600"]');
                if (!title) continue;
                const name = title.textContent.trim();
                const last = getLastEntryForExercise(name);

                // remove badge anterior
                const old = container.querySelector('.last-badge');
                if (old) old.remove();

                if (!last) continue;
                const rir = (last.rir!==null)?` | RIR ${last.rir}`:'';
                const type = last.setType === 'top' ? ' ‚Ä¢ Top set' : last.setType === 'backoff' ? ' ‚Ä¢ Back-off' : last.setType === 'feeder' ? ' ‚Ä¢ Feeder' : last.setType === 'warmup' ? ' ‚Ä¢ Aquecimento' : last.setType === 'normal' ? ' ‚Ä¢ Work' : '';
                const badge = document.createElement('div');
                badge.className = 'last-badge';
                badge.style.cssText = "margin-top:0.5rem;font-size:0.75rem;color:var(--color-text-muted);";
                badge.innerHTML = `√öltimo: <strong>${last.kg}kg x ${last.reps}${rir}${type}</strong> (${new Date(last.date).toLocaleDateString('pt-BR')})`;
                container.appendChild(badge);
            }
        }
        // ===============================================

        function calculateWorkoutVolume(workout) {
            if (!workout.exercises) return 0;
            return workout.exercises.reduce((sum, ex) => {
                const sets = ex.sets || 1;
                return sum + (ex.kg * ex.reps * sets);
            }, 0);
        }

        function deleteWorkout(index) {
            data.workouts.splice(index, 1);
            saveData();
            renderWorkouts();
        }

        // Dashboard
        function updateDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const todayMeals = data.meals.filter(m => m.date === today);
            
            const totalProtein = todayMeals.reduce((sum, m) => sum + m.protein, 0);
            const totalCarb = todayMeals.reduce((sum, m) => sum + m.carb, 0);
            const totalFat = todayMeals.reduce((sum, m) => sum + m.fat, 0);

            document.getElementById('proteinToday').textContent = `${Math.round(totalProtein)}g / ${data.macros.protein}g`;
            document.getElementById('carbToday').textContent = `${Math.round(totalCarb)}g / ${data.macros.carb}g`;
            document.getElementById('fatToday').textContent = `${Math.round(totalFat)}g / ${data.macros.fat}g`;

            document.getElementById('proteinBar').style.width = Math.min(100, (totalProtein / data.macros.protein) * 100) + '%';
            document.getElementById('carbBar').style.width = Math.min(100, (totalCarb / data.macros.carb) * 100) + '%';
            document.getElementById('fatBar').style.width = Math.min(100, (totalFat / data.macros.fat) * 100) + '%';

            if (data.measurements.length > 0) {
                const latest = data.measurements[data.measurements.length - 1];
                document.getElementById('currentWeight').textContent = latest.weight + 'kg';
                document.getElementById('currentWaist').textContent = latest.waist ? latest.waist + 'cm' : '--';
                
                const perfEmoji = latest.performance === 'forte' ? 'üí™' : latest.performance === 'mantendo' ? '‚úÖ' : '‚ö†Ô∏è';
                document.getElementById('statusEmoji').textContent = perfEmoji;
            }
        }

        // Photo progress functions
        function addPhotoProgress() {
            const photoFile = document.getElementById('photoFile').files[0];
            const photoUrl = document.getElementById('photoUrl').value.trim();
            
            if (!photoFile && !photoUrl) {
                alert('Anexe uma foto ou cole um link!');
                return;
            }
            
            const date = document.getElementById('photoDate').value;
            const weight = parseFloat(document.getElementById('photoWeight').value);
            const bf = parseFloat(document.getElementById('photoBf').value) || null;
            const notes = document.getElementById('photoNotes').value.trim();
            
            if (!date || !weight) {
                alert('Preencha data e peso!');
                return;
            }
            
            if (photoFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photo = {
                        date: date,
                        weight: weight,
                        url: e.target.result,
                        bf: bf,
                        notes: notes
                    };
                    data.photos.push(photo);
                    saveData();
                    renderPhotoTimeline();
                    clearPhotoForm();
                    alert('Foto salva! üì∏');
                };
                reader.readAsDataURL(photoFile);
            } else {
                const photo = {
                    date: date,
                    weight: weight,
                    url: photoUrl,
                    bf: bf,
                    notes: notes
                };
                data.photos.push(photo);
                saveData();
                renderPhotoTimeline();
                clearPhotoForm();
                alert('Foto salva! üì∏');
            }
        }
        
        function clearPhotoForm() {
            document.getElementById('photoFile').value = '';
            document.getElementById('photoWeight').value = '';
            document.getElementById('photoUrl').value = '';
            document.getElementById('photoBf').value = '';
            document.getElementById('photoNotes').value = '';

        }

        function renderPhotoTimeline() {
            const list = document.getElementById('photoTimeline');
            if (data.photos.length === 0) {
                list.innerHTML = '<div class="empty-state">Nenhuma foto registrada ainda.<br>Comece hoje! üí™</div>';
                return;
            }

            const sorted = [...data.photos].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            list.innerHTML = sorted.map((p, i) => {
                const bfText = p.bf ? `<strong>BF% Estimado:</strong> ${p.bf}%<br>` : '';
                const notesText = p.notes ? `<br><em style="color:var(--color-text-muted);">Obs: ${p.notes}</em>` : '';
                
                return `
                    <div class="workout-log" style="margin-bottom:1.5rem;">
                        <div class="workout-header">
                            <span class="workout-name">${new Date(p.date).toLocaleDateString('pt-BR')}</span>
                            <span class="workout-date">Peso: ${p.weight}kg</span>
                        </div>
                        <img src="${p.url}" style="width:100%;max-width:400px;border-radius:8px;margin:0.75rem 0;display:block;" onerror="this.style.display='none';this.nextElementSibling.style.display='block';">
                        <div style="display:none;padding:1rem;background:var(--color-surface);border-radius:6px;text-align:center;color:var(--color-text-muted);">
                            ‚ö†Ô∏è Erro ao carregar imagem<br>
                            <a href="${p.url}" target="_blank" style="color:var(--color-primary);font-size:0.875rem;">Abrir link</a>
                        </div>
                        <div class="exercise-entry">
                            ${bfText}
                            ${notesText}
                        </div>
                        <button class="btn btn-delete" onclick="deletePhoto(${i})">Deletar</button>
                    </div>
                `;
            }).join('');
        }

        function deletePhoto(index) {
            if (confirm('Deletar esta foto?')) {
                data.photos.splice(index, 1);
                saveData();
                renderPhotoTimeline();
            }
        }

        // Refeed Functions
        function updateRefeedCalculator() {
            const weight = data.measurements.length > 0 ? 
                data.measurements[data.measurements.length - 1].weight : 86;
            
            const protein = data.macros.protein;
            const carb = Math.round(weight * 6);
            const fat = Math.round(data.macros.fat * 0.5);
            const calories = (protein * 4) + (carb * 4) + (fat * 9);
            
            document.getElementById('refeedProtein').textContent = protein + 'g';
            document.getElementById('refeedCarb').textContent = carb + 'g';
            document.getElementById('refeedFat').textContent = fat + 'g';
            document.getElementById('refeedCals').textContent = calories + ' kcal';
        }

        function addRefeed() {
            const refeed = {
                date: document.getElementById('refeedDate').value,
                weight: parseFloat(document.getElementById('refeedWeight').value),
                feeling: document.getElementById('refeedFeeling').value,
                notes: document.getElementById('refeedNotes').value.trim(),
                protein: parseInt(document.getElementById('refeedProtein').textContent),
                carb: parseInt(document.getElementById('refeedCarb').textContent),
                fat: parseInt(document.getElementById('refeedFat').textContent),
                calories: parseInt(document.getElementById('refeedCals').textContent)
            };

            if (!refeed.date || !refeed.weight) {
                alert('Preencha data e peso!');
                return;
            }

            data.refeeds.push(refeed);
            saveData();
            renderRefeeds();

            document.getElementById('refeedWeight').value = '';
            document.getElementById('refeedNotes').value = '';
            alert('Refeed registrado! üî• Volta pro d√©ficit amanh√£!');
        }

        function renderRefeeds() {
            const list = document.getElementById('refeedList');
            if (data.refeeds.length === 0) {
                list.innerHTML = '<div class="empty-state">Nenhum refeed registrado ainda</div>';
                return;
            }

            const sorted = [...data.refeeds].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            list.innerHTML = sorted.map((r, i) => {
                const feelingEmoji = {
                    'otimo': 'üî•',
                    'bom': '‚úÖ',
                    'normal': '‚û°Ô∏è',
                    'ruim': '‚ö†Ô∏è'
                }[r.feeling] || '‚û°Ô∏è';
                
                const feelingText = {
                    'otimo': '√ìtimo',
                    'bom': 'Bom',
                    'normal': 'Normal',
                    'ruim': 'Ruim'
                }[r.feeling] || 'Normal';
                
                return `
                    <div class="log-entry">
                        <div class="log-date">${new Date(r.date).toLocaleDateString('pt-BR')}</div>
                        <div class="log-content">
                            <strong>Peso:</strong> ${r.weight}kg | <strong>Macros:</strong> P:${r.protein}g C:${r.carb}g G:${r.fat}g<br>
                            <strong>Percep√ß√£o:</strong> ${feelingEmoji} ${feelingText}<br>
                            ${r.notes ? `<em style="color:var(--color-text-muted);">Obs: ${r.notes}</em>` : ''}
                        </div>
                        <button class="btn btn-delete" onclick="deleteRefeed(${i})">Deletar</button>
                    </div>
                `;
            }).join('');
        }

        function deleteRefeed(index) {
            if (confirm('Deletar este refeed?')) {
                data.refeeds.splice(index, 1);
                saveData();
                renderRefeeds();
            }
        }

        // Deload Functions
        function addDeload() {
            const deload = {
                week: document.getElementById('deloadWeek').value,
                protocol: document.getElementById('deloadProtocol').value,
                feeling: document.getElementById('deloadFeeling').value.trim(),
                result: document.getElementById('deloadResult').value
            };

            if (!deload.week) {
                alert('Seleciona a semana do deload!');
                return;
            }

            data.deloads.push(deload);
            saveData();
            renderDeloads();

            document.getElementById('deloadFeeling').value = '';
            alert('Deload registrado! üò¥ Semana de recupera√ß√£o salva!');
        }

        function renderDeloads() {
            const list = document.getElementById('deloadList');
            if (data.deloads.length === 0) {
                list.innerHTML = '<div class="empty-state">Nenhum deload registrado ainda</div>';
                return;
            }

            const sorted = [...data.deloads].sort((a, b) => new Date(b.week) - new Date(a.week));
            
            list.innerHTML = sorted.map((d, i) => {
                const protocolText = {
                    'volume': 'Volume Reduzido (50%)',
                    'intensidade': 'Intensidade Reduzida (60%)',
                    'completo': 'Completo (50% vol + 60% int)',
                    'ativo': 'Descanso Ativo'
                }[d.protocol] || d.protocol;
                
                const resultEmoji = {
                    'excelente': 'üî•',
                    'bom': '‚úÖ',
                    'normal': '‚û°Ô∏è',
                    'ruim': '‚ö†Ô∏è'
                }[d.result] || '‚û°Ô∏è';
                
                const resultText = {
                    'excelente': 'Excelente',
                    'bom': 'Bom',
                    'normal': 'Normal',
                    'ruim': 'Ruim'
                }[d.result] || 'Normal';
                
                const weekDate = new Date(d.week + '-1');
                const weekStr = weekDate.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                
                return `
                    <div class="log-entry">
                        <div class="log-date">Semana de ${weekStr}</div>
                        <div class="log-content">
                            <strong>Protocolo:</strong> ${protocolText}<br>
                            <strong>Resultado:</strong> ${resultEmoji} ${resultText}<br>
                            ${d.feeling ? `<em style="color:var(--color-text-muted);">${d.feeling}</em>` : ''}
                        </div>
                        <button class="btn btn-delete" onclick="deleteDeload(${i})">Deletar</button>
                    </div>
                `;
            }).join('');
        }

        function deleteDeload(index) {
            if (confirm('Deletar este deload?')) {
                data.deloads.splice(index, 1);
                saveData();
                renderDeloads();
            }
        }

        
        // ===== GEMS Provider Settings (offline / proxy) =====
        function saveGemsProviderSettings() {
            try {
                const provider = document.getElementById('gemsProvider')?.value || 'offline';
                const proxyUrl = document.getElementById('gemsProxyUrl')?.value?.trim() || '';
                const apiKey = document.getElementById('gemsApiKey')?.value?.trim() || '';
                data.gemsProvider = { provider, proxyUrl, apiKey };
                saveData();
            } catch (e) {
                console.error('Erro ao salvar settings do GEMS:', e);
            }
        }

        function loadGemsProviderSettings() {
            const s = data.gemsProvider || { provider: 'offline', proxyUrl: '', apiKey: '' };
            const providerEl = document.getElementById('gemsProvider');
            const proxyEl = document.getElementById('gemsProxyUrl');
            const keyEl = document.getElementById('gemsApiKey');
            if (providerEl) providerEl.value = s.provider || 'offline';
            if (proxyEl) proxyEl.value = s.proxyUrl || '';
            if (keyEl) keyEl.value = s.apiKey || '';
        }

        async function testGemsConnection() {
            const s = data.gemsProvider || { provider: 'offline' };
            if (s.provider === 'offline') {
                alert('Offline OK ‚úÖ (nenhuma conex√£o necess√°ria)');
                return;
            }
            if (!s.proxyUrl) {
                alert('Pra usar OpenAI/Gemini no GitHub Pages, coloque um Proxy URL primeiro.');
                return;
            }
            try {
                const res = await fetch(s.proxyUrl.replace(/\/$/, '') + '/health', { method: 'GET' });
                if (res.ok) alert('Proxy respondeu ‚úÖ');
                else alert('Proxy respondeu, mas com status ' + res.status);
            } catch (e) {
                alert('N√£o consegui falar com o proxy. Veja o console para detalhes.');
                console.error(e);
            }
        }

        async function callGemsLLM(messages) {
            const s = data.gemsProvider || { provider: 'offline', proxyUrl: '', apiKey: '' };
            if (s.provider === 'offline') return null;

            if (!s.proxyUrl) {
                throw new Error('Proxy URL n√£o configurado.');
            }

            // Voc√™ pode implementar o proxy como Cloudflare Worker / Netlify Function.
            // Ele recebe {provider, apiKey, messages} e retorna {text}.
            const url = s.proxyUrl.replace(/\/$/, '') + '/chat';
            const payload = { provider: s.provider, apiKey: s.apiKey, messages };

            const resp = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!resp.ok) {
                const t = await resp.text().catch(() => '');
                throw new Error('Proxy error ' + resp.status + ': ' + t);
            }
            const out = await resp.json();
            return out?.text || '';
        }
        // ====================================================

// GEMS Functions
        function saveGemsContext() {
            const context = document.getElementById('gemsContext').value.trim();
            if (!context) {
                alert('Escreve algo antes de salvar, guri!');
                return;
            }
            
            data.gemsContext = context;
            saveData();
            alert('Contexto salvo! üíæ Agora eu te conhe√ßo melhor.');
        }

        async function askGems() {
            const question = document.getElementById('gemsQuestion').value.trim();
            if (!question) {
                alert('Faz tua pergunta primeiro!');
                return;
            }

            const userMessage = {
                type: 'user',
                text: question,
                timestamp: new Date().toLocaleString('pt-BR')
            };

            const contextPrompt = data.gemsContext ? 
                `Contexto do usu√°rio:\n${data.gemsContext}\n\n` : 
                'Sem contexto salvo ainda.\n\n';

            const aiResponse = generateGemsResponse(question, contextPrompt);
            
            const aiMessage = {
                type: 'ai',
                text: aiResponse,
                timestamp: new Date().toLocaleString('pt-BR')
            };

            data.gemsChat.push(userMessage, aiMessage);
            saveData();
            renderGemsChat();
            
            document.getElementById('gemsQuestion').value = '';
        }

        // GEMS LOGBOOK ANALYZER - Analisa todos os dados salvos
        function analyzeLogbookData() {
            const analysis = {
                weight: analyzeWeightTrend(),
                training: analyzeTrainingProgress(),
                nutrition: analyzeNutrition(),
                photos: analyzePhotoProgress(),
                alerts: []
            };
            
            // Gera alertas autom√°ticos
            if (analysis.training.strengthDrop > 10) {
                analysis.alerts.push('üö® ALERTA: For√ßa caindo em v√°rios exerc√≠cios. Pode ser d√©ficit muito alto ou overtraining.');
            }
            
            if (analysis.weight.stagnant) {
                analysis.alerts.push('‚ö†Ô∏è ALERTA: Peso estagnado h√° 2+ semanas. Considere ajustar calorias.');
            }
            
            if (analysis.training.volumeDrop > 20) {
                analysis.alerts.push('üö® ALERTA: Volume semanal caiu muito. Risco de overtraining ou recupera√ß√£o ruim.');
            }
            
            if (analysis.nutrition.proteinLow) {
                analysis.alerts.push('‚ö†Ô∏è ALERTA: Prote√≠na abaixo da meta frequentemente. Aumenta nas refei√ß√µes!');
            }
            
            return analysis;
        }
        
        function analyzeWeightTrend() {
            if (data.measurements.length < 2) return { trend: 'insuficiente', stagnant: false };
            
            const sorted = [...data.measurements].sort((a, b) => new Date(a.date) - new Date(b.date));
            const recent = sorted.slice(-4); // √öltimas 4 medidas
            
            if (recent.length < 2) return { trend: 'insuficiente', stagnant: false };
            
            const weights = recent.map(m => m.weight);
            const dates = recent.map(m => new Date(m.date));
            
            const first = weights[0];
            const last = weights[weights.length - 1];
            const change = last - first;
            const daysDiff = (dates[dates.length - 1] - dates[0]) / (1000 * 60 * 60 * 24);
            const weeksChange = change / (daysDiff / 7);
            
            // Checa estagna√ß√£o (menos de 0.2kg mudan√ßa em 14+ dias)
            const stagnant = daysDiff >= 14 && Math.abs(change) < 0.2;
            
            return {
                current: last,
                change: change,
                weeklyRate: weeksChange,
                trend: change < -0.2 ? 'perdendo' : change > 0.2 ? 'ganhando' : 'mantendo',
                stagnant: stagnant,
                data: recent
            };
        }
        
        function analyzeTrainingProgress() {
            if (data.workouts.length < 4) return { progress: 'insuficiente', strengthDrop: 0 };
            
            const sorted = [...data.workouts].filter(w => w.exercises).sort((a, b) => new Date(a.date) - new Date(b.date));
            const recent = sorted.slice(-8); // √öltimos 8 treinos
            
            if (recent.length < 4) return { progress: 'insuficiente', strengthDrop: 0 };
            
            // Analisa progress√£o por exerc√≠cio
            const exerciseProgress = {};
            
            recent.forEach(w => {
                w.exercises.forEach(ex => {
                    const key = ex.name.toLowerCase().trim();
                    if (!exerciseProgress[key]) {
                        exerciseProgress[key] = [];
                    }
                    exerciseProgress[key].push({
                        date: w.date,
                        kg: ex.kg,
                        reps: ex.reps,
                        volume: ex.kg * ex.reps
                    });
                });
            });
            
            // Conta exerc√≠cios com queda de for√ßa
            let droppingExercises = 0;
            let improvingExercises = 0;
            let totalExercises = 0;
            
            Object.entries(exerciseProgress).forEach(([name, records]) => {
                if (records.length < 2) return;
                
                const first = records[0].volume;
                const last = records[records.length - 1].volume;
                const change = ((last - first) / first) * 100;
                
                totalExercises++;
                
                if (change < -5) droppingExercises++;
                if (change > 5) improvingExercises++;
            });
            
            const strengthDropPercent = totalExercises > 0 ? (droppingExercises / totalExercises) * 100 : 0;
            
            // Analisa volume semanal
            const thisWeek = getWeeklyVolume(0);
            const lastWeek = getWeeklyVolume(-1);
            const volumeChange = lastWeek > 0 ? ((thisWeek - lastWeek) / lastWeek) * 100 : 0;
            
            return {
                progress: improvingExercises > droppingExercises ? 'melhorando' : droppingExercises > improvingExercises ? 'piorando' : 'est√°vel',
                strengthDrop: strengthDropPercent,
                improvingCount: improvingExercises,
                droppingCount: droppingExercises,
                volumeChange: volumeChange,
                volumeDrop: volumeChange < 0 ? Math.abs(volumeChange) : 0,
                recentWorkouts: recent.length,
                exerciseData: exerciseProgress
            };
        }
        
        function analyzeNutrition() {
            if (data.meals.length === 0) return { status: 'sem dados', proteinLow: false };
            
            const last7Days = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                last7Days.push(dateStr);
            }
            
            const recentMeals = data.meals.filter(m => last7Days.includes(m.date));
            
            if (recentMeals.length === 0) return { status: 'sem dados recentes', proteinLow: false };
            
            // Agrupa por dia
            const dailyNutrition = {};
            last7Days.forEach(date => {
                const dayMeals = recentMeals.filter(m => m.date === date);
                if (dayMeals.length > 0) {
                    dailyNutrition[date] = {
                        protein: dayMeals.reduce((sum, m) => sum + m.protein, 0),
                        carb: dayMeals.reduce((sum, m) => sum + m.carb, 0),
                        fat: dayMeals.reduce((sum, m) => sum + m.fat, 0),
                        calories: dayMeals.reduce((sum, m) => sum + (m.protein * 4 + m.carb * 4 + m.fat * 9), 0)
                    };
                }
            });
            
            const daysWithData = Object.keys(dailyNutrition).length;
            
            if (daysWithData === 0) return { status: 'sem dados recentes', proteinLow: false };
            
            // M√©dia dos √∫ltimos dias
            const avgProtein = Object.values(dailyNutrition).reduce((sum, day) => sum + day.protein, 0) / daysWithData;
            const avgCalories = Object.values(dailyNutrition).reduce((sum, day) => sum + day.calories, 0) / daysWithData;
            
            const proteinTarget = data.macros.protein;
            const caloriesTarget = data.macros.calories;
            
            const proteinCompliance = (avgProtein / proteinTarget) * 100;
            const caloriesCompliance = (avgCalories / caloriesTarget) * 100;
            
            return {
                status: 'analisado',
                avgProtein: avgProtein,
                avgCalories: avgCalories,
                proteinCompliance: proteinCompliance,
                caloriesCompliance: caloriesCompliance,
                proteinLow: proteinCompliance < 85,
                daysTracked: daysWithData
            };
        }
        
        function analyzePhotoProgress() {
            if (data.photos.length < 2) return { status: 'insuficiente' };
            
            const sorted = [...data.photos].sort((a, b) => new Date(a.date) - new Date(b.date));
            const first = sorted[0];
            const last = sorted[sorted.length - 1];
            
            const daysDiff = (new Date(last.date) - new Date(first.date)) / (1000 * 60 * 60 * 24);
            const weightChange = last.weight - first.weight;
            
            return {
                status: 'analisado',
                firstDate: first.date,
                lastDate: last.date,
                daysBetween: daysDiff,
                weightChange: weightChange,
                firstWeight: first.weight,
                lastWeight: last.weight,
                totalPhotos: data.photos.length
            };
        }

        function generateGemsResponse(question, context) {
            const lowerQ = question.toLowerCase();
            
            // AN√ÅLISE AUTOM√ÅTICA DO LOGBOOK
            const logbookAnalysis = analyzeLogbookData();
            
            // Sistema inteligente que analisa contexto completo
            const hasContext = context && context.trim().length > 50;
            const contextData = {
                diet: context.match(/DIETA|REFEI√á√ÉO|ALIMENTO|CAF√â|ALMO√áO|JANTA/gi),
                goals: context.match(/OBJETIVO|META|PERDER|GANHAR|PESO/gi),
                training: context.match(/TREINO|EXERC√çCIO|S√âRIE|REP|CARGA/gi),
                problems: context.match(/PROBLEMA|DIFICULDADE|CANSADO|FRACO/gi),
                schedule: context.match(/MANH√É|TARDE|NOITE|HOR√ÅRIO/gi)
            };
            
            // Extra√ß√£o inteligente de dados do contexto
            let userWeight = 86; // default
            let targetCalories = 2700; // default
            let proteinGoal = 160; // default
            
            if (hasContext) {
                const weightMatch = context.match(/(\d+)\s*kg/i);
                if (weightMatch) userWeight = parseInt(weightMatch[1]);
                
                const calMatch = context.match(/(\d{4})\s*kcal/i);
                if (calMatch) targetCalories = parseInt(calMatch[1]);
                
                const protMatch = context.match(/(\d{2,3})g?\s*proteina/i);
                if (protMatch) proteinGoal = parseInt(protMatch[1]);
            }
            
            // ========== AN√ÅLISE DE DIETA ==========
            if (lowerQ.match(/dieta|alimenta√ß√£o|adaptar|ajustar|montar|criar/) && lowerQ.match(/quero|preciso|pode|consegue/)) {
                if (!hasContext) {
                    return `üéØ COMO MONTAR TUA DIETA PERSONALIZADA:\n\nMe passa essas infos no campo "Contexto Pessoal":\n\nüìä DADOS B√ÅSICOS:\n- Peso atual: XXkg\n- Meta: perder/ganhar/manter\n- Calorias/dia: XXXXkcal (usa a calculadora)\n\nüçΩÔ∏è PREFER√äNCIAS:\n- Alimentos que tu gosta\n- Alimentos que tu ODEIA\n- Alergias/restri√ß√µes\n- Quantas refei√ß√µes por dia tu consegue fazer\n\n‚è∞ ROTINA:\n- Hor√°rio do treino\n- Hor√°rio que acorda\n- Hor√°rio que dorme\n- Trabalho/estudo (pra saber quando tu pode comer)\n\nüí° OBSERVA√á√ïES:\n- Qualquer coisa espec√≠fica (ex: n√£o gosta de frango, prefere carbo √† noite, etc)\n\nDepois que tu colocar isso, eu monto uma dieta PERFEITA pra ti, adaptada 100% ao teu estilo!`;
                }
                
                // An√°lise do contexto pra montar dieta
                let response = `üî• DIETA PERSONALIZADA BASEADA NO TEU CONTEXTO:\n\n`;
                response += `üìä Teus dados: ${userWeight}kg | ${targetCalories}kcal/dia | ${proteinGoal}g prote√≠na\n\n`;
                
                response += `üçΩÔ∏è ESTRUTURA SUGERIDA:\n\n`;
                
                if (contextData.schedule && context.includes('manh√£')) {
                    response += `CAF√â DA MANH√É (logo ao acordar):\n`;
                    response += `- ${Math.round(proteinGoal * 0.25)}g prote√≠na\n`;
                    response += `- ${Math.round(targetCalories * 0.25 / 4)} kcal\n`;
                    response += `Op√ß√µes: ovos + aveia, iogurte + granola + whey, p√£o + queijo + ovo\n\n`;
                }
                
                response += `PR√â-TREINO (1-2h antes):\n`;
                response += `- Carbo m√©dio-alto (energia)\n`;
                response += `- Prote√≠na moderada\n`;
                response += `Op√ß√µes: batata doce + frango, arroz + ovo, macarr√£o + carne\n\n`;
                
                response += `P√ìS-TREINO (logo depois):\n`;
                response += `- ${Math.round(proteinGoal * 0.3)}g prote√≠na (crucial!)\n`;
                response += `- Carbo alto (reposi√ß√£o)\n`;
                response += `Op√ß√µes: whey + banana + aveia, arroz + frango grande, macarr√£o + carne\n\n`;
                
                response += `OUTRAS REFEI√á√ïES:\n`;
                response += `- Distribui o resto das calorias\n`;
                response += `- Sempre 25-35g prote√≠na por refei√ß√£o\n`;
                response += `- Verduras √† vontade\n\n`;
                
                response += `üí° AJUSTES BASEADOS NO TEU CONTEXTO:\n`;
                if (contextData.problems && context.match(/fome|fora de hora/i)) {
                    response += `‚Ä¢ T√° com fome? Aumenta prote√≠na e fibras (saciedade)\n`;
                }
                if (contextData.problems && context.match(/cansado|fraco|treino ruim/i)) {
                    response += `‚Ä¢ Treino fraco? Aumenta carbo no pr√©-treino\n`;
                }
                if (context.match(/noite|tarde da noite/i)) {
                    response += `‚Ä¢ Treina √† noite? Bota mais carbo no jantar\n`;
                }
                
                response += `\nüìå DICA: Anota tuas refei√ß√µes na aba Di√°rio! Assim eu vejo se t√° batendo as metas.`;
                
                return response;
            }
            
            // ========== CALORIAS FALTANDO ==========
            if (lowerQ.match(/preciso|falta|faltam|restam|sobra|sobram/i) && lowerQ.match(/\d+/) && (lowerQ.includes('kcal') || lowerQ.includes('caloria'))) {
                const caloriesNeeded = parseInt(lowerQ.match(/\d+/)[0]);
                
                let suggestions = `Faltam ${caloriesNeeded} kcal? Op√ß√µes diretas:\n\n`;
                
                if (caloriesNeeded <= 100) {
                    suggestions += `~100 kcal:\n- 1 banana m√©dia\n- 200ml leite desnatado\n- 15g amendoim\n- 1 fatia p√£o com requeij√£o light`;
                } else if (caloriesNeeded <= 200) {
                    suggestions += `~200 kcal:\n- 2 ovos mexidos\n- 40g aveia\n- 30g whey\n- 200g iogurte grego + 1 banana`;
                } else if (caloriesNeeded <= 300) {
                    suggestions += `~300 kcal:\n- 100g arroz + 100g frango\n- 3 ovos + 2 fatias p√£o\n- 50g whey + 1 banana + 20g pasta amendoim\n- 300g batata doce`;
                } else if (caloriesNeeded <= 500) {
                    suggestions += `~400-500 kcal:\n- 150g arroz + 150g frango\n- 4 ovos + 3 fatias p√£o + 1 banana\n- 100g macarr√£o + 100g carne\n- 400g batata doce + 100g frango`;
                } else {
                    suggestions += `~${caloriesNeeded} kcal (refei√ß√£o completa):\n- 200g arroz (~280 kcal)\n- 200g frango (~330 kcal)\n- 100g feij√£o (~77 kcal)\n- Salada √† vontade\n- 1 colher azeite (~90 kcal)`;
                }
                
                suggestions += `\n\nüí° Prioriza prote√≠na sempre que puder!`;
                return suggestions;
            }
            
            // ========== AN√ÅLISE DE PROGRESSO ==========
            if (lowerQ.match(/progresso|evoluindo|melhorando|resultado|mudan√ßa|diferen√ßa/) || lowerQ.match(/n√£o.*vendo|n√£o.*sai|empacou|estagn/)) {
                let response = `üìä AN√ÅLISE COMPLETA DO TEU PROGRESSO:\n\n`;
                
                // Peso
                if (logbookAnalysis.weight.trend !== 'insuficiente') {
                    response += `‚öñÔ∏è PESO:\n`;
                    response += `‚Ä¢ Atual: ${logbookAnalysis.weight.current}kg\n`;
                    response += `‚Ä¢ Mudan√ßa: ${logbookAnalysis.weight.change > 0 ? '+' : ''}${logbookAnalysis.weight.change.toFixed(1)}kg\n`;
                    response += `‚Ä¢ Taxa semanal: ${logbookAnalysis.weight.weeklyRate.toFixed(2)}kg/sem\n`;
                    response += `‚Ä¢ Status: ${logbookAnalysis.weight.trend === 'perdendo' ? '‚úÖ Perdendo peso' : logbookAnalysis.weight.trend === 'ganhando' ? 'üìà Ganhando peso' : '‚û°Ô∏è Mantendo'}\n`;
                    
                    if (logbookAnalysis.weight.stagnant) {
                        response += `‚ö†Ô∏è ATEN√á√ÉO: Peso estagnado h√° 2+ semanas!\n`;
                    }
                    response += `\n`;
                }
                
                // Treino
                if (logbookAnalysis.training.progress !== 'insuficiente') {
                    response += `üí™ TREINO:\n`;
                    response += `‚Ä¢ Status: ${logbookAnalysis.training.progress === 'melhorando' ? '‚úÖ Melhorando!' : logbookAnalysis.training.progress === 'piorando' ? '‚ö†Ô∏è For√ßa caindo' : '‚û°Ô∏è Est√°vel'}\n`;
                    response += `‚Ä¢ Exerc√≠cios melhorando: ${logbookAnalysis.training.improvingCount}\n`;
                    response += `‚Ä¢ Exerc√≠cios caindo: ${logbookAnalysis.training.droppingCount}\n`;
                    response += `‚Ä¢ Volume semanal: ${logbookAnalysis.training.volumeChange.toFixed(0)}%\n`;
                    
                    if (logbookAnalysis.training.strengthDrop > 10) {
                        response += `üö® ALERTA: ${logbookAnalysis.training.strengthDrop.toFixed(0)}% dos exerc√≠cios com queda de for√ßa!\n`;
                    }
                    response += `\n`;
                }
                
                // Nutri√ß√£o
                if (logbookAnalysis.nutrition.status === 'analisado') {
                    response += `üçΩÔ∏è NUTRI√á√ÉO (√∫ltimos ${logbookAnalysis.nutrition.daysTracked} dias):\n`;
                    response += `‚Ä¢ Prote√≠na m√©dia: ${logbookAnalysis.nutrition.avgProtein.toFixed(0)}g (${logbookAnalysis.nutrition.proteinCompliance.toFixed(0)}% da meta)\n`;
                    response += `‚Ä¢ Calorias m√©dia: ${logbookAnalysis.nutrition.avgCalories.toFixed(0)} kcal (${logbookAnalysis.nutrition.caloriesCompliance.toFixed(0)}% da meta)\n`;
                    
                    if (logbookAnalysis.nutrition.proteinLow) {
                        response += `‚ö†Ô∏è Prote√≠na abaixo de 85% da meta! Aumenta!\n`;
                    }
                    response += `\n`;
                }
                
                // Fotos
                if (logbookAnalysis.photos.status === 'analisado') {
                    response += `üì∏ FOTOS:\n`;
                    response += `‚Ä¢ ${logbookAnalysis.photos.totalPhotos} fotos em ${Math.round(logbookAnalysis.photos.daysBetween)} dias\n`;
                    response += `‚Ä¢ Peso nas fotos: ${logbookAnalysis.photos.firstWeight}kg ‚Üí ${logbookAnalysis.photos.lastWeight}kg (${logbookAnalysis.photos.weightChange > 0 ? '+' : ''}${logbookAnalysis.photos.weightChange.toFixed(1)}kg)\n\n`;
                }
                
                // DIAGN√ìSTICO
                response += `üéØ DIAGN√ìSTICO:\n\n`;
                
                if (logbookAnalysis.weight.stagnant && logbookAnalysis.training.progress === 'melhorando') {
                    response += `‚úÖ BOM SINAL: Peso parado MAS for√ßa subindo = recomposi√ß√£o corporal!\n`;
                    response += `‚Ä¢ T√° perdendo gordura e ganhando/mantendo m√∫sculo\n`;
                    response += `‚Ä¢ Foca nas fotos e medidas de cintura\n\n`;
                } else if (logbookAnalysis.weight.stagnant) {
                    response += `‚ö†Ô∏è PESO ESTAGNADO:\n`;
                    response += `‚Ä¢ Solu√ß√£o: Reduz 100-150 kcal (corta nos carbos)\n`;
                    response += `‚Ä¢ Ou aumenta NEAT (mais passos no dia)\n\n`;
                }
                
                if (logbookAnalysis.training.strengthDrop > 15) {
                    response += `üö® FOR√áA CAINDO MUITO:\n`;
                    response += `‚Ä¢ D√©ficit provavelmente ALTO demais\n`;
                    response += `‚Ä¢ Solu√ß√£o: AUMENTA 100-200 kcal (nos carbos)\n`;
                    response += `‚Ä¢ Prioriza sono (7-9h)\n`;
                    response += `‚Ä¢ Considera fazer refeed 1x/semana\n\n`;
                } else if (logbookAnalysis.training.progress === 'melhorando') {
                    response += `üî• FOR√áA SUBINDO:\n`;
                    response += `‚Ä¢ T√Å FAZENDO TUDO CERTO!\n`;
                    response += `‚Ä¢ Mant√©m o protocolo atual\n`;
                    response += `‚Ä¢ Consist√™ncia √© a chave\n\n`;
                }
                
                if (logbookAnalysis.nutrition.proteinLow) {
                    response += `‚ö†Ô∏è PROTE√çNA BAIXA:\n`;
                    response += `‚Ä¢ Meta: ${data.macros.protein}g/dia\n`;
                    response += `‚Ä¢ Atual: ${logbookAnalysis.nutrition.avgProtein.toFixed(0)}g/dia\n`;
                    response += `‚Ä¢ Aumenta 30-40g por refei√ß√£o\n\n`;
                }
                
                response += `üí° RESUMO: ${
                    logbookAnalysis.training.progress === 'melhorando' && logbookAnalysis.weight.trend === 'perdendo' ? 'Cutting PERFEITO! For√ßa subindo e peso caindo.' :
                    logbookAnalysis.training.progress === 'piorando' && logbookAnalysis.weight.trend === 'perdendo' ? 'Peso caindo mas for√ßa tamb√©m. REDUZ o d√©ficit!' :
                    logbookAnalysis.weight.stagnant ? 'Peso parado. Ajusta calorias ou NEAT.' :
                    'Continua monitorando. Anota tudo!'
                }`;
                
                return response;
            }
            
            // ========== TREINO FRACO ==========
            if (lowerQ.match(/fraco|cansado|sem energia|performance/) && lowerQ.match(/treino|academia|treinar/)) {
                let response = `üí™ TREINO FRACO - DIAGN√ìSTICO:\n\n`;
                
                // Analisa dados do logbook
                if (logbookAnalysis.training.progress !== 'insuficiente') {
                    response += `üìä AN√ÅLISE DOS TEUS TREINOS:\n`;
                    response += `‚Ä¢ √öltimos ${logbookAnalysis.training.recentWorkouts} treinos registrados\n`;
                    response += `‚Ä¢ ${logbookAnalysis.training.droppingCount} exerc√≠cios com queda de carga\n`;
                    response += `‚Ä¢ Volume semanal: ${logbookAnalysis.training.volumeChange.toFixed(0)}%\n\n`;
                    
                    if (logbookAnalysis.training.strengthDrop > 10) {
                        response += `üö® CONFIRMADO: T√° com queda de for√ßa real!\n\n`;
                    }
                }
                
                response += `üîç CAUSAS MAIS COMUNS:\n\n`;
                
                response += `1. D√âFICIT MUITO ALTO\n`;
                if (logbookAnalysis.weight.weeklyRate < -0.7) {
                    response += `   ‚ö†Ô∏è DETECTADO: T√° perdendo ${Math.abs(logbookAnalysis.weight.weeklyRate).toFixed(1)}kg/sem\n`;
                    response += `   ‚Üí Ideal: -0.5kg/sem m√°ximo\n`;
                    response += `   ‚Üí AUMENTA 150-200 kcal (carbos no pr√©-treino)\n\n`;
                } else {
                    response += `   ‚Ä¢ Perdendo peso r√°pido demais?\n`;
                    response += `   ‚Ä¢ Solu√ß√£o: aumenta 100-200 kcal\n\n`;
                }
                
                response += `2. CARBOIDRATOS BAIXOS\n`;
                if (logbookAnalysis.nutrition.status === 'analisado') {
                    const carbRatio = (logbookAnalysis.nutrition.avgCalories * 0.45) / 4; // Estima 45% de carbo
                    response += `   ‚Ä¢ Solu√ß√£o: bota ${Math.round(carbRatio * 0.3)}g carbo 1-2h antes do treino\n\n`;
                } else {
                    response += `   ‚Ä¢ Solu√ß√£o: come carbo 1-2h antes do treino\n`;
                    response += `   ‚Ä¢ Arroz, batata doce, aveia, massa\n\n`;
                }
                
                response += `3. SONO RUIM\n`;
                response += `   ‚Ä¢ Dormindo menos de 7h?\n`;
                response += `   ‚Ä¢ Sono picado/interrompido?\n`;
                response += `   ‚Üí Solu√ß√£o: PRIORIZA 8h de sono\n\n`;
                
                response += `4. OVERTRAINING\n`;
                if (logbookAnalysis.training.volumeDrop > 20) {
                    response += `   ‚ö†Ô∏è DETECTADO: Volume caiu ${logbookAnalysis.training.volumeDrop.toFixed(0)}%\n`;
                    response += `   ‚Üí Solu√ß√£o: tira 2-3 dias de descanso COMPLETO\n\n`;
                } else {
                    response += `   ‚Ä¢ Treinando 6+ dias/semana?\n`;
                    response += `   ‚Ä¢ Solu√ß√£o: aumenta dias de descanso\n\n`;
                }
                
                response += `‚úÖ PROTOCOLO IMEDIATO:\n`;
                response += `1. Pr√≥ximo treino: come 50-80g carbo 90min antes\n`;
                response += `2. Dorme 8h essa noite\n`;
                response += `3. Se n√£o melhorar: aumenta 200 kcal (carbo)\n`;
                response += `4. Continua registrando no Logbook pra eu acompanhar!`;
                
                return response;
            }
            
            // ========== POSSO AUMENTAR CALORIAS? ==========
            if (lowerQ.match(/aumentar|subir|adicionar/) && lowerQ.match(/caloria|kcal|carbo|proteina/)) {
                let response = `ü§î POSSO AUMENTAR CALORIAS?\n\n`;
                
                response += `üìä AN√ÅLISE DOS TEUS DADOS:\n\n`;
                
                // Peso
                if (logbookAnalysis.weight.trend !== 'insuficiente') {
                    response += `‚öñÔ∏è PESO: ${logbookAnalysis.weight.weeklyRate.toFixed(2)}kg/sem\n`;
                    
                    if (logbookAnalysis.weight.weeklyRate < -0.7) {
                        response += `üö® SIM, AUMENTA! T√° perdendo r√°pido demais.\n`;
                        response += `‚Üí Aumenta 150-200 kcal (carbos)\n\n`;
                    } else if (logbookAnalysis.weight.weeklyRate < -0.3) {
                        response += `‚úÖ Velocidade boa. S√≥ aumenta se treino fraco.\n\n`;
                    } else if (logbookAnalysis.weight.stagnant) {
                        response += `‚ö†Ô∏è N√ÉO! Peso parado = mant√©m ou reduz.\n\n`;
                    }
                }
                
                // For√ßa
                if (logbookAnalysis.training.progress !== 'insuficiente') {
                    response += `üí™ FOR√áA: ${logbookAnalysis.training.progress}\n`;
                    
                    if (logbookAnalysis.training.strengthDrop > 15) {
                        response += `üö® SIM, AUMENTA! For√ßa caindo muito.\n`;
                        response += `‚Üí Aumenta 200 kcal (carbos no pr√©-treino)\n\n`;
                    } else if (logbookAnalysis.training.progress === 'melhorando') {
                        response += `‚úÖ N√ÉO MEXE! For√ßa subindo = protocolo perfeito.\n\n`;
                    }
                }
                
                response += `üéØ DECIS√ÉO:\n\n`;
                
                const shouldIncrease = 
                    logbookAnalysis.weight.weeklyRate < -0.7 || 
                    logbookAnalysis.training.strengthDrop > 15;
                
                if (shouldIncrease) {
                    response += `‚úÖ SIM, AUMENTA CALORIAS:\n`;
                    response += `‚Ä¢ +150-200 kcal\n`;
                    response += `‚Ä¢ Adiciona nos CARBOS\n`;
                    response += `‚Ä¢ Bota no pr√©-treino\n`;
                    response += `‚Ä¢ Monitora por 1 semana\n\n`;
                    response += `Exemplo: +50g arroz no almo√ßo (pr√©-treino)`;
                } else if (logbookAnalysis.weight.stagnant) {
                    response += `‚ùå N√ÉO, MANT√âM OU REDUZ:\n`;
                    response += `‚Ä¢ Peso parado = d√©ficit insuficiente\n`;
                    response += `‚Ä¢ Reduz 100 kcal OU aumenta NEAT\n`;
                    response += `‚Ä¢ Monitora mais 1 semana`;
                } else {
                    response += `‚úÖ MANT√âM ATUAL:\n`;
                    response += `‚Ä¢ T√° funcionando bem\n`;
                    response += `‚Ä¢ Peso caindo + for√ßa mantendo\n`;
                    response += `‚Ä¢ N√£o mexe no que t√° dando certo!`;
                }
                
                return response;
            }
            
            // ========== EXERC√çCIO ESPEC√çFICO N√ÉO SOBE ==========
            if (lowerQ.match(/supino|agachamento|terra|remada|desenvolvimento|leg press|hack/) && lowerQ.match(/n√£o sobe|n√£o sai|trava|empaca|estagn/)) {
                let response = `üí™ EXERC√çCIO N√ÉO PROGRIDE:\n\n`;
                
                // Tenta identificar o exerc√≠cio mencionado
                const exerciseName = lowerQ.match(/supino|agachamento|terra|remada|desenvolvimento|leg press|hack/)[0];
                
                // Busca hist√≥rico desse exerc√≠cio
                if (logbookAnalysis.training.exerciseData) {
                    const exerciseKeys = Object.keys(logbookAnalysis.training.exerciseData);
                    const matchingKey = exerciseKeys.find(key => key.includes(exerciseName));
                    
                    if (matchingKey) {
                        const history = logbookAnalysis.training.exerciseData[matchingKey];
                        response += `üìä HIST√ìRICO DO TEU ${exerciseName.toUpperCase()}:\n`;
                        
                        const sorted = [...history].sort((a, b) => new Date(a.date) - new Date(b.date));
                        const first = sorted[0];
                        const last = sorted[sorted.length - 1];
                        
                        response += `‚Ä¢ Primeiro treino: ${first.kg}kg x ${first.reps} (${new Date(first.date).toLocaleDateString('pt-BR')})\n`;
                        response += `‚Ä¢ √öltimo treino: ${last.kg}kg x ${last.reps} (${new Date(last.date).toLocaleDateString('pt-BR')})\n`;
                        
                        const volumeChange = ((last.volume - first.volume) / first.volume) * 100;
                        response += `‚Ä¢ Mudan√ßa: ${volumeChange > 0 ? '+' : ''}${volumeChange.toFixed(0)}%\n\n`;
                        
                        if (volumeChange < -5) {
                            response += `üö® CONFIRMADO: T√° regredindo nesse exerc√≠cio!\n\n`;
                        } else if (volumeChange > 5) {
                            response += `‚úÖ U√©, mas t√° progredindo! +${volumeChange.toFixed(0)}%\n\n`;
                        } else {
                            response += `‚ö†Ô∏è Estagnado h√° ${sorted.length} treinos\n\n`;
                        }
                    }
                }
                
                response += `üîç CAUSAS E SOLU√á√ïES:\n\n`;
                
                response += `1. T√âCNICA RUIM (Justin Shier)\n`;
                response += `   ‚Ä¢ T√° compensando? Usando impulso?\n`;
                response += `   ‚Ä¢ ROM completo? Controle na negativa?\n`;
                response += `   ‚Üí REDUZ 10-20% carga e foca na T√âCNICA\n\n`;
                
                response += `2. VOLUME INSUFICIENTE\n`;
                response += `   ‚Ä¢ S√≥ 1 s√©rie pesada?\n`;
                response += `   ‚Üí Adiciona 1-2 s√©ries backoff (80% da carga)\n\n`;
                
                response += `3. FADIGA ACUMULADA\n`;
                response += `   ‚Ä¢ Treino desse grupo h√° 5+ dias seguidos?\n`;
                response += `   ‚Üí Tira 3-5 dias desse m√∫sculo\n\n`;
                
                response += `4. D√âFICIT CAL√ìRICO\n`;
                response += `   ‚Ä¢ Em cutting?\n`;
                response += `   ‚Üí Normal n√£o progredir (foca em manter)\n\n`;
                
                response += `‚úÖ PROTOCOLO:\n`;
                response += `Pr√≥ximo treino:\n`;
                response += `‚Ä¢ Reduz 10% da carga\n`;
                response += `‚Ä¢ Foca em T√âCNICA PERFEITA\n`;
                response += `‚Ä¢ 3x8-10 com controle total\n`;
                response += `‚Ä¢ Come bem no pr√©-treino\n`;
                response += `‚Ä¢ Registra no Logbook pra eu acompanhar!`;
                
                return response;
            }
            
            // ========== FOME FORA DE HORA ==========
            if (lowerQ.includes('fome') || (lowerQ.includes('comer') && lowerQ.match(/quero|preciso|vontade/))) {
                let response = `Fome fora de hora? Vamos resolver:\n\n`;
                
                // Analisa nutri√ß√£o se dispon√≠vel
                if (logbookAnalysis.nutrition.status === 'analisado' && logbookAnalysis.nutrition.proteinLow) {
                    response += `üö® DETECTADO: Tua prote√≠na t√° baixa!\n`;
                    response += `‚Ä¢ M√©dia: ${logbookAnalysis.nutrition.avgProtein.toFixed(0)}g (meta: ${data.macros.protein}g)\n`;
                    response += `‚Ä¢ Prote√≠na baixa = FOME o dia todo\n\n`;
                }
                
                response += `üîç DIAGN√ìSTICO:\n`;
                response += `1. Bebe 500ml √°gua - espera 10min (pode ser sede)\n`;
                response += `2. T√° em d√©ficit? Fome faz parte, √© normal\n`;
                response += `3. Bateu prote√≠na nas √∫ltimas refei√ß√µes? Se n√£o, t√° a√≠ o problema\n\n`;
                
                response += `‚úÖ SOLU√á√ïES:\n`;
                if (hasContext && contextData.diet) {
                    response += `‚Ä¢ Olhando tua dieta: aumenta prote√≠na em TODA refei√ß√£o (30-35g)\n`;
                    response += `‚Ä¢ Adiciona mais verduras (volume sem caloria)\n`;
                } else {
                    response += `‚Ä¢ 30-35g prote√≠na em CADA refei√ß√£o\n`;
                    response += `‚Ä¢ Verduras √† vontade (pepino, alface, tomate)\n`;
                }
                response += `‚Ä¢ Caf√© preto ou ch√° verde (suprime apetite)\n`;
                response += `‚Ä¢ Chiclete ou √°gua com g√°s (distrai)\n\n`;
                
                response += `üÜò SE A FOME T√Å INSUPORT√ÅVEL:\n`;
                response += `Come algo leve: 2 ovos cozidos, 100g peito frango, ou 200g iogurte grego\n`;
                response += `Prote√≠na sacia e tem pouca caloria.\n\n`;
                
                response += `üí° ${hasContext ? 'Checa se t√° batendo teus macros!' : 'Salva tua dieta no GEMS pra an√°lise personalizada!'}`;
                
                return response;
            }
            
            // ========== TREINO E EXECU√á√ÉO ==========
            if (lowerQ.match(/treino|exercicio|exerc√≠cio|execu√ß√£o|t√©cnica|forma/) || lowerQ.match(/supino|agachamento|terra|remada|desenvolvimento/)) {
                let response = `üí™ TREINO - FILOSOFIA MELLER + SHIER:\n\n`;
                
                response += `üéØ PROGRESS√ÉO (Meller):\n`;
                response += `‚Ä¢ Foca em BATER as reps do range (ex: 5-9 = busca as 9)\n`;
                response += `‚Ä¢ Conseguiu 9 reps? Pr√≥ximo treino sobe carga\n`;
                response += `‚Ä¢ Progress√£o = 0.5kg, 1kg, ou +1 rep\n`;
                response += `‚Ä¢ RPE 7-9 nas s√©ries de trabalho\n\n`;
                
                response += `üî• EXECU√á√ÉO (Justin Shier):\n`;
                response += `‚Ä¢ Controle TOTAL na exc√™ntrica (negativa)\n`;
                response += `‚Ä¢ Pico de contra√ß√£o consciente\n`;
                response += `‚Ä¢ ROM completo (amplitude m√°xima segura)\n`;
                response += `‚Ä¢ ZERO compensa√ß√£o - t√©cnica limpa sempre\n`;
                response += `‚Ä¢ Sentir o m√∫sculo trabalhando > ego de carga\n\n`;
                
                if (hasContext && contextData.training) {
                    response += `üìä TEU TREINO:\n`;
                    if (context.includes('Torso') || context.includes('Limbs')) {
                        response += `‚Ä¢ Torso/Limbs detectado - estrutura boa\n`;
                        response += `‚Ä¢ Foca nas s√©ries de 5-9 (principais)\n`;
                        response += `‚Ä¢ S√©ries de 8-12 deixa mais controladas\n`;
                    }
                    response += `‚Ä¢ Usa o Logbook pra acompanhar progress√£o\n\n`;
                }
                
                response += `‚ö†Ô∏è SINAIS DE ALERTA:\n`;
                response += `‚Ä¢ Carga caindo? = d√©ficit muito alto OU overtraining\n`;
                response += `‚Ä¢ Performance ruim? = sono ruim, carbos baixos, ou stress\n`;
                response += `‚Ä¢ Dor (n√£o pump)? = t√©cnica ruim ou volume alto demais\n\n`;
                
                response += `üí° ${hasContext && contextData.training ? 'Mant√©m consist√™ncia que a progress√£o vem!' : 'Salva teu treino no GEMS pra dicas espec√≠ficas!'}`;
                
                return response;
            }
            
            // ========== CUTTING / PERDA DE PESO ==========
            if (lowerQ.match(/peso|emagrecer|cutting|secar|definir|perder/)) {
                let response = `üìâ CUTTING INTELIGENTE (Meller Style):\n\n`;
                
                response += `üéØ META IDEAL:\n`;
                response += `‚Ä¢ -0.5kg por semana (m√°ximo -1% do peso)\n`;
                response += `‚Ä¢ Mais r√°pido = perde m√∫sculo + for√ßa\n`;
                response += `‚Ä¢ Mais devagar = funciona, mas demora\n\n`;
                
                response += `‚öñÔ∏è COMO MEDIR:\n`;
                response += `‚Ä¢ Pesa TODO DIA: acordou, mijou, em jejum\n`;
                response += `‚Ä¢ Olha a M√âDIA SEMANAL (n√£o o dia a dia)\n`;
                response += `‚Ä¢ Mede cintura semanalmente\n`;
                response += `‚Ä¢ Foto semanal (frente/costas/lateral)\n\n`;
                
                response += `‚úÖ SINAIS QUE T√Å CERTO:\n`;
                response += `‚Ä¢ M√©dia semanal caindo consistente\n`;
                response += `‚Ä¢ Cintura reduzindo\n`;
                response += `‚Ä¢ For√ßa mantendo ou subindo (!!)\n`;
                response += `‚Ä¢ Recupera√ß√£o boa\n\n`;
                
                response += `üö® SINAIS QUE T√Å ERRADO:\n`;
                response += `‚Ä¢ For√ßa despencando\n`;
                response += `‚Ä¢ Cansa√ßo extremo\n`;
                response += `‚Ä¢ Sono ruim\n`;
                response += `‚Ä¢ Libido zero\n`;
                response += `‚Üí D√©ficit MUITO alto, aumenta 100-200 kcal\n\n`;
                
                if (hasContext && contextData.goals) {
                    response += `üéØ TEU OBJETIVO:\n`;
                    if (context.match(/-\s*0[.,]\d+\s*kg/)) {
                        const goalMatch = context.match(/-\s*0[.,](\d+)/);
                        response += `‚Ä¢ Meta de -0.${goalMatch[1]}kg/semana - PERFEITO!\n`;
                    }
                    response += `‚Ä¢ Usa a aba Medidas pra acompanhar\n`;
                    response += `‚Ä¢ Registra treinos no Logbook (for√ßa = progresso)\n\n`;
                }
                
                response += `üí° LEMBRA: Perder peso mantendo for√ßa = t√° fazendo TUDO certo!`;
                
                return response;
            }
            
            // ========== MACROS ==========
            if (lowerQ.match(/macros|proteina|prote√≠na|carbo|carboidrato|gordura/)) {
                let response = `ü•© MACROS - PRIORIDADES:\n\n`;
                
                response += `1Ô∏è‚É£ PROTE√çNA (INEGOCI√ÅVEL):\n`;
                response += `‚Ä¢ 1.8-2.2g/kg de peso\n`;
                response += `‚Ä¢ Em TODA refei√ß√£o (30-35g por vez)\n`;
                response += `‚Ä¢ Corte: 2.0-2.2g/kg (preserva m√∫sculo)\n`;
                response += `‚Ä¢ Bulking: 1.8-2.0g/kg (suficiente)\n\n`;
                
                response += `2Ô∏è‚É£ GORDURA (SA√öDE):\n`;
                response += `‚Ä¢ 0.8-1.0g/kg ou 20-25% calorias\n`;
                response += `‚Ä¢ Menos que isso = horm√¥nios ferram\n`;
                response += `‚Ä¢ Fontes: azeite, castanhas, gema ovo\n\n`;
                
                response += `3Ô∏è‚É£ CARBOIDRATO (RESTO):\n`;
                response += `‚Ä¢ Preenche o resto das calorias\n`;
                response += `‚Ä¢ Ao redor do treino (energia + recupera√ß√£o)\n`;
                response += `‚Ä¢ Cutting: reduz aqui primeiro\n`;
                response += `‚Ä¢ Bulking: aumenta aqui\n\n`;
                
                if (hasContext && contextData.diet) {
                    response += `üìä BASEADO NO TEU CONTEXTO:\n`;
                    response += `‚Ä¢ Peso ${userWeight}kg\n`;
                    response += `‚Ä¢ Prote√≠na ideal: ${Math.round(userWeight * 2.0)}g/dia\n`;
                    response += `‚Ä¢ Gordura: ~${Math.round(userWeight * 0.9)}g/dia\n`;
                    response += `‚Ä¢ Carbo: ${Math.round((targetCalories - (userWeight * 2.0 * 4) - (userWeight * 0.9 * 9)) / 4)}g/dia\n\n`;
                }
                
                response += `‚è∞ TIMING (import√¢ncia m√©dia):\n`;
                response += `‚Ä¢ Prote√≠na: espalha no dia todo\n`;
                response += `‚Ä¢ Carbo: mais no pr√© e p√≥s-treino\n`;
                response += `‚Ä¢ Gordura: quando quiser (evita pr√©-treino)\n\n`;
                
                response += `üí° ${hasContext ? 'Usa a aba Di√°rio pra acompanhar!' : 'Usa a calculadora na aba Macros!'}`;
                
                return response;
            }
            
            // ========== SUPLEMENTOS ==========
            if (lowerQ.match(/suplemento|whey|creatina|pre treino|pr√© treino|bcaa|glutamina/)) {
                let response = `üíä SUPLEMENTOS (Verdade Nua - Meller):\n\n`;
                
                response += `‚úÖ VALE A PENA:\n\n`;
                response += `1. CREATINA (5g/dia)\n`;
                response += `   ‚Ä¢ Funciona mesmo\n`;
                response += `   ‚Ä¢ Qualquer hor√°rio\n`;
                response += `   ‚Ä¢ Monohidratada √© suficiente\n`;
                response += `   ‚Ä¢ ~R$50-80 por 6 meses\n\n`;
                
                response += `2. CAFE√çNA (200-300mg pr√©-treino)\n`;
                response += `   ‚Ä¢ Caf√© coado normal funciona\n`;
                response += `   ‚Ä¢ Melhora foco e energia\n`;
                response += `   ‚Ä¢ S√≥ se n√£o te deixa ansioso\n\n`;
                
                response += `3. WHEY PROTEIN\n`;
                response += `   ‚Ä¢ S√≥ CONVENI√äNCIA\n`;
                response += `   ‚Ä¢ 2 ovos = 1 scoop whey\n`;
                response += `   ‚Ä¢ Comida > whey sempre\n`;
                response += `   ‚Ä¢ √ötil: p√≥s-treino r√°pido, sem tempo pra cozinhar\n\n`;
                
                response += `‚ùå LIXO (n√£o gasta teu dinheiro):\n`;
                response += `‚Ä¢ BCAA (prote√≠na j√° tem)\n`;
                response += `‚Ä¢ Glutamina (teu corpo produz)\n`;
                response += `‚Ä¢ Termog√™nicos (s√≥ cafe√≠na importa)\n`;
                response += `‚Ä¢ HMB, CLA, etc (efeito m√≠nimo)\n`;
                response += `‚Ä¢ Multivitam√≠nico caro (Centrum serve)\n\n`;
                
                response += `üéØ PRIORIDADE:\n`;
                response += `1. Bater prote√≠na com COMIDA\n`;
                response += `2. Creatina (se couber no bolso)\n`;
                response += `3. Caf√© (√© barato)\n`;
                response += `4. Whey S√ì se necess√°rio\n\n`;
                
                response += `üí∞ INVESTE EM:\n`;
                response += `‚Ä¢ Comida de qualidade\n`;
                response += `‚Ä¢ Academia boa\n`;
                response += `‚Ä¢ Sono (colch√£o, quarto escuro)\n`;
                response += `‚Ä¢ Isso > 1000x mais importante que suplemento caro`;
                
                return response;
            }
            
            // ========== RESPOSTA GEN√âRICA INTELIGENTE ==========
            let response = `ü§î Pergunta interessante: "${question}"\n\n`;
            
            // MOSTRA ALERTAS AUTOM√ÅTICOS SE HOUVER
            if (logbookAnalysis.alerts.length > 0) {
                response += `üö® ALERTAS AUTOM√ÅTICOS DO LOGBOOK:\n\n`;
                logbookAnalysis.alerts.forEach(alert => {
                    response += `${alert}\n`;
                });
                response += `\n`;
            }
            
            // RESUMO DO LOGBOOK
            if (data.workouts.length > 0 || data.measurements.length > 0 || data.meals.length > 0) {
                response += `üìä RESUMO DOS TEUS DADOS:\n`;
                
                if (logbookAnalysis.weight.trend !== 'insuficiente') {
                    response += `‚Ä¢ Peso: ${logbookAnalysis.weight.current}kg (${logbookAnalysis.weight.trend})\n`;
                }
                
                if (logbookAnalysis.training.progress !== 'insuficiente') {
                    response += `‚Ä¢ Treino: ${logbookAnalysis.training.progress} (${logbookAnalysis.training.recentWorkouts} treinos)\n`;
                }
                
                if (logbookAnalysis.nutrition.status === 'analisado') {
                    response += `‚Ä¢ Nutri√ß√£o: ${logbookAnalysis.nutrition.avgProtein.toFixed(0)}g prote√≠na/dia (${logbookAnalysis.nutrition.proteinCompliance.toFixed(0)}%)\n`;
                }
                
                response += `\n`;
            }
            
            if (hasContext) {
                response += `üìã CONTEXTO PESSOAL SALVO:\n`;
                if (contextData.diet) response += `‚úì Dieta configurada\n`;
                if (contextData.goals) response += `‚úì Objetivos definidos\n`;
                if (contextData.training) response += `‚úì Treino configurado\n`;
                if (contextData.problems) response += `‚úì Problemas identificados\n`;
                response += `\n`;
            }
            
            response += `üí° PRINC√çPIOS FUNDAMENTAIS (Meller):\n\n`;
            response += `1. CONSIST√äNCIA > Perfei√ß√£o\n`;
            response += `   ‚Üí Melhor fazer 80% todo dia que 100% 2x na semana\n\n`;
            
            response += `2. D√âFICIT MODERADO + TREINO PESADO\n`;
            response += `   ‚Üí Perde gordura mantendo m√∫sculo\n\n`;
            
            response += `3. PROTE√çNA ALTA SEMPRE\n`;
            response += `   ‚Üí 2g/kg m√≠nimo (n√£o negocia)\n\n`;
            
            response += `4. PROGRESS√ÉO DE CARGA\n`;
            response += `   ‚Üí Se n√£o t√° mais forte, n√£o t√° crescendo\n\n`;
            
            response += `5. SONO = RECUPERA√á√ÉO\n`;
            response += `   ‚Üí 7-9h n√£o negoci√°vel\n\n`;
            
            if (!hasContext) {
                response += `\nüîß DEIXA EU TE AJUDAR MELHOR:\n\n`;
                response += `Salva no campo "Contexto Pessoal":\n`;
                response += `‚Ä¢ Tua dieta completa\n`;
                response += `‚Ä¢ Teu treino atual\n`;
                response += `‚Ä¢ Teus objetivos\n`;
                response += `‚Ä¢ Teus hor√°rios\n`;
                response += `‚Ä¢ Problemas que t√° enfrentando\n\n`;
                response += `Quanto mais detalhes, melhor eu te ajudo! üöÄ`;
            } else {
                response += `\nüí¨ Precisa de algo mais espec√≠fico? Detalha mais tua d√∫vida!`;
            }
            
            return response;
        }

        function renderGemsChat() {
            const container = document.getElementById('gemsChatHistory');
            if (data.gemsChat.length === 0) {
                container.innerHTML = '<div class="empty-state">Nenhuma conversa ainda. Faz tua primeira pergunta!</div>';
                return;
            }

            container.innerHTML = data.gemsChat.map(msg => `
                <div class="gems-message ${msg.type}">
                    <div class="gems-message-label">${msg.type === 'user' ? 'üßî Tu' : 'üíé GEMS'} - ${msg.timestamp}</div>
                    <div class="gems-message-content">${msg.text}</div>
                </div>
            `).join('');
            
            container.scrollTop = container.scrollHeight;
        }

        function clearGemsChat() {
            if (confirm('Limpar todo o hist√≥rico do chat?')) {
                data.gemsChat = [];
                saveData();
                renderGemsChat();
            }
        }

        // Load GEMS data
        function loadGemsData() {
            if (data.gemsContext) {
                document.getElementById('gemsContext').value = data.gemsContext;
            }
            loadGemsProviderSettings();
            renderGemsChat();
            updateGemsAnalysisPreview();
        }
        
        function updateGemsAnalysisPreview() {
            const analysis = analyzeLogbookData();
            const previewEl = document.getElementById('gemsAnalysisPreview');
            
            if (!previewEl) return;
            
            let preview = '';
            
            if (analysis.weight.trend !== 'insuficiente') {
                preview += `‚öñÔ∏è ${analysis.weight.current}kg (${analysis.weight.trend}) `;
            }
            
            if (analysis.training.progress !== 'insuficiente') {
                preview += `üí™ ${analysis.training.progress} (${analysis.training.recentWorkouts} treinos) `;
            }
            
            if (analysis.nutrition.status === 'analisado') {
                preview += `üçΩÔ∏è ${analysis.nutrition.avgProtein.toFixed(0)}g prot/dia `;
            }
            
            if (analysis.alerts.length > 0) {
                preview += `| üö® ${analysis.alerts.length} alerta(s)`;
            }
            
            if (preview === '') {
                preview = 'Registra dados no app pra GEMS analisar melhor!';
            }
            
            previewEl.textContent = preview;
        }

        // Notification Functions
        function checkReminders() {
            const today = new Date().toISOString().split('T')[0];
            const notifications = [];

            const todayMeals = data.meals.filter(m => m.date === today);
            if (todayMeals.length === 0) {
                notifications.push('üìù Ainda n√£o registrou nenhuma refei√ß√£o hoje!');
            }

            const todayWorkout = data.workouts.filter(w => w.date === today);
            const dayOfWeek = new Date().getDay();
            const isRestDay = dayOfWeek === 0 || dayOfWeek === 6;
            
            if (!isRestDay && todayWorkout.length === 0) {
                notifications.push('üí™ N√£o esquece de logar teu treino hoje!');
            }

            const lastPhoto = data.photos.length > 0 ? data.photos[data.photos.length - 1] : null;
            if (lastPhoto) {
                const daysSincePhoto = Math.floor((new Date() - new Date(lastPhoto.date)) / (1000 * 60 * 60 * 24));
                if (daysSincePhoto >= 7) {
                    notifications.push('üì∏ J√° faz 7+ dias sem foto do progresso f√≠sico!');
                }
            } else {
                notifications.push('üì∏ Ainda n√£o tem nenhuma foto do progresso!');
            }

            const lastMeasure = data.measurements.length > 0 ? data.measurements[data.measurements.length - 1] : null;
            if (lastMeasure) {
                const daysSinceMeasure = Math.floor((new Date() - new Date(lastMeasure.date)) / (1000 * 60 * 60 * 24));
                if (daysSinceMeasure >= 7) {
                    notifications.push('‚öñÔ∏è J√° faz 7+ dias sem pesar/medir!');
                }
            }

            return notifications;
        }

        function showNotificationBanner() {
            const notifications = checkReminders();
            const dashboard = document.getElementById('dashboard');
            
            const existingBanner = document.querySelector('.notification-banner');
            if (existingBanner) {
                existingBanner.remove();
            }

            if (notifications.length > 0) {
                const banner = document.createElement('div');
                banner.className = 'notification-banner';
                banner.innerHTML = `<span class="notification-dot"></span>${notifications[0]}`;
                banner.onclick = () => {
                    if (notifications[0].includes('refei√ß√£o')) {
                        showTab('diario');
                    } else if (notifications[0].includes('treino')) {
                        showTab('logbook');
                    } else if (notifications[0].includes('foto')) {
                        showTab('fisico');
                    } else if (notifications[0].includes('pesar')) {
                        showTab('medidas');
                    }
                };
                dashboard.insertBefore(banner, dashboard.firstChild);
            }
        }

        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        data.notificationsEnabled = true;
                        saveData();
                        alert('‚úÖ Notifica√ß√µes ativadas! Vou te lembrar das coisas importantes.');
                        scheduleNotifications();
                    }
                });
            }
        }

        function scheduleNotifications() {
            if (!data.notificationsEnabled || Notification.permission !== 'granted') return;

            const now = new Date();
            const hour = now.getHours();

            if (hour === 9) {
                const todayMeals = data.meals.filter(m => m.date === new Date().toISOString().split('T')[0]);
                if (todayMeals.length === 0) {
                    new Notification('üí™ Logbook', {
                        body: 'Bom dia, guri! N√£o esquece de registrar tuas refei√ß√µes hoje.',
                        icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ctext y="70" font-size="60"%3Eüí™%3C/text%3E%3C/svg%3E'
                    });
                }
            }

            if (hour === 19) {
                const todayWorkout = data.workouts.filter(w => w.date === new Date().toISOString().split('T')[0]);
                if (todayWorkout.length === 0) {
                    new Notification('üí™ Logbook', {
                        body: 'J√° treinou hoje? N√£o esquece de logar no app!',
                        icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ctext y="70" font-size="60"%3Eüí™%3C/text%3E%3C/svg%3E'
                    });
                }
            }
        }

        // Set today's date on inputs
        document.getElementById('measureDate').valueAsDate = new Date();
        document.getElementById('photoDate').valueAsDate = new Date();
        document.getElementById('refeedDate').valueAsDate = new Date();
        
        // Set current week for deload
        const now = new Date();
        const year = now.getFullYear();
        const weekNum = String(Math.ceil((now - new Date(year, 0, 1)) / 604800000)).padStart(2, '0');
        document.getElementById('deloadWeek').value = `${year}-W${weekNum}`;

        // Analysis functions
        function getWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function getWeeklyVolume(weekOffset = 0) {
            const now = new Date();
            const currentWeek = getWeekNumber(now) + weekOffset;
            
            return data.workouts
                .filter(w => w.exercises && getWeekNumber(new Date(w.date)) === currentWeek)
                .reduce((sum, w) => sum + calculateWorkoutVolume(w), 0);
        }

        function renderAnalysis() {
            // Weekly volume
            const thisWeek = getWeeklyVolume(0);
            const lastWeek = getWeeklyVolume(-1);
            const trend = thisWeek > lastWeek ? 'üìà' : thisWeek < lastWeek ? 'üìâ' : '‚û°Ô∏è';
            const trendClass = thisWeek > lastWeek ? 'trend-up' : thisWeek < lastWeek ? 'trend-down' : 'trend-stable';
            
            document.getElementById('weeklyVolume').textContent = `${thisWeek.toFixed(0)} kg`;
            document.getElementById('lastWeekVolume').textContent = `${lastWeek.toFixed(0)} kg`;
            document.getElementById('volumeTrend').innerHTML = `<span class="${trendClass}">${trend}</span>`;
            document.getElementById('totalWorkouts').textContent = data.workouts.filter(w => w.exercises).length;

            // Volume chart (last 8 weeks)
            renderVolumeChart();
            
            // Comparison
            renderComparison();
            
            // PRs
            renderPRs();
        }

        function renderVolumeChart() {
            const chart = document.getElementById('volumeChart');
            const weeks = [];
            
            for (let i = 7; i >= 0; i--) {
                const volume = getWeeklyVolume(-i);
                weeks.push({ offset: i, volume });
            }
            
            const maxVolume = Math.max(...weeks.map(w => w.volume), 1);
            
            chart.innerHTML = weeks.map(w => {
                const height = (w.volume / maxVolume) * 100;
                const weekLabel = w.offset === 0 ? 'Atual' : `-${w.offset}sem`;
                return `
                    <div class="volume-bar" style="height: ${height}%">
                        <div class="volume-bar-value">${w.volume.toFixed(0)}</div>
                        <div class="volume-bar-label">${weekLabel}</div>
                    </div>
                `;
            }).join('');
        }

        function filterWorkoutType(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderComparison();
        }

        function renderComparison() {
            const list = document.getElementById('comparisonList');
            
            let workouts = data.workouts.filter(w => w.exercises);
            if (currentFilter !== 'all') {
                workouts = workouts.filter(w => w.name.includes(currentFilter));
            }
            
            if (workouts.length === 0) {
                list.innerHTML = '<div class="empty-state">Nenhum treino encontrado</div>';
                return;
            }

            const sorted = [...workouts].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            list.innerHTML = sorted.map(w => {
                const volume = calculateWorkoutVolume(w);
                return `
                    <div class="comparison-card">
                        <div class="comparison-header">
                            <span>${w.name}</span>
                            <span>${new Date(w.date).toLocaleDateString('pt-BR')}</span>
                        </div>
                        <div class="comparison-data">
                            Volume: <strong>${volume.toFixed(0)} kg</strong><br>
                            ${w.exercises.map(ex => 
                                `${ex.name}: ${ex.kg}kg x ${ex.reps}`
                            ).join('<br>')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPRs() {
            const list = document.getElementById('prList');
            const exerciseMap = {};
            
            data.workouts.forEach(w => {
                if (!w.exercises) return;
                w.exercises.forEach(ex => {
                    const key = ex.name.toLowerCase().trim();
                    const current = ex.kg * ex.reps;
                    
                    if (!exerciseMap[key] || current > exerciseMap[key].max) {
                        exerciseMap[key] = {
                            name: ex.name,
                            max: current,
                            kg: ex.kg,
                            reps: ex.reps,
                            date: w.date
                        };
                    }
                });
            });

            const prs = Object.values(exerciseMap).sort((a, b) => b.max - a.max);
            
            if (prs.length === 0) {
                list.innerHTML = '<div class="empty-state">Nenhum recorde ainda</div>';
                return;
            }

            list.innerHTML = prs.map(pr => `
                <div class="comparison-card">
                    <div class="comparison-header">
                        <span>${pr.name}</span>
                        <span class="pr-badge">PR</span>
                    </div>
                    <div class="comparison-data">
                        <strong>${pr.kg}kg x ${pr.reps} reps</strong> = ${pr.max.toFixed(0)}kg total<br>
                        <span style="color:var(--color-text-muted);font-size:0.8rem;">
                            ${new Date(pr.date).toLocaleDateString('pt-BR')}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // Set auto-detected workout
        document.getElementById('autoWorkoutName').value = detectWorkout();

        // Initialize exercises
        initializeExercises();

        // Load data on startup
        loadData();
        loadGemsData();
        showNotificationBanner();
        
        // Update GEMS preview when switching to GEMS tab
        const originalShowTab = showTab;
        showTab = function(tabName, clickedButton) {
            originalShowTab(tabName, clickedButton);
            if (tabName === 'gems') {
                updateGemsAnalysisPreview();
            }
        };
        
        // Check reminders every hour
        setInterval(() => {
            showNotificationBanner();
            scheduleNotifications();
        }, 3600000);

        // Ask for notification permission after 3 seconds
        setTimeout(() => {
            if (!data.notificationsEnabled && 'Notification' in window && Notification.permission === 'default') {
                if (confirm('üí™ Quer ativar notifica√ß√µes pra eu te lembrar das coisas importantes (treino, refei√ß√µes, fotos)?')) {
                    requestNotificationPermission();
                }
            }
        }, 3000);
    
        // ===== Robustez: n√£o deixar um erro quebrar o app inteiro =====
        window.addEventListener('error', (e) => {
            console.error('Erro capturado:', e?.error || e?.message || e);
        });
        window.addEventListener('unhandledrejection', (e) => {
            console.error('Promise rejeitada:', e?.reason || e);
        });
        // ==============================================================


// ===== Samuel-style helpers: PR + Sugest√£o + Backup =====
        function getBestForExercise(exName) {
            const hist = buildExerciseHistoryIndex();
            const entries = hist[exName] || [];
            let bestKg = null;
            let bestE1 = { e1: 0, entry: null };

            entries.forEach(e => {
                if (!bestKg || e.kg > bestKg.kg) bestKg = e;
                const e1 = calcE1RM(e.kg, e.reps);
                if (e1 > bestE1.e1) bestE1 = { e1, entry: e };
            });

            return { bestKg, bestE1 };
        }

        function suggestNext(exName) {
            const last = getLastEntryForExercise(exName);
            if (!last) return null;

            // Heur√≠stica simples (pr√°tica):
            // - Se RIR >= 2: tentar +1 rep mantendo carga
            // - Se RIR <= 1: tentar +2.5kg mantendo reps
            // - Se reps muito altas (>=12): priorizar +2.5kg e voltar reps
            const rir = (last.rir ?? 2);
            const inc = 2.5;

            if (last.reps >= 12) {
                return { kg: (last.kg + inc), reps: Math.max(6, last.reps - 2), reason: 'Subir carga e manter reps em faixa √∫til' };
            }
            if (rir >= 2) {
                return { kg: last.kg, reps: last.reps + 1, reason: 'Boa margem (RIR), progride reps' };
            }
            return { kg: last.kg + inc, reps: last.reps, reason: 'Perto da falha, progride carga pequeno' };
        }

        function updateExerciseBadgesAndSuggestions() {
            for (let i = 1; i <= (exerciseCount || 0); i++) {
                const container = document.getElementById(`exercise-${i}`);
                if (!container) continue;

                const title = container.querySelector('div[style*="font-weight:600"]');
                if (!title) continue;
                const name = title.textContent.trim();

                // Suggestion line
                const suggestBox = container.querySelector(`#ex-suggest-${i}`);
                if (suggestBox) {
                    const sug = suggestNext(name);
                    const best = getBestForExercise(name);
                    const prKg = best.bestKg ? `${best.bestKg.kg}kg x ${best.bestKg.reps}` : '--';
                    const prE1 = best.bestE1.entry ? `${best.bestE1.e1.toFixed(1)}kg` : '--';

                    if (!sug) {
                        suggestBox.innerHTML = `PR: <strong>${prKg}</strong> ¬∑ e1RM: <strong>${prE1}</strong> ¬∑ <span style="opacity:0.8;">Sem sugest√£o ainda (primeiro registro).</span>`;
                    } else {
                        suggestBox.innerHTML = `Sugest√£o: <strong>${sug.kg}kg x ${sug.reps}</strong> <span style="opacity:0.8;">(${sug.reason})</span><br>PR: <strong>${prKg}</strong> ¬∑ e1RM: <strong>${prE1}</strong>`;
                    }
                }

                // Keep existing "√öltimo" badge
                // annotateExerciseInputsWithLast() already handles it
            }
        }

        function wireAutoRestTimer() {
            // Start rest timer when user finishes a set (Enter or blur on reps/RIR)
            for (let i = 1; i <= (exerciseCount || 0); i++) {
                const reps = document.getElementById(`ex-reps-${i}`);
                const rir = document.getElementById(`ex-rir-${i}`);
                const kg = document.getElementById(`ex-kg-${i}`);

                const handler = (ev) => {
                    if (ev.type === 'keydown' && ev.key !== 'Enter') return;
                    // only start if kg & reps are filled
                    const kgVal = parseFloat(kg?.value) || 0;
                    const repsVal = parseInt(reps?.value) || 0;
                    if (kgVal > 0 && repsVal > 0) startRestTimer(i);
                };

                [reps, rir].forEach(el => {
                    if (!el) return;
                    el.onkeydown = handler;
                    el.onblur = handler;
                });
            }
        }

        // Export / Import
        function exportAppData() {
            try {
                const payload = {
                    version: 1,
                    exportedAt: new Date().toISOString(),
                    data: (typeof data !== 'undefined') ? data : {},
                    local: {
                        userName: localStorage.getItem('userName') || '',
                        customRoutineText: localStorage.getItem('customRoutineText') || '',
                        customDietText: localStorage.getItem('customDietText') || ''
                    }
                };
                const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fitness-backup-${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);

                const st = document.getElementById('backupStatus');
                if (st) st.textContent = 'Backup exportado ‚úÖ';
            } catch (e) {
                alert('Erro ao exportar backup.');
                console.error(e);
            }
        }

        function importAppDataFile(event) {
            const file = event.target.files?.[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const payload = JSON.parse(reader.result);
                    if (!payload || !payload.data) throw new Error('Formato inv√°lido');

                    if (typeof data !== 'undefined') {
                        // Merge safe
                        data = payload.data;
                        if (typeof saveData === 'function') saveData();
                    }

                    if (payload.local) {
                        if (payload.local.userName !== undefined) localStorage.setItem('userName', payload.local.userName || '');
                        if (payload.local.customRoutineText !== undefined) localStorage.setItem('customRoutineText', payload.local.customRoutineText || '');
                        if (payload.local.customDietText !== undefined) localStorage.setItem('customDietText', payload.local.customDietText || '');
                    }

                    // Refresh UI
                    if (typeof loadData === 'function') loadData();
                    if (typeof computeWeeklyInsights === 'function') computeWeeklyInsights();
                    if (typeof populateExerciseSelect === 'function') populateExerciseSelect();
                    if (typeof renderExerciseHistory === 'function') renderExerciseHistory();

                    const st = document.getElementById('backupStatus');
                    if (st) st.textContent = 'Backup importado ‚úÖ';
                } catch (e) {
                    alert('Arquivo de backup inv√°lido.');
                    console.error(e);
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        function resetAllData() {
            if (!confirm('Isso vai apagar TODOS os dados (logs, macros, rotina e perfil) neste dispositivo. Continuar?')) return;
            try {
                // reset app data object if exists
                if (typeof data !== 'undefined') {
                    data.workouts = [];
                    data.deloads = [];
                    data.weight = [];
                    data.macros = { calories: 0, protein: 0, carb: 0, fat: 0 };
                    if (typeof saveData === 'function') saveData();
                }
                localStorage.removeItem('userName');
                localStorage.removeItem('customRoutineText');
                localStorage.removeItem('customDietText');

                if (typeof loadData === 'function') loadData();
                const st = document.getElementById('backupStatus');
                if (st) st.textContent = 'Reset conclu√≠do ‚úÖ';
            } catch (e) {
                console.error(e);
            }
        }
        // =========================================================

        function detectPRsForWorkout(workout) {
            const histIndex = buildExerciseHistoryIndex();
            const prs = [];
            (workout.exercises || []).forEach(ex => {
                const name = ex.name?.trim();
                if (!name) return;
                // Determine best kg BEFORE adding this workout (approx by removing same date entry)
                const entries = (histIndex[name] || []).filter(e => e.date !== workout.date);
                let bestKg = 0;
                entries.forEach(e => { if (e.kg > bestKg) bestKg = e.kg; });
                if ((ex.kg || 0) > bestKg) prs.push({ name, kg: ex.kg, reps: ex.reps });
            });
            return prs;
        }

        function showPRToast(prs) {
            if (!prs || !prs.length) return;
            const msg = 'üî• PRs: ' + prs.slice(0,3).map(p => `${p.name} ${p.kg}kg x ${p.reps}`).join(' ¬∑ ') + (prs.length>3 ? ` (+${prs.length-3})` : '');
            // lightweight: alert is simplest; could be replaced by toast later
            alert(msg);
        }


        // ===== F√çSICO: BF por medidas (US Navy) + Fotos (IndexedDB) =====
        function cmToIn(cm){ return cm / 2.54; }

        function navyBodyFat({sex, heightCm, neckCm, waistCm, hipCm}) {
            if (!heightCm || !neckCm || !waistCm) return null;
            const H = cmToIn(heightCm);
            const N = cmToIn(neckCm);
            const W = cmToIn(waistCm);

            if (sex === 'female') {
                if (!hipCm) return null;
                const Hip = cmToIn(hipCm);
                const bf = 163.205 * Math.log10(W + Hip - N) - 97.684 * Math.log10(H) - 78.387;
                return Math.max(0, Math.min(60, bf));
            } else {
                const bf = 86.010 * Math.log10(W - N) - 70.041 * Math.log10(H) + 36.76;
                return Math.max(0, Math.min(60, bf));
            }
        }

        function ensurePhysiqueData() {
            if (typeof data === 'undefined') return;
            data.physique = data.physique || { entries: [] };
            data.physique.entries = Array.isArray(data.physique.entries) ? data.physique.entries : [];
        }

        function previewBF() {
            const sex = document.getElementById('bfSex')?.value || 'male';
            const heightCm = parseFloat(document.getElementById('bfHeight')?.value) || 0;
            const neckCm = parseFloat(document.getElementById('bfNeck')?.value) || 0;
            const waistCm = parseFloat(document.getElementById('bfWaist')?.value) || 0;
            const hipCm = parseFloat(document.getElementById('bfHip')?.value) || 0;

            const bf = navyBodyFat({sex, heightCm, neckCm, waistCm, hipCm});
            const box = document.getElementById('bfPreview');
            if (!box) return;

            if (bf === null) {
                box.innerHTML = '<div class="empty-state">Preencha as medidas para calcular.</div>';
                return;
            }
            box.innerHTML = `
                <div style="padding:0.75rem;border:1px solid rgba(255,255,255,0.12);border-radius:8px;background:var(--color-bg);">
                    <strong>BF estimado:</strong> <span style="color:var(--color-primary);font-weight:700;">${bf.toFixed(1)}%</span>
                    <div style="margin-top:0.4rem;color:var(--color-text-muted);font-size:0.85rem;">
                        Estimativa por f√≥rmula (US Navy). Use como tend√™ncia.
                    </div>
                </div>`;
        }

        function saveBFEntry() {
            ensurePhysiqueData();
            const sex = document.getElementById('bfSex')?.value || 'male';
            const heightCm = parseFloat(document.getElementById('bfHeight')?.value) || 0;
            const neckCm = parseFloat(document.getElementById('bfNeck')?.value) || 0;
            const waistCm = parseFloat(document.getElementById('bfWaist')?.value) || 0;
            const hipCm = parseFloat(document.getElementById('bfHip')?.value) || 0;
            const weightKg = parseFloat(document.getElementById('bfWeight')?.value) || null;
            const notes = (document.getElementById('bfNotes')?.value || '').trim();

            const bf = navyBodyFat({sex, heightCm, neckCm, waistCm, hipCm});
            if (bf === null) {
                alert('Preencha as medidas para calcular e salvar.');
                return;
            }

            const entry = {
                date: new Date().toISOString().slice(0,10),
                sex,
                heightCm,
                neckCm,
                waistCm,
                hipCm: sex === 'female' ? hipCm : null,
                weightKg,
                bf: Number(bf.toFixed(2)),
                notes
            };

            data.physique.entries.push(entry);
            data.physique.entries.sort((a,b) => new Date(a.date) - new Date(b.date));
            if (typeof saveData === 'function') saveData();
            renderPhysique();
            const st = document.getElementById('bfStatus');
            if (st) st.textContent = 'Medi√ß√£o salva ‚úÖ';
        }

        function deleteBFEntry(date) {
            ensurePhysiqueData();
            if (!confirm('Apagar esta medi√ß√£o?')) return;
            data.physique.entries = (data.physique.entries || []).filter(e => e.date !== date);
            if (typeof saveData === 'function') saveData();
            renderPhysique();
        }

        function renderPhysique() {
            ensurePhysiqueData();
            const entries = data.physique.entries || [];
            const cur = entries.length ? entries[entries.length - 1] : null;
            const prev = entries.length > 1 ? entries[entries.length - 2] : null;

            const bfCurrent = document.getElementById('bfCurrent');
            const bfDelta = document.getElementById('bfDelta');
            const waistCurrent = document.getElementById('waistCurrent');
            const neckCurrent = document.getElementById('neckCurrent');

            if (bfCurrent) bfCurrent.textContent = cur ? `${cur.bf.toFixed(1)}%` : '--%';
            if (waistCurrent) waistCurrent.textContent = cur ? `${cur.waistCm.toFixed(1)} cm` : '-- cm';
            if (neckCurrent) neckCurrent.textContent = cur ? `${cur.neckCm.toFixed(1)} cm` : '-- cm';

            if (bfDelta) {
                if (cur && prev) {
                    const d = (cur.bf - prev.bf);
                    const sign = d > 0 ? '+' : '';
                    bfDelta.textContent = `${sign}${d.toFixed(1)}%`;
                } else bfDelta.textContent = '--';
            }

            const sexSel = document.getElementById('bfSex');
            const hipGroup = document.getElementById('hipGroup');
            if (sexSel && hipGroup) hipGroup.style.display = (sexSel.value === 'female') ? 'block' : 'none';

            const hist = document.getElementById('bfHistory');
            if (hist) {
                if (!entries.length) {
                    hist.innerHTML = '<div class="empty-state">Nenhuma medi√ß√£o salva ainda.</div>';
                } else {
                    hist.innerHTML = entries.slice().reverse().map(e => {
                        const extra = [
                            e.weightKg ? `Peso: <strong>${e.weightKg.toFixed(1)}kg</strong>` : null,
                            e.sex === 'female' && e.hipCm ? `Quadril: <strong>${e.hipCm.toFixed(1)}cm</strong>` : null
                        ].filter(Boolean).join(' ¬∑ ');
                        const note = e.notes ? `<div style="margin-top:0.25rem;color:var(--color-text-muted);font-size:0.8rem;">${e.notes.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>` : '';
                        return `
                            <div class="log-entry">
                                <div class="log-date">${new Date(e.date).toLocaleDateString('pt-BR')}</div>
                                <div class="log-content">
                                    <strong>BF:</strong> ${e.bf.toFixed(1)}% ¬∑ Cintura: <strong>${e.waistCm.toFixed(1)}cm</strong> ¬∑ Pesco√ßo: <strong>${e.neckCm.toFixed(1)}cm</strong>
                                    ${extra ? `<div style="margin-top:0.25rem;font-size:0.8rem;color:var(--color-text-muted);">${extra}</div>` : ''}
                                    ${note}
                                    <div style="margin-top:0.5rem;">
                                        <button class="mini-btn" onclick="deleteBFEntry('${e.date}')">Apagar</button>
                                    </div>
                                </div>
                            </div>`;
                    }).join('');
                }
            }

            if (cur) {
                const set = (id, v) => { const el = document.getElementById(id); if (el && (el.value === '' || el.value === null)) el.value = v ?? ''; };
                set('bfSex', cur.sex || 'male');
                set('bfHeight', cur.heightCm || '');
                set('bfNeck', cur.neckCm || '');
                set('bfWaist', cur.waistCm || '');
                if (cur.sex === 'female') set('bfHip', cur.hipCm || '');
                set('bfWeight', cur.weightKg || '');
            }

            renderPhysiqueGallery();
            populateCompareSelects();
        }

        const physiqueDB = { name: 'fitness_app_db', store: 'physique_photos', version: 1 };

        function openPhysiqueDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(physiqueDB.name, physiqueDB.version);
                req.onupgradeneeded = () => {
                    const db = req.result;
                    if (!db.objectStoreNames.contains(physiqueDB.store)) db.createObjectStore(physiqueDB.store, { keyPath: 'id' });
                };
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }

        async function addPhysiquePhoto(dataUrl) {
            const db = await openPhysiqueDB();
            const tx = db.transaction(physiqueDB.store, 'readwrite');
            const store = tx.objectStore(physiqueDB.store);
            const id = `${Date.now()}-${Math.random().toString(16).slice(2)}`;
            store.put({ id, date: new Date().toISOString().slice(0,10), dataUrl });
            return new Promise((resolve, reject) => { tx.oncomplete = () => resolve(true); tx.onerror = () => reject(tx.error); });
        }

        async function getAllPhysiquePhotos() {
            const db = await openPhysiqueDB();
            const tx = db.transaction(physiqueDB.store, 'readonly');
            const req = tx.objectStore(physiqueDB.store).getAll();
            return new Promise((resolve, reject) => { req.onsuccess = () => resolve(req.result || []); req.onerror = () => reject(req.error); });
        }

        async function deletePhysiquePhoto(id) {
            const db = await openPhysiqueDB();
            const tx = db.transaction(physiqueDB.store, 'readwrite');
            tx.objectStore(physiqueDB.store).delete(id);
            return new Promise((resolve, reject) => { tx.oncomplete = () => resolve(true); tx.onerror = () => reject(tx.error); });
        }

        async function clearPhysiquePhotos() {
            const db = await openPhysiqueDB();
            const tx = db.transaction(physiqueDB.store, 'readwrite');
            tx.objectStore(physiqueDB.store).clear();
            return new Promise((resolve, reject) => { tx.oncomplete = () => resolve(true); tx.onerror = () => reject(tx.error); });
        }

        async function handlePhysiquePhoto(event) {
            const file = event.target.files?.[0];
            if (!file) return;
            const st = document.getElementById('photoStatus');
            if (st) st.textContent = 'Salvando foto...';
            const reader = new FileReader();
            reader.onload = async () => {
                try {
                    await addPhysiquePhoto(reader.result);
                    if (st) st.textContent = 'Foto salva ‚úÖ';
                    await renderPhysiqueGallery();
            populateCompareSelects();
                } catch (e) {
                    console.error(e);
                    if (st) st.textContent = 'Erro ao salvar foto.';
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsDataURL(file);
        }

        async function clearAllPhysiquePhotos() {
            if (!confirm('Apagar todas as fotos salvas neste dispositivo?')) return;
            const st = document.getElementById('photoStatus');
            if (st) st.textContent = 'Limpando...';
            try {
                await clearPhysiquePhotos();
                if (st) st.textContent = 'Fotos removidas ‚úÖ';
                await renderPhysiqueGallery();
            populateCompareSelects();
            } catch (e) {
                console.error(e);
                if (st) st.textContent = 'Erro ao limpar.';
            }
        }

        async function renderPhysiqueGallery() {
            const grid = document.getElementById('physiqueGallery');
            if (!grid) return;
            try {
                const photos = await getAllPhysiquePhotos();
                photos.sort((a,b) => parseInt(b.id.split('-')[0]) - parseInt(a.id.split('-')[0]));
                if (!photos.length) { grid.innerHTML = '<div class="empty-state">Nenhuma foto salva ainda.</div>'; return; }
                grid.innerHTML = photos.map(p => `
                    <div class="photo-card">
                        <img src="${p.dataUrl}" alt="Foto do f√≠sico">
                        <div class="meta">${new Date(p.date).toLocaleDateString('pt-BR')}</div>
                        <div class="actions">
                            <button class="mini-btn" onclick="deletePhysiquePhoto('${p.id}').then(renderPhysiqueGallery)">Apagar</button>
                            <a class="mini-btn" href="${p.dataUrl}" download="fisico-${p.date}.jpg" style="text-decoration:none;display:inline-block;">Baixar</a>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error(e);
                grid.innerHTML = '<div class="empty-state">Erro ao carregar fotos.</div>';
            }
        }
        // ==========================================================



// ===== Build reset (evita rotina/dieta fantasma de vers√µes antigas) =====
const APP_BUILD_ID = 'BATMAN-STABLE-2026-02-15';
function migrateStorageOnce() {
    const last = localStorage.getItem('appBuildId') || '';
    if (last !== APP_BUILD_ID) {
        localStorage.removeItem('customRoutineText');
        localStorage.removeItem('customDietText');
        localStorage.setItem('appBuildId', APP_BUILD_ID);
    }
}

// ===== Streak semanal (>=80% de ader√™ncia) =====
function calculateStreak80() {
    const routineDays = getRoutineDaysList();
    if (!routineDays.length) return 0;

    const weeks = {};
    (data.workouts || []).forEach(w => {
        const d = new Date(w.date);
        const year = d.getFullYear();
        const week = Math.floor((d - new Date(year,0,1)) / (7*24*60*60*1000));
        const key = `${year}-${week}`;
        weeks[key] = weeks[key] || new Set();
        weeks[key].add(workoutDayFromDateStr(w.date));
    });

    const keys = Object.keys(weeks).sort().reverse();
    let streak = 0;
    for (const k of keys) {
        const adherence = weeks[k].size / routineDays.length;
        if (adherence >= 0.8) streak++;
        else break;
    }
    return streak;
}

// ===== Compare fotos lado a lado =====
async function populateCompareSelects() {
    const selA = document.getElementById('compareA');
    const selB = document.getElementById('compareB');
    if (!selA || !selB) return;

    const photos = await getAllPhysiquePhotos();
    photos.sort((a,b) => parseInt(b.id.split('-')[0]) - parseInt(a.id.split('-')[0]));

    selA.innerHTML = '';
    selB.innerHTML = '';
    photos.forEach(p => {
        const label = new Date(p.date).toLocaleDateString('pt-BR');
        const oa = document.createElement('option');
        oa.value = p.id;
        oa.textContent = label;
        selA.appendChild(oa);

        const ob = document.createElement('option');
        ob.value = p.id;
        ob.textContent = label;
        selB.appendChild(ob);
    });
}

async function comparePhotos() {
    const aId = document.getElementById('compareA')?.value;
    const bId = document.getElementById('compareB')?.value;
    const out = document.getElementById('compareResult');
    if (!aId || !bId || !out) return;

    const photos = await getAllPhysiquePhotos();
    const a = photos.find(p => p.id === aId);
    const b = photos.find(p => p.id === bId);
    if (!a || !b) return;

    out.innerHTML = `
        <div style="flex:1;min-width:200px;">
            <div style="margin-bottom:0.5rem;">Antes</div>
            <img src="${a.dataUrl}" style="width:100%;border-radius:8px;">
        </div>
        <div style="flex:1;min-width:200px;">
            <div style="margin-bottom:0.5rem;">Depois</div>
            <img src="${b.dataUrl}" style="width:100%;border-radius:8px;">
        </div>
    `;
}

// ===== Limpar rotina/dieta =====
function clearRoutine() {
    if (!confirm('Limpar a rotina salva neste dispositivo?')) return;
    localStorage.removeItem('customRoutineText');
    const ta = document.getElementById('customRoutine');
    if (ta) ta.value = '';
    updateRoutinePreview();
    populateLogDaySelect();
    initializeExercises();
    updateDiaryReferences();
    alert('Rotina limpa ‚úÖ');
}

function clearDiet() {
    if (!confirm('Limpar a dieta/metas salvas neste dispositivo?')) return;
    localStorage.removeItem('customDietText');
    const ta = document.getElementById('customDiet');
    if (ta) ta.value = '';
    if (typeof data !== 'undefined') {
        data.macros = { calories: 0, protein: 0, carb: 0, fat: 0 };
        saveData();
    }
    updateDiaryReferences();
    alert('Dieta limpa ‚úÖ');
}

</script>
</body>
</html>