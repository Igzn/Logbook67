<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>LOGBOOK V2 - Hevy Mode</title>
<style>
:root{
--bg:#050509;--card:#0d0d14;--red:#ff1a1a;--red2:#b30000;
--text:#f5f5f7;--muted:#9a9aa3;--line:rgba(255,255,255,.08)
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui;
background:var(--bg);color:var(--text)}
header{padding:16px;border-bottom:1px solid var(--line)}
h1{font-size:16px}
main{padding:16px;padding-bottom:100px;max-width:900px;margin:auto}
.screen{display:none}
.screen.active{display:block}
.card{background:var(--card);padding:16px;border-radius:16px;
margin-bottom:14px;border:1px solid var(--line)}
.btn{padding:10px 14px;border:none;border-radius:12px;
font-weight:700;cursor:pointer}
.btn-primary{background:var(--red);color:#000}
.btn-ghost{background:transparent;color:var(--red);
border:1px solid var(--red)}
.field{width:100%;padding:10px;border-radius:12px;
background:#111;border:1px solid var(--line);color:#fff;margin-top:6px}
.nav{position:fixed;bottom:0;left:0;right:0;
display:flex;background:#0b0b12;border-top:1px solid var(--line)}
.tab{flex:1;padding:14px;text-align:center;color:var(--muted);
font-weight:700;cursor:pointer}
.tab.active{color:#000;background:var(--red)}
.set-row{display:grid;grid-template-columns:1fr 1fr 1fr auto;
gap:6px;margin-top:6px}
.toast{position:fixed;bottom:80px;left:50%;
transform:translateX(-50%);background:var(--red);
color:#000;padding:10px 16px;border-radius:12px;
display:none;font-weight:700}
small{color:var(--muted)}
.kpi{font-size:18px;font-weight:800}
</style>
</head>
<body>

<header>
<h1>LOGBOOK V2 • Hevy Mode</h1>
</header>

<main>

<!-- DASHBOARD -->
<section id="screen-dashboard" class="screen active">
<div class="card">
<div class="kpi">Sessões: <span id="kpiSessions">0</span></div>
<div class="kpi">Volume semana: <span id="kpiVolume">0</span></div>
</div>
</section>

<!-- LOGBOOK -->
<section id="screen-logbook" class="screen">
<div class="card">
<h2>Treino de hoje</h2>
<small id="todayLabel"></small>
<div id="todayExercises" style="margin-top:12px"></div>
<textarea id="sessionNotes" class="field" placeholder="Observações"></textarea>
<button class="btn btn-primary" id="btnSaveSession" style="margin-top:10px">Salvar sessão</button>
</div>
</section>

<!-- ROTINA -->
<section id="screen-rotina" class="screen">
<div class="card">
<h2>Rotina</h2>
<textarea id="routineTextarea" class="field" rows="10"
placeholder="Segunda
Supino 3x8-10
Agachamento 3x6-8"></textarea>
<button class="btn btn-primary" id="btnSaveRoutine" style="margin-top:10px">Salvar rotina</button>
<pre id="routinePreview" style="margin-top:10px"></pre>
</div>
</section>

</main>

<nav class="nav">
<div class="tab active" data-target="dashboard">Dashboard</div>
<div class="tab" data-target="logbook">Logbook</div>
<div class="tab" data-target="rotina">Rotina</div>
</nav>

<div class="toast" id="toast"></div>

<script>
"use strict";

/* ================= STATE ================= */

const KEY="LOGBOOK_V2";
let state={version:2,routineText:"",routineParsed:{},sessions:[]};

function save(){localStorage.setItem(KEY,JSON.stringify(state))}
function load(){
const s=localStorage.getItem(KEY);
if(s)state=JSON.parse(s);
}

/* ================= UTIL ================= */

function toast(msg){
const t=document.getElementById("toast");
t.innerText=msg;t.style.display="block";
setTimeout(()=>t.style.display="none",2000);
}
function iso(){return new Date().toISOString().slice(0,10)}
function weekId(d){
d=new Date(d);
const first=new Date(d.getFullYear(),0,1);
const days=Math.floor((d-first)/86400000);
return Math.ceil((days+first.getDay()+1)/7);
}
function todayKey(){
return ["Domingo","Segunda","Terça","Quarta","Quinta","Sexta","Sábado"][new Date().getDay()];
}

/* ================= PARSER ================= */

function parseRoutine(text){
const lines=text.split(/\n/).map(l=>l.trim()).filter(Boolean);
const days=["Segunda","Terça","Quarta","Quinta","Sexta","Sábado","Domingo"];
let cur=null,out={};
for(const l of lines){
if(days.includes(l)){cur=l;out[cur]=[];continue}
if(!cur)continue;
const m=l.match(/(.+?)\s+(\d+)x(\d+)-(\d+)/i);
if(!m)continue;
out[cur].push({
name:m[1],
blocks:[{nSets:+m[2],repMin:+m[3],repMax:+m[4]}]
});
}
return out;
}

/* ================= HEVY MODE ================= */

function findLastSessionExercise(name){
const sorted=[...state.sessions].sort((a,b)=>new Date(b.date)-new Date(a.date));
for(const s of sorted){
const ex=s.exercises.find(e=>e.name===name);
if(ex)return ex;
}
return null;
}

function buildExercise(ex){
const card=document.createElement("div");
card.className="card";
card.innerHTML=`<b>${ex.name}</b><div class="sets"></div>`;
const setsHost=card.querySelector(".sets");

const last=findLastSessionExercise(ex.name);

const totalSets=ex.blocks.reduce((a,b)=>a+b.nSets,0);

for(let i=0;i<totalSets;i++){
const row=document.createElement("div");
row.className="set-row";
row.innerHTML=`
<input type="number" class="field" placeholder="kg">
<input type="number" class="field" placeholder="reps">
<input type="number" class="field" placeholder="RIR">
<button class="btn btn-ghost">X</button>`;
row.querySelector("button").onclick=()=>row.remove();

if(last && last.sets[i]){
row.children[0].value=last.sets[i].kg||"";
row.children[1].value=last.sets[i].reps||"";
row.children[2].value=last.sets[i].rir||"";
}

setsHost.appendChild(row);
}

return card;
}

function renderLogbook(){
document.getElementById("todayLabel").innerText=todayKey()+" • "+iso();
const host=document.getElementById("todayExercises");
host.innerHTML="";
const day=todayKey();
const exs=state.routineParsed[day]||[];
if(!exs.length){host.innerHTML="<small>Sem treino hoje</small>";return;}
exs.forEach(ex=>host.appendChild(buildExercise(ex)));
}

/* ================= SAVE SESSION ================= */

function saveSession(){
const cards=document.querySelectorAll("#todayExercises .card");
if(!cards.length){toast("Sem exercícios");return}
const exercises=[];
cards.forEach(card=>{
const name=card.querySelector("b").innerText;
const sets=[];
card.querySelectorAll(".set-row").forEach(row=>{
sets.push({
kg:+row.children[0].value||0,
reps:+row.children[1].value||0,
rir:+row.children[2].value||null
});
});
exercises.push({name,sets});
});
state.sessions.push({
date:new Date().toISOString(),
weekday:todayKey(),
exercises
});
save();
updateDashboard();
toast("Sessão salva");
}

/* ================= PR SYSTEM ================= */

function getWeeklyPR(){
const w=weekId(new Date());
const lastW=w-1;
let prs={};
state.sessions.forEach(s=>{
const sw=weekId(s.date);
s.exercises.forEach(ex=>{
ex.sets.forEach(set=>{
if(set.kg>0){
if(!prs[ex.name])prs[ex.name]={};
if(!prs[ex.name][sw])prs[ex.name][sw]=0;
prs[ex.name][sw]=Math.max(prs[ex.name][sw],set.kg);
}
});
});
});
return prs;
}

/* ================= DASHBOARD ================= */

function updateDashboard(){
document.getElementById("kpiSessions").innerText=state.sessions.length;
let vol=0;
const w=weekId(new Date());
state.sessions.forEach(s=>{
if(weekId(s.date)===w){
s.exercises.forEach(ex=>{
ex.sets.forEach(set=>{
vol+=set.kg*set.reps;
});
});
}
});
document.getElementById("kpiVolume").innerText=Math.round(vol);
}

/* ================= NAV ================= */

document.querySelectorAll(".tab").forEach(tab=>{
tab.onclick=()=>{
document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
tab.classList.add("active");
document.getElementById("screen-"+tab.dataset.target).classList.add("active");
if(tab.dataset.target==="logbook")renderLogbook();
if(tab.dataset.target==="dashboard")updateDashboard();
};
});

/* ================= ROUTINE SAVE ================= */

document.getElementById("btnSaveRoutine").onclick=()=>{
const text=document.getElementById("routineTextarea").value;
state.routineText=text;
state.routineParsed=parseRoutine(text);
save();
document.getElementById("routinePreview").innerText=
JSON.stringify(state.routineParsed,null,2);
toast("Rotina salva");
};

/* ================= INIT ================= */

document.getElementById("btnSaveSession").onclick=saveSession;

load();
updateDashboard();

</script>
</body>
</html>
